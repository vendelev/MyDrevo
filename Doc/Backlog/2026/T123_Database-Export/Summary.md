# Эпик T123: Экспорт данных из базы данных

## 1. Название эпика и его краткое описание

Требуется создать возможность экспорта данных из базы данных в виде файла, чтобы пользователь мог получить выгрузку своих данных для резервного копирования, переноса в другие системы или анализа.

## 2. Бизнес-цель и ценность

**Проблема:** пользователи не имеют способа безопасно и удобно получить выгрузку своих данных из системы. Это осложняет резервное копирование, перенос между средами, поддержку и повышает риск потери данных.

**Ценность для бизнеса и пользователей:**

- Повышаем доверие пользователей: данные «принадлежат пользователю», он может их забрать.
- Снижаем нагрузку на поддержку (меньше ручных выгрузок/запросов к разработчикам).
- Упрощаем миграции и отладку (выгрузка для воспроизведения проблем).
- Закладываем основу для будущих интеграций (обмен данными между сервисами/клиентами).

## 3. Основные заинтересованные стороны

- **Зарегистрированные пользователи** — основной потребитель экспорта своих данных.
- **Администратор/владелец продукта** — контроль доступа, юридические требования, политика хранения.
- **Служба поддержки/QA** — получение выгрузок для диагностики проблем (строго в рамках прав доступа).

## 4. Функциональные требования

1. Пользователь может инициировать экспорт своих данных из системы.
2. Пользователь может скачать результат экспорта в виде файла.
3. Экспорт формируется в поддерживаемом формате (на старте — один формат; расширение — отдельным этапом).
4. Пользователь может видеть статус экспорта (например: «в процессе», «готово», «ошибка») и повторно скачать готовый файл, пока он доступен.
5. Экспорт ограничен **данными, доступными пользователю** (исключить выгрузку чужих данных).
6. Система должна корректно обрабатывать «большие» выгрузки (не должна «падать» при росте объёма данных).
7. Система должна фиксировать факт выгрузки (кто, когда, какой экспорт запустил/скачал).

## 5. Нефункциональные требования

- **Безопасность и приватность:**
  - Экспорт содержит только данные пользователя.
  - Ссылка/доступ к файлу экспорта защищены авторизацией.
  - Файл экспорта имеет ограниченный срок жизни (истечение/удаление по политике).
- **Производительность и масштабируемость:**
  - Формирование выгрузки не должно существенно ухудшать работу системы для остальных пользователей.
  - Для больших выгрузок поддерживается асинхронное формирование.
- **Надёжность:**
  - При ошибке пользователь получает понятный статус и может повторить экспорт.
- **Usability:**
  - Процесс экспорта должен быть понятен нетехническому пользователю: где запустить, где скачать, что содержит файл.

## 6. Модель предметной области

Основные сущности (Entity) и объекты значения (ValueObject), участвующие в экспорте данных:

- **Entity:**
  - **User**: представляет пользователя системы, содержит идентификатор, email, имя и другие профильные данные.
  - **FamilyMember**: представляет члена семьи в генеалогическом древе, включает профильные данные, даты жизни, связи.
  - **Relation**: представляет отношения между членами семьи (родитель-ребенок, супруги и т.д.).
  - **ExportRequest**: представляет запрос на экспорт, включает статус, время создания, ссылку на файл.

- **ValueObject:**
  - **ExportFormat**: определяет формат экспорта (например, JSON).
  - **ExportStatus**: статус экспорта (в процессе, готово, ошибка).
  - **MediaMetadata**: метаданные медиа-файлов (имя, тип, дата загрузки), без бинарных данных.

## 7. Критерии успеха

- Пользователь способен самостоятельно получить выгрузку своих данных без участия поддержки.
- Время ожидания для малого объёма данных — приемлемое (ориентир: секунды), для большого — пользователь видит прогресс/статус.
- Количество обращений в поддержку по теме «выгрузка данных» снижается.
- Нет инцидентов утечки данных через экспорт.

## 7.1. Критерии приемки

1. Система позволяет авторизованному пользователю инициировать экспорт данных.
2. Экспортируемые данные соответствуют требованиям безопасности и приватности.
3. Формат экспорта поддерживается согласно этапам (JSON для MVP).
4. Система корректно обрабатывает edge-кейсы: пустые данные, большие объемы, ошибки доступа к БД.
5. Пользователь получает понятные сообщения об ошибках и статусах.

## 8. Риски

- **Риск утечки данных** при ошибках в разграничении доступа.
- **Объём данных** может быть значительным → риск долгого времени формирования и нагрузки на систему.
- **Согласование состава данных** (что включать/не включать) может требовать уточнений с продуктом и юридическими требованиями.
- **Изменения схемы БД** со временем могут влиять на совместимость экспорта.
- **Риски реализации:** ошибки в коде экспорта могут привести к некорректным данным или сбоям; необходимость тестирования на больших объемах данных; интеграция с файловым хранилищем.

## 9. Не входит в реализацию

В рамках текущего эпика не будет реализовано:

- Экспорт в форматах, отличных от JSON (расширение в этапе 3).
- Экспорт бинарных медиа-файлов (только метаданные).
- Интеграция с внешними сервисами для экспорта.
- Автоматическое планирование экспортов.
- Импорт данных обратно в систему.

## 10. Зависимости

- Наличие механизма аутентификации и понятных прав доступа (минимум — экспорт только для авторизованного пользователя).
- Возможность безопасно хранить временные файлы экспорта (локальное хранилище/объектное хранилище) и ограничивать доступ.
- Очереди/фоновые задачи (если потребуется асинхронная генерация).

## 11. Сценарии использования

Общие сценарии использования для эпика (детализированы в этапах):

1. **Успешный экспорт данных**: Пользователь инициирует экспорт, система формирует файл и предоставляет для скачивания.
2. **Экспорт с большими данными**: Пользователь запрашивает экспорт большого объема, система обрабатывает асинхронно и уведомляет о готовности.
3. **Обработка пустых данных**: Если у пользователя нет данных для экспорта, система предоставляет пустой или минимальный файл с соответствующим сообщением.
4. **Ошибка доступа к БД**: При проблемах с базой данных система показывает понятное сообщение об ошибке и предлагает повторить.
5. **Повторный экспорт**: Пользователь может повторно скачать готовый файл экспорта в течение срока его доступности.

## 12. Этапы

1. [Stage1.md](Stage1.md) — MVP экспорта (инициация и скачивание, базовый формат)
2. [Stage2.md](Stage2.md) — Асинхронная генерация, статус, хранение и срок жизни файла
3. [Stage3.md](Stage3.md) — Расширение возможностей: форматы/состав данных/фильтры
4. [Stage4.md](Stage4.md) — Безопасность, журналирование, ограничения, критерии соответствия
