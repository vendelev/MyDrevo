# Этап 2. Асинхронная генерация, статус и управляемое хранение экспорта

## 1. Название этапа и его краткое описание

Экспорт становится «задачей»: пользователь запускает формирование, видит статус выполнения и скачивает файл после готовности. Система хранит результат ограниченное время и позволяет повторно скачать.

## 2. Цель этапа

Сделать экспорт надежным для больших объёмов данных и не блокировать пользовательский интерфейс ожиданием формирования файла.

## 3. Функциональные требования

1. Пользователь может запустить экспорт данных.
2. После запуска пользователь видит текущий статус: «в очереди/в процессе», «готово», «ошибка».
3. Пользователь может скачать готовый файл экспорта.
4. Пользователь может повторно скачать готовый файл, пока он доступен.
5. Пользователь может запустить новый экспорт (повторная выгрузка) после завершения предыдущего.
6. Система хранит файл экспорта ограниченное время (например, 24 часа) и затем удаляет.
7. При ошибке формируется понятный статус «ошибка» и сообщение для пользователя (без технических подробностей).

## 4. Нефункциональные требования

- **Производительность**: генерация выполняется асинхронно, не создавая заметных задержек в UI.
- **Надежность**: при перезапуске системы/воркера экспорт либо продолжает выполняться, либо корректно помечается ошибкой.
- **Безопасность**: файл доступен только владельцу; попытка доступа другим пользователем запрещена.
- **Управление хранением**: удаление по TTL не должно приводить к утечкам диска.

## 5. Сценарии использования

1. **Пользователь запускает экспорт и ждет готовности**
   - Пользователь нажимает «Экспортировать данные».
   - Система показывает «Экспорт в процессе».
   - Через некоторое время статус меняется на «Готово».
   - Пользователь нажимает «Скачать».

2. **Пользователь возвращается позже**
   - Пользователь заходит в раздел экспорта.
   - Видит «Готово» и кнопку «Скачать».

3. **Файл истёк**
   - Пользователь пытается скачать экспорт спустя срок хранения.
   - Система сообщает, что файл больше недоступен, и предлагает запустить экспорт заново.

4. **Ошибка генерации**
   - Экспорт завершается с ошибкой.
   - Пользователь видит статус «Ошибка» и может запустить повторный экспорт.

## 6. Критерии приемки

1. Экспорт запускается и выполняется асинхронно, интерфейс не «зависает».
2. Статус отображается и корректно меняется по мере выполнения.
3. Готовый файл скачивается только владельцем.
4. Повторное скачивание доступно до истечения срока хранения.
5. По истечении срока хранения файл удаляется и недоступен.
6. При ошибке пользователь видит статус и может повторить экспорт.

## 7. Зависимости

- Наличие механизма фоновых задач/очереди и мониторинга выполнения.
- Надёжное хранилище файлов (локальное/объектное) и политика удаления.

## 8. Оценка трудозатрат

10–16 часов
