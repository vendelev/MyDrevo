# TZ1 — Веб‑сайт семейного генеалогического древа

## 1. Название эпика и его краткое описание

**Эпик:** TZ1 — Веб‑сайт семейного генеалогического древа.

**Кратко:** создать веб‑сайт, на котором пользователь может просматривать и управлять семейным деревом. В проекте уже есть заготовка структуры базы данных, оставшаяся от прошлой разработки: [`backend/database/migrations/structure.sql`](../../../../backend/database/migrations/structure.sql).

## 2. Бизнес-цель и ценность

**Бизнес-цель:** получить работающий веб‑продукт для ведения семейного генеалогического древа, который можно демонстрировать стейкхолдерам поэтапно и развивать дальше.

**Ценность:**

- Пользователь получает единое место для хранения и визуализации информации о родственниках и связях.
- Проект получает понятный «скелет» продукта: от импорта существующей схемы данных до базовых пользовательских сценариев.
- Снижается риск «перепридумывания» модели данных: используем существующую структуру как отправную точку.

## 3. Основные заинтересованные стороны

- **Конечные пользователи:** люди, которые хотят вести семейное древо (частные лица).
- **Администратор/владелец дерева:** пользователь, который создает и редактирует данные.
- **Стейкхолдеры проекта (заказчик/куратор учебного проекта):** оценивают прогресс по промежуточным результатам.
- **Команда разработки:** backend (Laravel, CQRS), в перспективе frontend.

## 4. Функциональные требования

### 4.1. Базовые сценарии продукта

- Система должна позволять **просматривать** семейное древо (минимум: список персон и их связи; далее — визуализация).
- Система должна позволять **добавлять/редактировать** персону (ФИО, даты рождения/смерти, описание).
- Система должна позволять **создавать связи** между персонами (тип связи определяется справочником/типом).
- Система должна позволять **управлять доступом** к данным (минимум: авторизация и разграничение «свой/чужой» набор данных).

### 4.2. Требования, связанные с существующей БД

- Система должна **максимально использовать** существующую структуру данных из [`backend/database/migrations/structure.sql`](../../../../backend/database/migrations/structure.sql), так как там уже есть данные по семейному древу.
- Система должна обеспечить **сохранность существующих данных**: любые изменения схемы должны предусматривать миграцию без потерь.
- Система должна обеспечить **воспроизводимое развертывание** схемы БД в текущем стеке проекта (Laravel миграции + SQLite), даже если исходный файл содержит SQL под MySQL.
- Система должна поддерживать **многоязычность**: имена и фамилии хранятся в отдельных языковых таблицах (`gen_name_lang`, `gen_surname_lang`) с поддержкой разных языков.
- Система должна поддерживать **гендерные формы**: имена (MALE_SNAME/FEMALE_SNAME) и фамилии (MALE_SURNAME/FEMALE_SURNAME) имеют разные формы для мужчин и женщин.
- Система должна поддерживать **девичью фамилию**: персона может иметь как текущую фамилию (SURNAME_ID), так и девичью (BSURNAME_ID).
- Система должна иметь документированное соответствие: какие сущности/таблицы используются и как они отображаются на доменные понятия (персона, имя, фамилия, связь, пользователь).

## 5. Нефункциональные требования

- **Понятность для нетехнического пользователя:** интерфейс и тексты должны быть простыми.
- **Безопасность:**
  - доступ к данным только после авторизации;
  - пользователь не должен видеть/редактировать данные другого пользователя.
- **Надежность:** операции создания/редактирования должны быть атомарными.
- **Производительность (MVP):**
  - загрузка списка персон и связей для одного дерева должна быть приемлемой для сотен записей;
  - API должно отвечать стабильно в рамках локального/учебного окружения.
- **Поддерживаемость:** следовать принятой архитектуре (Clean Architecture + CQRS) и стилю проекта.
- **Контейнеризация:** запуск через Docker/Makefile без ручной настройки окружения.

## 6. Критерии успеха

- Можно развернуть проект и получить работающий сайт/страницы, демонстрирующие семейное древо.
- **Формат MVP:** допускаются оба варианта реализации пользовательского интерфейса:
  - Blade-страницы (Laravel web routes) как основной вариант;
  - либо API + простые страницы/клиент (если это ускоряет демонстрацию), при условии что пользовательские сценарии из требований выполняются.
- Есть минимальный набор пользовательских сценариев: вход, создание персоны, создание связи, просмотр результата.
- Схема БД воспроизводимо поднимается в текущем окружении проекта.
- Промежуточные результаты можно показывать стейкхолдерам после каждого этапа.

## 7. Риски и ограничения

- **Несовместимость SQL:** файл [`backend/database/migrations/structure.sql`](../../../../backend/database/migrations/structure.sql) содержит SQL под MySQL (например, `auto_increment`, `charset=utf8`, `row_format=COMPACT`), а проект использует SQLite. Потребуется адаптация/перенос в миграции с учетом различий между СУБД.
- **Риск потери существующих данных:** при миграции MySQL → SQLite необходимо обеспечить корректный перенос данных (типы данных, кодировки, значения по умолчанию).
- **Риск несовместимости новой логики со старыми данными:** если в существующих данных есть несоответствия схеме (например, NULL-значения там где не должно быть, или битые связи), новая логика может работать некорректно.
- **Сложность схемы многоязычности:** связь через промежуточные таблицы (`gen_mixed_name_lang`, `gen_mixed_surname_lang`) и необходимость поддержки гендерных форм усложняет логику работы с именами/фамилиями.
- **Неполнота схемы:** в файле отсутствует таблица типов связей (relationship_types), что критично для корректной работы `gen_relation`.
- **Отсутствие внешних ключей:** в схеме нет явных FOREIGN KEY constraints, что может приводить к «битым» связям и усложнять валидацию целостности данных.
- **Риски при конвертации типов данных:** MySQL `datetime` → SQLite `TEXT/INTEGER`, MySQL `int unsigned` → SQLite `INTEGER` могут требовать дополнительной логики валидации.
- **Ограничение учебного проекта:** приоритет — демонстрируемый результат с сохранением существующих данных, а не идеальная полнота функционала.

## 8. Зависимости

- Текущий стек проекта: Laravel 12 + Docker + SQLite (см. [`AGENTS.md`](../../../../AGENTS.md)).
- Архитектурные правила проекта (Clean Architecture/CQRS) и существующая структура модулей.
- Наличие/готовность UI (на первом этапе допускается минимальный web-интерфейс или API + простые страницы).

## 9. Маппинг сущностей/таблиц на доменные понятия

Существующая схема БД из [`backend/database/migrations/structure.sql`](../../../../backend/database/migrations/structure.sql) уже содержит данные семейного древа и использует сложную многоязычную модель с гендерными формами.

### 9.1. Основные таблицы

| Доменное понятие | Таблица(ы) | Описание |
|---|---|---|
| **Пользователь (владелец дерева)** | `gen_user` | Пользователь системы, который владеет набором данных генеалогического древа. Поля: ID, LOGIN, PASSWORD, FNAME, SNAME, SURNAME, EMAIL, CREATE_DATE, USER_TYPE, ACTIVE. |
| **Персона в дереве** | `gen_person` | Основная сущность человека в дереве. Связана с пользователем (USER_ID). Поля: ID, FNAME_ID (ссылка на имя), SNAME_ID (ссылка на отчество), SURNAME_ID (текущая фамилия), BSURNAME_ID (девичья фамилия), BDATE (дата рождения), DDATE (дата смерти), USER_ID. |
| **Связь между персонами** | `gen_relation` | Связь «кто кому» между двумя персонами. Поля: PID1 (первая персона), PID2 (вторая персона), RELATION_TYPE_ID (тип связи). |
| **Дополнительная информация о персоне** | `gen_person_info_lang` | Многоязычное описание персоны. Поля: PERSON_ID, INFO, LANG. |

### 9.2. Многоязычная модель имен

| Доменное понятие | Таблица(ы) | Описание |
|---|---|---|
| **Имя (основная запись)** | `gen_name` | Основная таблица имен, содержит связь с пользователем. Поля: ID, USER_ID. |
| **Имя (языковые варианты)** | `gen_name_lang` | Языковые варианты имен с гендерными формами отчеств. Поля: ID, MALE_ID (ссылка на мужскую форму имени), FNAME (само имя), MALE_SNAME (отчество для сына), FEMALE_SNAME (отчество для дочери), LANG (код языка). |
| **Связь имя-язык** | `gen_mixed_name_lang` | Связь между основной записью имени и языковыми вариантами. Поля: NAME_ID, NAME_LANG_ID. |

**Пример работы с именами:** Имя "Иван" (ID=1 в `gen_name`) может иметь варианты: русский "Иван" с отчествами "Иванович/Ивановна" (ID=1 в `gen_name_lang`), английский "John" с отчеством "John's" (ID=2 в `gen_name_lang`). Связь в `gen_mixed_name_lang`: (NAME_ID=1, NAME_LANG_ID=1) и (NAME_ID=1, NAME_LANG_ID=2).

### 9.3. Многоязычная модель фамилий

| Доменное понятие | Таблица(ы) | Описание |
|---|---|---|
| **Фамилия (основная запись)** | `gen_surname` | Основная таблица фамилий, содержит связь с пользователем. Поля: ID, USER_ID. |
| **Фамилия (языковые варианты)** | `gen_surname_lang` | Языковые варианты фамилий с гендерными формами. Поля: ID, MALE_SURNAME (мужская форма фамилии), FEMALE_SURNAME (женская форма фамилии), LANG (код языка). |
| **Связь фамилия-язык** | `gen_mixed_surname_lang` | Связь между основной записью фамилии и языковыми вариантами. Поля: SURNAME_ID, SURNAME_LANG_ID. |

**Пример работы с фамилиями:** Фамилия (ID=1 в `gen_surname`) может иметь варианты: русский "Петров/Петрова" (ID=1 в `gen_surname_lang`), английский "Petrov/Petrov" (ID=2 в `gen_surname_lang`).

### 9.4. Вспомогательные таблицы

| Таблица | Назначение | Комментарий |
|---|---|---|
| `gen_user_right` | Справочник прав пользователей | Поля: ID, NAME. **Требует заполнения.** |
| `gen_menu` | Структура меню системы | Поля: ID, NAME, PARENT_ID, LANG_ID, MENU_TYPE, METHOD, USER_TYPE. **Используется для навигации.** |
| `gen_menu_order` | Порядок пунктов меню | Поля: PARENT_ID, MENU_ID, POSITION. |
| `gen_message` | Сообщения/контент сайта | Поля: ID, TITLE, ANNOTATION, CREATE_DATE, USER_ID, LANG_ID, PUBLIC, USER_TYPE. |
| `gen_message_text` | Текст сообщений | Поля: MESSAGE_ID, MESSAGE. |
| `gen_mixed_menu_mess` | Связь меню и сообщений | Поля: MENU_ID, MESSAGE_ID. |

### 9.5. Отсутствующие таблицы

| Доменное понятие | Статус | Решение |
|---|---|---|
| **Типы связей (родитель/ребенок/супруг)** | **Отсутствует таблица справочника** | Необходимо создать таблицу `gen_relation_type` с полями ID, NAME, CODE для поддержки поля RELATION_TYPE_ID в `gen_relation`. |

### 9.6. Ключевые особенности схемы

1. **Многоязычность:** Имена и фамилии хранятся в отдельных языковых таблицах с кодом языка (ru, en и т.д.).
2. **Гендерные формы:** Отчества имеют мужскую/женскую форму (Иванович/Ивановна), фамилии также (Петров/Петрова).
3. **Девичья фамилия:** У персоны может быть как текущая (SURNAME_ID), так и девичья фамилия (BSURNAME_ID).
4. **Привязка к пользователю:** Персоны, имена и фамилии привязаны к пользователю через USER_ID, что обеспечивает разграничение доступа к данным разных семейных деревьев.
5. **Отсутствие внешних ключей:** В схеме нет явных FOREIGN KEY constraints, целостность данных должна контролироваться на уровне приложения.
6. **Промежуточные таблицы:** Связь имен/фамилий с языками реализована через промежуточные таблицы `gen_mixed_name_lang` и `gen_mixed_surname_lang`.

## 10. Этапы

Каждый этап должен завершаться артефактами следующих стадий процесса: спецификация, планы (сводный/разработка/тесты), реализация, тесты, документация.

Артефакты этапов хранятся в каталоге этапа: либо в соответствующих поддиректориях (например, `StageN/Spec`, `StageN/Plan`, `StageN/Implementation`, `StageN/Test`, `StageN/Doc`), либо в отдельных файлах с префиксом этапа (например, `StageN_*.md`).

### Приоритет: сохранение существующих данных

Все этапы разработки должны учитывать наличие существующих данных в БД и обеспечивать их сохранность.

- Этап 1: [`Stage1.md`](Stage1.md) — Миграция схемы БД MySQL → SQLite и проверка целостности данных.
- Этап 2: [`Stage2.md`](Stage2.md) — Адаптация доменной модели к существующей схеме и создание репозиториев.
- Этап 3: [`Stage3.md`](Stage3.md) — Просмотр дерева (MVP: список персон с многоязычными именами/фамилиями).
- Этап 4: [`Stage4.md`](Stage4.md) — Управление персонами (создание/редактирование с поддержкой языков и гендерных форм).
- Этап 5: [`Stage5.md`](Stage5.md) — Управление связями (создание/удаление/валидации).
- Этап 6: [`Stage6.md`](Stage6.md) — Минимальная визуализация дерева и улучшение UX.
- Этап 7: [`Stage7.md`](Stage7.md) — Безопасность, права доступа и готовность к демонстрации.
