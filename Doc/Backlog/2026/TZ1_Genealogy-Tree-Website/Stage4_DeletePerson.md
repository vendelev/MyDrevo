# Stage 3 — Управление персонами (удаление)

## 1. Название этапа и его краткое описание

**Этап 3 (удаление):** дать пользователю возможность удалять персону при соблюдении ограничений по связям.

Результат этапа должен быть демонстрируемым: пользователь может удалить персону без связей, а при наличии связей получает понятное сообщение.

## 2. Цель этапа

- Реализовать удаление персон.
- Обеспечить предсказуемое поведение при попытке удаления персоны со связями.

## 3. Функциональные требования

- Система должна позволять пользователю **удалять персону** только если у персоны нет связей.
- Если у персоны есть связи, система должна **блокировать удаление** и показывать понятное сообщение с причиной (например: «Нельзя удалить персону, пока существуют связи. Сначала удалите/измените связи.»).

## 4. Нефункциональные требования

- Все операции должны быть доступны только авторизованному пользователю.
- Изменения должны сохраняться надежно (без частичных записей).
- Формы должны быть простыми и понятными.
- Должно быть обеспечено **аудит/логирование изменений** по персонам.
  - Запись в таблицу `audit_logs`.
  - Поля записи: `user_id`, `action`, `timestamp`.
  - Для удаления персоны значение `action`: `person.deleted`.

## 5. Сценарии использования

1. **Позитивный сценарий: пользователь удаляет персону без связей**
   - Пользователь открывает карточку персоны без связей.
   - Нажимает «Удалить».
   - Система удаляет персону.
   - Система фиксирует событие в `audit_logs`.

2. **Негативный сценарий: пользователь пытается удалить персону со связями**
   - Пользователь открывает карточку персоны, у которой есть связи.
   - Нажимает «Удалить».
   - Система блокирует удаление.
   - Система показывает текст ошибки: «Нельзя удалить персону, пока существуют связи. Сначала удалите/измените связи.»

## 6. Критерии приемки

- Персону **можно удалить**, если у нее **нет связей**.
- Персону **нельзя удалить**, если у нее **есть связи** — операция отклоняется, пользователь видит текст ошибки: «Нельзя удалить персону, пока существуют связи. Сначала удалите/измените связи.»
- При успешном удалении создается запись в `audit_logs` с заполненными `user_id`, `action = person.deleted`, `timestamp`.

## 7. Зависимости

- Этап 2: есть просмотр списка персон и карточка персоны.

## 8. Оценка трудозатрат

- **Оценка:** 3–6 дней.
- **Основные факторы:** согласование обязательных полей, реализация валидаций, корректное удаление с учетом связей.
