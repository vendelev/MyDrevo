# Stage 3 — Управление персонами (редактирование)

> Источник истины по этапу: [`Stage3.md`](Doc/Backlog/2026/TZ1_Genealogy-Tree-Website/Stage3.md)

## 1. Название этапа и его краткое описание

**Этап 3 (редактирование):** дать пользователю возможность исправлять информацию о существующих.

Результат этапа должен быть демонстрируемым: пользователь может отредактировать персону.

## 2. Цель этапа

- Реализовать редактирование персон.
- Обеспечить базовую валидацию данных, чтобы не появлялись «пустые» или некорректные записи.

## 3. Функциональные требования

- Система должна позволять пользователю **редактировать персону**.
- При редактировании персоны пользователь должен иметь возможность указать минимум:
  - имя (обязательно, не пустое);
  - фамилию (обязательно, не пустая);
  - дату рождения (опционально);
  - дату смерти (опционально);
  - заметку/описание (опционально).
- Система должна предотвращать очевидные ошибки:
  - дата смерти не раньше даты рождения;
  - обязательные поля (имя и фамилия) не пустые.

### 3.1. Поведение при ошибках

- Если персона с указанным идентификатором не существует — вернуть **404 Not Found**.
- При конкурентном редактировании (данные были изменены кем-то другим между открытием формы и сохранением) — **не перетирать изменения**, показать пользователю сообщение о конфликте и предложить обновить данные.

## 4. Нефункциональные требования

- Все операции должны быть доступны только авторизованному пользователю.
- Изменения должны сохраняться надежно (без частичных записей).
- Формы должны быть простыми и понятными.
- Должно быть обеспечено **аудит/логирование изменений** по персонам.

### 4.1. Аудит изменений

- Все успешные операции редактирования должны логироваться в таблицу **`audit_logs`** со следующими полями:
  - **`user_id`** — кто выполнил изменение;
  - **`action`** — действие (например, `person.updated`);
  - **`timestamp`** — когда выполнено изменение.

## 5. Сценарии использования

1. **Пользователь исправляет данные**
   - Открывает карточку персоны.
   - Нажимает «Редактировать».
   - Меняет данные и сохраняет.
   - Видит обновленную информацию.

## 6. Критерии приемки

- Можно отредактировать персону через UI.
- Валидации работают и показывают понятные сообщения.
- При запросе редактирования несуществующей персоны система возвращает **404**.
- При конкурентном редактировании пользователь видит понятное сообщение о конфликте.
- Факт успешного редактирования фиксируется в **`audit_logs`** (`user_id`, `action`, `timestamp`).

## 7. Зависимости

- Этап 2: есть просмотр списка персон и карточка персоны.

## 8. Оценка трудозатрат

- **Оценка:** 3–6 дней.
- **Основные факторы:** согласование обязательных полей, реализация валидаций, корректное удаление с учетом связей.
