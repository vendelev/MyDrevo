# Stage 4 — Управление персонами (создание/редактирование с поддержкой многоязычности и гендерных форм)

## 1. Название этапа и его краткое описание

**Этап 4:** дать пользователю возможность создавать, редактировать и удалять персон с поддержкой многоязычных имен/фамилий и гендерных форм.

Результат этапа должен быть демонстрируемым: пользователь может добавить нового родственника, указав имя и фамилию на русском и английском языках, выбрать пол (для правильных гендерных форм), отредактировать существующую персону или удалить ее.

## 2. Цель этапа

- Реализовать создание персон с многоязычными именами/фамилиями.
- Реализовать редактирование персон с сохранением многоязычности.
- Реализовать удаление персон с проверкой зависимостей (связи с другими персонами).
- Обеспечить правильный выбор гендерных форм при создании/редактировании.
- Обеспечить базовую валидацию данных.
- Подготовить основу для управления связями (этап 5).

## 3. Функциональные требования

### 3.1. Создание персоны

Детали в файле: [`Stage4_CreatePerson.md`](Stage4_CreatePerson.md)

**Основные требования:**

- Форма создания персоны должна включать:
  - **Пол:** выбор из списка (Мужской/Женский/Неизвестно) — обязательное поле
  - **Имя (русский):** текстовое поле — обязательное
  - **Имя (английский):** текстовое поле — опциональное
  - **Отчество (русский, мужская форма):** автоматически генерируется из имени отца (если указан), или вводится вручную
  - **Отчество (русский, женская форма):** автоматически генерируется из имени отца (если указан), или вводится вручную
  - **Фамилия (русский, мужская форма):** текстовое поле — обязательное для мужчин
  - **Фамилия (русский, женская форма):** текстовое поле — обязательное для женщин
  - **Фамилия (английский):** текстовое поле — опциональное
  - **Девичья фамилия:** если выбран женский пол — опциональное поле (многоязычное)
  - **Дата рождения:** дата — опциональное
  - **Дата смерти:** дата — опциональное
  - **Дополнительная информация (русский):** текстовое поле — опциональное
  - **Дополнительная информация (английский):** текстовое поле — опциональное

- Система должна **автоматически генерировать отчества** из имени отца:
  - Если при создании персоны указана связь с отцом, система берет имя отца (ru) и генерирует:
    - Мужское отчество: имя отца + "ович" (Иван → Иванович)
    - Женское отчество: имя отца + "овна" (Иван → Ивановна)
  - Пользователь может переопределить автогенерированное отчество вручную

- Система должна **автоматически подставлять правильную гендерную форму**:
  - При выборе пола "Мужской" — показывать поле "Фамилия (мужская форма)"
  - При выборе пола "Женский" — показывать поля "Фамилия (женская форма)" и "Девичья фамилия"

- Валидации:
  - Имя (русский) не пустое
  - Фамилия (русский, соответствующая форма) не пустая
  - Дата смерти не раньше даты рождения
  - Если указана девичья фамилия — пол должен быть "Женский"

### 3.2. Редактирование персоны

Детали в файле: [`Stage4_EditPerson.md`](Stage4_EditPerson.md)

**Основные требования:**

- Форма редактирования персоны должна содержать все те же поля, что и форма создания.
- Система должна **загружать существующие данные** на всех языках:
  - Имя (ru, en)
  - Фамилия (ru мужская/женская, en)
  - Девичья фамилия (если есть)
  - Отчество (ru мужская/женская форма)
  - Дополнительная информация (ru, en)

- Пользователь может **обновить любое поле**, включая:
  - Изменить имя/фамилию на одном или нескольких языках
  - Изменить пол персоны (при этом могут измениться видимые гендерные формы)
  - Добавить или убрать девичью фамилию
  - Обновить даты рождения/смерти
  - Обновить дополнительную информацию

- При изменении пола система должна **корректно обработать гендерные формы**:
  - Если пол изменен с "Женский" на "Мужской" — девичья фамилия удаляется
  - Если пол изменен с "Мужской" на "Женский" — появляется возможность указать девичью фамилию

- Валидации те же, что при создании.

### 3.3. Удаление персоны

Детали в файле: [`Stage4_DeletePerson.md`](Stage4_DeletePerson.md)

**Основные требования:**

- Система должна позволять **удалить персону**.
- Перед удалением система должна **проверить зависимости**:
  - Если у персоны есть связи с другими персонами — показать предупреждение
  - Дать пользователю выбор:
    - Удалить персону и все ее связи
    - Отменить удаление

- При удалении персоны должны быть удалены:
  - Запись из `gen_person`
  - Все связи из `gen_relation` (где PID1 или PID2 = ID персоны)
  - Дополнительная информация из `gen_person_info_lang`

- Имена и фамилии (gen_name, gen_surname) **не удаляются**, так как могут использоваться другими персонами.

- Действие удаления должно **логироваться** в таблицу `audit_logs`.

### 3.4. Работа с многоязычными именами/фамилиями

- Система должна **автоматически создавать записи** в таблицах:
  - `gen_name` + `gen_name_lang` + `gen_mixed_name_lang` для новых имен
  - `gen_surname` + `gen_surname_lang` + `gen_mixed_surname_lang` для новых фамилий

- Если имя/фамилия уже существует в системе (проверка по тексту и USER_ID):
  - Система должна **переиспользовать существующую запись**
  - Если нет перевода на указанный язык — добавить новый перевод

- Пользователь должен видеть **подсказки** при вводе имени/фамилии:
  - Список уже существующих имен/фамилий пользователя (autocomplete)

## 4. Нефункциональные требования

- **Авторизация:** Все операции доступны только авторизованному пользователю (но авторизация вводится в Stage 7, пока используем тестового пользователя).
- **Целостность данных:** Изменения должны сохраняться транзакционно (без частичных записей).
- **Понятность форм:** Формы должны быть простыми и понятными нетехническому пользователю.
- **Аудит:** Все операции (создание, редактирование, удаление) должны логироваться в таблицу `audit_logs`.
- **Производительность:** Загрузка формы редактирования не должна быть медленной (использовать eager loading).

## 5. Сценарии использования

### 5.1. Пользователь создает новую персону

1. Открывает страницу `/persons`
2. Нажимает кнопку "Добавить родственника"
3. Переходит на `/persons/create?lang=ru`
4. Заполняет форму:
   - Пол: Мужской
   - Имя (русский): Алексей
   - Имя (английский): Alexey
   - Фамилия (мужская, русский): Сидоров
   - Фамилия (английский): Sidorov
   - Дата рождения: 1980-05-15
5. Нажимает "Сохранить"
6. Система создает:
   - Запись в `gen_name` с ID=10
   - Записи в `gen_name_lang`: ID=20 (ru, FNAME=Алексей), ID=21 (en, FNAME=Alexey)
   - Записи в `gen_mixed_name_lang`: (NAME_ID=10, NAME_LANG_ID=20), (NAME_ID=10, NAME_LANG_ID=21)
   - Запись в `gen_surname` с ID=15
   - Записи в `gen_surname_lang`: ID=30 (ru, MALE_SURNAME=Сидоров), ID=31 (en, MALE_SURNAME=Sidorov)
   - Записи в `gen_mixed_surname_lang`: (SURNAME_ID=15, SURNAME_LANG_ID=30), (SURNAME_ID=15, SURNAME_LANG_ID=31)
   - Запись в `gen_person`: FNAME_ID=10, SURNAME_ID=15, BDATE=1980-05-15, USER_ID=1
7. Перенаправляет на `/persons/42?lang=ru`
8. Пользователь видит карточку новой персоны

### 5.2. Пользователь редактирует существующую персону

1. Открывает карточку персоны `/persons/42?lang=ru`
2. Нажимает кнопку "Редактировать"
3. Переходит на `/persons/42/edit?lang=ru`
4. Видит заполненную форму с существующими данными
5. Изменяет дату рождения на 1980-06-20
6. Добавляет дополнительную информацию (русский): "Работает программистом"
7. Нажимает "Сохранить"
8. Система обновляет запись в `gen_person` и `gen_person_info_lang`
9. Перенаправляет на `/persons/42?lang=ru`
10. Пользователь видит обновленную карточку

### 5.3. Пользователь удаляет персону с предупреждением

1. Открывает карточку персоны `/persons/42?lang=ru`
2. Нажимает кнопку "Удалить"
3. Система проверяет связи: находит 2 связи (родитель и супруга)
4. Показывает модальное окно: "У этой персоны есть 2 связи с другими персонами. Удалить персону и все ее связи?"
5. Пользователь подтверждает
6. Система удаляет:
   - Запись из `gen_person`
   - 2 записи из `gen_relation`
   - Записи из `gen_person_info_lang`
7. Логирует действие в `audit_logs`
8. Перенаправляет на `/persons?lang=ru`
9. Пользователь видит список без удаленной персоны

## 6. Критерии приемки

### 6.1. Создание персоны

- ✅ Форма создания доступна по URL: `/persons/create?lang={lang}`
- ✅ Форма содержит все необходимые поля с поддержкой многоязычности
- ✅ Гендерные формы отображаются корректно в зависимости от выбранного пола
- ✅ Валидации работают и показывают понятные сообщения
- ✅ После успешного создания происходит перенаправление на `/persons/{id}?lang={lang}`
- ✅ Данные сохраняются во все нужные таблицы (gen_name, gen_name_lang, gen_mixed_name_lang, gen_surname, gen_surname_lang, gen_mixed_surname_lang, gen_person, gen_person_info_lang)
- ✅ Действие логируется в `audit_logs`

### 6.2. Редактирование персоны

- ✅ Форма редактирования доступна по URL: `/persons/{id}/edit?lang={lang}`
- ✅ Форма загружает существующие данные на всех языках
- ✅ Можно обновить любое поле, включая многоязычные
- ✅ Валидации работают
- ✅ После успешного сохранения происходит перенаправление на `/persons/{id}?lang={lang}`
- ✅ Изменения корректно сохраняются во все таблицы
- ✅ Действие логируется в `audit_logs`

### 6.3. Удаление персоны

- ✅ Кнопка удаления доступна на карточке персоны
- ✅ Перед удалением проверяются зависимости (связи)
- ✅ Если есть связи — показывается предупреждение с подтверждением
- ✅ При подтверждении удаляются персона, связи и дополнительная информация
- ✅ Имена/фамилии не удаляются (могут использоваться другими персонами)
- ✅ Действие логируется в `audit_logs`
- ✅ После удаления происходит перенаправление на `/persons?lang={lang}`

### 6.4. Многоязычность

- ✅ Можно создать персону с именами/фамилиями на нескольких языках
- ✅ Можно редактировать переводы имен/фамилий
- ✅ Система переиспользует существующие имена/фамилии вместо создания дубликатов
- ✅ Автоматический autocomplete при вводе имени/фамилии

### 6.5. Тесты

- ✅ Написаны E2E тесты для создания персоны с многоязычными данными
- ✅ Написаны E2E тесты для редактирования персоны
- ✅ Написаны E2E тесты для удаления персоны с проверкой зависимостей
- ✅ Написаны unit-тесты для валидаций
- ✅ Тесты проверяют корректность сохранения в многоязычную схему

## 7. Зависимости

- Этап 2: готовая доменная модель и репозитории.
- Этап 3: готовый интерфейс просмотра персон.

## 8. Риски этапа

- **Сложность многоязычной формы:** Форма с полями на разных языках может быть сложной для пользователя.
- **Дубликаты имен/фамилий:** Если проверка на существование имени/фамилии работает некорректно, могут появиться дубликаты.
- **Каскадное удаление:** При удалении персоны нужно корректно удалить все зависимые данные.
- **Производительность:** Загрузка формы с множеством связанных данных может быть медленной.

## 9. Подфайлы этапа

Детальные требования для подзадач этапа:

- [`Stage4_CreatePerson.md`](Stage4_CreatePerson.md) — создание персоны
- [`Stage4_EditPerson.md`](Stage4_EditPerson.md) — редактирование персоны
- [`Stage4_DeletePerson.md`](Stage4_DeletePerson.md) — удаление персоны

## 10. Оценка трудозатрат

- **Оценка:** 5–8 дней.
- **Основные факторы:**
  - Создание сложных форм с многоязычными полями
  - Реализация логики автогенерации отчеств
  - Реализация автокомплита для имен/фамилий
  - Реализация проверки дубликатов имен/фамилий
  - Реализация каскадного удаления с проверкой зависимостей
  - Реализация аудита изменений
  - Написание E2E и unit тестов для всех сценариев
