# Этап 4 — Управление связями (создание, удаление, проверки)

## 1. Название этапа и его краткое описание

**Этап 4:** дать пользователю возможность связывать родственников между собой и управлять этими связями.

Результат этапа должен быть демонстрируемым: пользователь создает связь, видит ее в карточках персон и может удалить.

## 2. Цель этапа

- Реализовать создание и удаление связей между персонами.
- Добавить проверки, чтобы связи были логичными и не приводили к ошибкам.

## 3. Функциональные требования

### 3.1. Минимальный список типов связей

Система должна поддерживать **минимальный** набор типов связей:

- **Родитель** (A — родитель B)
- **Ребенок** (A — ребенок B)
- **Супруг** (A — супруг B)

Правила направления/симметрии:

- Связь **«супруг» — симметричная**: если создана связь A—супруг—B, то B—супруг—A считается той же связью (и должна отображаться у обеих персон).
- Для связей **«родитель/ребенок»** направление важно.

### 3.1.1. Модель хранения связей

- Связь хранится как **одна запись** в таблице связей.
- Для типа **«супруг»** хранится **одна запись на пару** (без отдельной «обратной» записи).
- Уникальность связи фиксируется по тройке: **(person1_id, person2_id, type)**.
  - Для «супруг» при создании/поиске дубликатов система должна нормализовать пару (например, упорядочивать идентификаторы), чтобы A—супруг—B и B—супруг—A попадали в одну и ту же запись.

### 3.2. Создание/отображение/удаление связей

- Система должна позволять пользователю **создавать связь** между двумя персонами.
- При создании связи пользователь должен выбрать:
  - первую персону;
  - вторую персону;
  - тип связи.
- Система должна отображать связи:
  - в карточке каждой из персон;
  - в общем списке связей.
- Система должна позволять пользователю **удалять связь**.

### 3.3. Автоматическое создание обратной связи

- При создании связи **«родитель/ребенок»** система должна **автоматически создавать обратную связь**:
  - если создано A—родитель—B, то автоматически создается B—ребенок—A;
  - если создано A—ребенок—B, то автоматически создается B—родитель—A.
- Для связи **«супруг»** обратная связь не создается как отдельная запись, так как связь симметричная (см. п. 3.1).

### 3.4. Правила проверки и предотвращения противоречий

Система должна предотвращать некорректные связи и противоречия (минимум):

1. **Запрет связи «человек сам с собой»**
   - Нельзя создать связь, где A = B (для любого типа).

2. **Запрет дублирования**
   - Нельзя создать повтор той же связи.
   - Запрет должен быть формализован на уровне БД: **уникальный ключ** на **(person1_id, person2_id, type)**.
   - Для «супруг» дубликатом считается также обратная пара (A—супруг—B и B—супруг—A), поэтому перед сохранением должна применяться нормализация пары (см. п. 3.1.1).
   - Для «родитель/ребенок» дубликатом считается совпадение направления (A—родитель—B повторно).

3. **Запрет циклов родитель-ребенок между одной парой**
   - Нельзя, чтобы один и тот же человек был одновременно **родителем и ребенком** другого человека (в любой комбинации направлений).
   - Пример: если уже есть A—родитель—B, то нельзя создать A—ребенок—B и нельзя создать B—родитель—A.

4. **Проверка дат рождения (если даты известны)**
   - Если у родителя и ребенка указаны даты рождения, то дата рождения родителя должна быть **раньше** даты рождения ребенка.
   - Если у обоих родителей указаны даты рождения, то каждый из родителей должен быть старше ребенка.
   - Если хотя бы одна из дат неизвестна/не задана, проверка по датам **пропускается**.

Формат сообщений об ошибках для любых проверок связей: **`Неверная связь: [описание]`**.

## 4. Нефункциональные требования

- Операции доступны только авторизованному пользователю.
- Сообщения об ошибках должны быть понятными.
- На объеме до нескольких сотен персон создание связи должно выполняться без заметных задержек.

## 5. Сценарии использования

1. **Пользователь добавляет связь**
   - Открывает карточку персоны.
   - Нажимает «Добавить связь».
   - Выбирает вторую персону и тип связи.
   - Сохраняет и видит результат.

2. **Пользователь удаляет связь**
   - Открывает список связей или карточку персоны.
   - Нажимает «Удалить».
   - Связь исчезает из отображения.

3. **Пользователь пытается создать некорректную связь**
   - Выбирает одинаковую персону с обеих сторон.
   - Система показывает понятную ошибку.

## 6. Критерии приемки

- Можно создать связь через UI.
- Связь отображается в карточках персон и в списке связей.
- Можно удалить связь.
- Базовые проверки некорректных связей работают.
- Для «родитель/ребенок» обратная связь создается автоматически.

## 7. Зависимости

- Этап 3: есть управление персонами.

## 8. Оценка трудозатрат

- **Оценка:** 3–6 дней.
- **Основные факторы:** согласование типов связей, реализация проверок и удобного UI.
