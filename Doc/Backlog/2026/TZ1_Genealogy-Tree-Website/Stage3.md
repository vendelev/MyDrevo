# Stage 3 — Просмотр дерева (MVP: список персон с многоязычными именами/фамилиями)

## 1. Название этапа и его краткое описание

**Этап 3:** дать пользователю возможность увидеть данные своего дерева: список персон с многоязычными именами/фамилиями и их связи.

На этом этапе важен «первый полезный экран»: пользователь открывает сайт, выбирает язык интерфейса и видит, что данные о родственниках корректно отображаются с правильными гендерными формами имен и фамилий.

## 2. Цель этапа

- Реализовать просмотр персон и связей в рамках одного дерева пользователя с поддержкой многоязычности.
- Продемонстрировать работу многоязычной модели: имена и фамилии отображаются на выбранном языке.
- Продемонстрировать работу гендерных форм: фамилии и отчества отображаются в правильной форме.
- Подготовить основу для дальнейшего редактирования (этап 4) и управления связями (этап 5).

## 3. Функциональные требования

### 3.1. Авторизация и доступ

- **Авторизация** вводится в **Stage 7**. На этом этапе данные доступны без авторизации, но фильтруются по одному тестовому пользователю (первый пользователь из БД).
- Дерево пользователя включает **персоны** и **связи**, принадлежащие пользователю (данные фильтруются по `USER_ID`).

### 3.2. Многоязычность

- Система должна позволять **выбор языка интерфейса**: русский (ru) или английский (en).
- Выбор языка реализуется через:
  - GET-параметр `?lang=ru` или `?lang=en`
  - Cookie или сессия для запоминания выбора пользователя
- Имена персон отображаются на выбранном языке (если перевод отсутствует — на дефолтном ru).
- Фамилии персон отображаются в правильной гендерной форме (мужская/женская) на выбранном языке.

### 3.3. Формат UI и маршруты

- **Формат UI:** Blade-страницы (Laravel `web`), без SPA.
- Минимальные маршруты (MVP):
  - `GET /` — главная страница с выбором языка и ссылкой на список персон
  - `GET /persons?lang={lang}` — список персон с поддержкой языка
  - `GET /persons/{person}?lang={lang}` — карточка персоны с поддержкой языка
  - `GET /relations?lang={lang}` — список связей (опционально для демонстрации)

### 3.4. Страница списка персон

Система должна предоставлять страницу «Персоны», где отображается список персон пользователя.

**Обязательные поля в списке персон:**

- Полное имя (имя + отчество + фамилия) на выбранном языке с правильной гендерной формой
- Дата рождения (если известна)
- Дата смерти (если известна) — для пометки умерших

**Пример отображения (ru, мужчина):**

- Иван Петрович Сидоров, 1950-05-15
- Мария Ивановна Петрова (дев. Смирнова), 1955-03-20 — 2010-12-01

**Пример отображения (en, мужчина):**

- John Petrovich Sidorov, 1950-05-15
- Mary Ivanovna Petrova (nee Smirnova), 1955-03-20 — 2010-12-01

### 3.5. Карточка персоны

Система должна позволять открыть карточку персоны и увидеть:

**Основные данные:**

- Полное имя на выбранном языке с правильной гендерной формой
- Дата рождения
- Дата смерти (если есть)
- Девичья фамилия (если есть)
- Дополнительная информация на выбранном языке (из `gen_person_info_lang`)

**Список связанных персон, сгруппированный по типам связей:**

- **Родители** — список персон с типом связи PARENT_CHILD (где текущая персона — ребенок)
- **Дети** — список персон с типом связи PARENT_CHILD (где текущая персона — родитель)
- **Супруги** — список персон с типом связи SPOUSE

Для каждой связанной персоны отображаются:

- Полное имя с правильной гендерной формой
- Годы жизни (birth_date — death_date)

### 3.6. Отображение гендерных форм

Система должна корректно отображать гендерные формы:

- **Фамилия:** для женщин — женская форма (Петрова), для мужчин — мужская (Петров)
- **Отчество:** для дочерей — женская форма (Ивановна), для сыновей — мужская (Иванович)
- **Девичья фамилия:** отображается только для женщин в формате "(дев. Смирнова)" или "(nee Smirnova)"

## 4. Нефункциональные требования

- **Производительность:** Страницы должны открываться быстро на объеме до нескольких сотен персон (использовать eager loading для связей).
- **Понятность:** Тексты и названия разделов должны быть понятны нетехническому пользователю на обоих языках.
- **Корректность:** Все гендерные формы должны отображаться правильно, нет ошибок типа "Мария Иванович" или "Иван Петрова".
- **Fallback:** Если перевода имени/фамилии нет на выбранном языке — отображается дефолтный вариант (русский).

## 5. Сценарии использования

### 5.1. Пользователь просматривает дерево на русском языке

1. Открывает сайт: `http://localhost/`
2. Видит главную страницу с выбором языка.
3. Выбирает "Русский" — переходит на `/persons?lang=ru`
4. Видит список родственников с русскими именами и правильными гендерными формами:
   - "Иван Петрович Сидоров"
   - "Мария Ивановна Петрова (дев. Смирнова)"
5. Кликает на "Иван Петрович Сидоров" — переходит на `/persons/1?lang=ru`
6. Видит карточку персоны с детальной информацией:
   - Дата рождения: 1950-05-15
   - Родители: Петр Иванович Сидоров, Анна Сергеевна Сидорова
   - Дети: Алексей Иванович Сидоров, Елена Ивановна Петрова
   - Супруга: Мария Ивановна Сидорова (дев. Смирнова)

### 5.2. Пользователь переключается на английский язык

1. На странице `/persons?lang=ru` кликает на "English"
2. Переходит на `/persons?lang=en`
3. Видит тех же персон, но с английскими именами (если есть переводы):
   - "John Petrovich Sidorov"
   - "Mary Ivanovna Petrova (nee Smirnova)"

### 5.3. Стейкхолдер оценивает прогресс

1. Открывает сайт.
2. Видит работающий интерфейс с выбором языка.
3. Проверяет корректность отображения многоязычных данных.
4. Проверяет правильность гендерных форм.
5. Подтверждает, что данные существующего семейного древа отображаются корректно.

## 6. Критерии приемки

### 6.1. Основные страницы

- ✅ Есть главная страница с выбором языка.
- ✅ Есть страница со списком персон: `/persons?lang={lang}`
- ✅ Есть карточка персоны: `/persons/{person}?lang={lang}`
- ✅ Есть навигация между страницами (меню, ссылки, кнопка смены языка).

### 6.2. Многоязычность

- ✅ Можно переключить язык через GET-параметр `?lang=ru` или `?lang=en`
- ✅ Выбор языка сохраняется в cookie/сессии.
- ✅ Имена персон отображаются на выбранном языке.
- ✅ Если перевода нет — отображается дефолтный русский вариант.

### 6.3. Гендерные формы

- ✅ Фамилии отображаются в правильной гендерной форме (Петров/Петрова).
- ✅ Отчества отображаются в правильной гендерной форме (Иванович/Ивановна).
- ✅ Девичья фамилия отображается только для женщин в формате "(дев. ...)" или "(nee ...)".

### 6.4. Отображение связей

- ✅ На карточке персоны отображаются связанные персоны, сгруппированные по типам.
- ✅ Группы связей: Родители, Дети, Супруги.
- ✅ Для каждой связанной персоны отображается полное имя и годы жизни.

### 6.5. Тесты

- ✅ Написаны E2E тесты для просмотра списка персон на разных языках.
- ✅ Тесты проверяют корректность гендерных форм.
- ✅ Тесты проверяют отображение связей на карточке персоны.

### 6.6. Производительность

- ✅ Список из 100 персон загружается менее чем за 1 секунду.
- ✅ Карточка персоны со связями загружается менее чем за 0.5 секунд.
- ✅ Используется eager loading для предотвращения N+1 проблемы.

## 7. Зависимости

- Этап 1: готовая схема БД с мигрированными данными.
- Этап 2: готовая доменная модель и репозитории с поддержкой многоязычности.

## 8. Риски этапа

- **Отсутствие переводов:** Если в БД нет переводов на английский — нужен fallback на русский.
- **Ошибки в гендерных формах:** Если пол персоны не указан или указан неправильно — гендерная форма может быть неверной.
- **Производительность:** Отображение списка с eager loading связей может быть медленным на больших объемах.

## 9. Оценка трудозатрат

- **Оценка:** 3–5 дней.
- **Основные факторы:**
  - Создание Blade-шаблонов с поддержкой языков
  - Реализация контроллеров с использованием репозиториев из этапа 2
  - Реализация логики выбора языка (GET-параметр, cookie/сессия)
  - Реализация отображения гендерных форм
  - Реализация группировки связей по типам
  - Написание E2E тестов для проверки многоязычности и гендерных форм
