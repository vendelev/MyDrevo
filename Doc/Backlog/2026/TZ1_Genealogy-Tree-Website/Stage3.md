# Stage 3 — Создание, редактирование и удаление персон

Декомпозиция этапа:
- [Stage3_CreatePerson.md](Stage3_CreatePerson.md)
- [Stage3_EditPerson.md](Stage3_EditPerson.md)
- [Stage3_DeletePerson.md](Stage3_DeletePerson.md)

## 1. Название этапа и его краткое описание

**Этап 3:** дать пользователю возможность добавлять новых родственников, исправлять информацию о существующих и удалять персон (с учетом ограничений по связям).

Результат этапа должен быть демонстрируемым: пользователь может создать персону, увидеть ее в списке, отредактировать и удалить (если нет связей).

## 2. Цель этапа

- Реализовать создание, редактирование и удаление персон.
- Обеспечить базовую валидацию данных, чтобы не появлялись «пустые» или некорректные записи.

## 3. Функциональные требования

- Система должна позволять пользователю **создавать персону**.
- При создании персоны пользователь должен иметь возможность указать минимум:
  - имя (обязательно, не пустое);
  - фамилию (обязательно, не пустая);
  - дату рождения (опционально);
  - дату смерти (опционально);
  - заметку/описание (опционально).
- Система должна позволять пользователю **редактировать персону** (те же поля).
- Система должна предотвращать очевидные ошибки:
  - дата смерти не раньше даты рождения;
  - обязательные поля (имя и фамилия) не пустые.
- Система должна позволять пользователю **удалять персону** только если у персоны нет связей.
- Если у персоны есть связи, система должна **блокировать удаление** и показывать понятное сообщение с причиной (например: «Нельзя удалить персону, пока существуют связи. Сначала удалите/измените связи.»).

## 4. Нефункциональные требования

- Все операции должны быть доступны только авторизованному пользователю.
- Изменения должны сохраняться надежно (без частичных записей).
- Формы должны быть простыми и понятными.
- Должно быть обеспечено **аудит/логирование изменений** по персонам в таблицу `audit_logs` со следующими полями:
  - `user_id` — кто выполнил действие;
  - `action` — тип действия (например: `person.created`, `person.updated`, `person.deleted`);
  - `timestamp` — когда выполнено действие.

## 5. Сценарии использования

1. **Пользователь добавляет родственника**
   - Открывает раздел «Персоны».
   - Нажимает «Добавить».
   - Заполняет форму и сохраняет.
   - Видит нового человека в списке.

2. **Пользователь исправляет данные**
   - Открывает карточку персоны.
   - Нажимает «Редактировать».
   - Меняет данные и сохраняет.
   - Видит обновленную информацию.

3. **Пользователь пытается удалить персону со связями**
   - Нажимает «Удалить».
   - Система объясняет, почему удалить нельзя, и что нужно сделать.

## 6. Критерии приемки

- Можно создать персону через UI.
- Можно отредактировать персону через UI.
- Валидации работают и показывают понятные сообщения.
- Удаление персоны обрабатывает наличие связей предсказуемо и понятно.
- При создании/редактировании/удалении персоны создается запись в `audit_logs` с корректными `user_id`, `action`, `timestamp`.

## 7. Зависимости

- Этап 2: есть просмотр списка персон и карточка персоны.

## 8. Оценка трудозатрат

- **Оценка:** 3–6 дней.
- **Основные факторы:** согласование обязательных полей, реализация валидаций, корректное удаление с учетом связей.
