# Stage 6 — Безопасность, права доступа и готовность к демонстрации

## 1. Название этапа и его краткое описание

**Этап 6:** сделать продукт безопасным и готовым к показу: вход, разграничение данных, базовые настройки и «полировка».

Результат этапа должен быть демонстрируемым: пользователь входит в систему, видит только свои данные, а продукт выглядит целостно.

## 2. Цель этапа

- Реализовать базовую авторизацию и разграничение доступа к данным.
- Убедиться, что все ключевые сценарии работают «от начала до конца».
- Подготовить продукт к демонстрации стейкхолдерам.

## 3. Функциональные требования

- Идентификатором пользователя при входе должен быть **email** (email + пароль).
- Система должна предоставлять пользователю возможность **выйти**.
- Система должна гарантировать, что:
  - пользователь видит только свои персоны и связи;
  - пользователь не может получить доступ к данным другого пользователя через прямые ссылки.
- Для каждой операции должен выполняться контроль прав (authorization), включая:
  - просмотр списка персон;
  - просмотр карточки персоны;
  - CRUD персон;
  - CRUD связей;
  - просмотр дерева.
- Система должна иметь базовые страницы/сообщения:
  - «нет данных» (если дерево пустое);
  - «доступ запрещен» (если нет прав).
- Система должна иметь минимальные административные возможности для демонстрации:
  - создание тестового пользователя;
  - сброс/пересоздание тестовых данных.
- Сброс/пересоздание тестовых данных должно выполняться отдельной artisan-командой **reset-data**.
  - Критерии: команда удаляет/сбрасывает **все данные** и затем **создает тестового пользователя**.
- Определить Суперпользователя (роль **admin**):
  - назначение через `user.role = 'admin'`;
  - сценарии: просмотр всех данных **без фильтрации по `user_id`**.
- Зафиксировать web-интерфейс: использовать **Blade**; **CSRF** и **сессии** обязательны.

## 4. Нефункциональные требования

- Пароли должны храниться безопасно (хеширование).
- Должны быть базовые меры защиты от типовых ошибок (например, проверка прав на каждую операцию).
- Для web-интерфейса должны быть включены и использоваться:
  - сессии;
  - CSRF-защита.
- Пользовательские сообщения должны быть понятными.

## 5. Сценарии использования

1. **Пользователь входит и видит свое дерево**
   - Открывает сайт.
   - Вводит email и пароль.
   - Переходит к списку персон/дереву.

2. **Пользователь пытается открыть чужую персону**
   - Вставляет ссылку на чужую карточку.
   - Видит «доступ запрещен».

3. **Стейкхолдер смотрит целостный продукт**
   - Входит тестовым пользователем.
   - Просматривает дерево.
   - Добавляет персону и связь.
   - Видит визуализацию.

## 6. Критерии приемки

- Есть вход и выход (email как идентификатор).
- Web-интерфейс реализован на Blade; включены и используются сессии и CSRF-защита.
- Данные изолированы по пользователям; прямой доступ к чужим данным запрещен.
- Суперпользователь (роль `admin`) видит все данные без фильтрации по `user_id`.
- На каждую операцию просмотра/изменения есть проверка прав (список персон, карточка, CRUD персон, CRUD связей, дерево).
- Есть удобный способ подготовить тестовые данные для демонстрации: artisan-команда `reset-data`, которая сбрасывает все данные и создает тестового пользователя.

## 7. Зависимости

- Этапы 2–5: реализованы просмотр, управление персонами и связями, визуализация.

## 8. Оценка трудозатрат

- **Оценка:** 3–7 дней.
- **Основные факторы:** интеграция авторизации, корректное разграничение данных, подготовка демонстрационного сценария.
