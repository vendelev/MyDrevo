# Stage 1 — Миграция схемы БД MySQL → SQLite и проверка целостности данных

## 1. Название этапа и его краткое описание

**Этап 1:** перенести существующую схему БД из MySQL в SQLite с сохранением всех существующих данных семейного древа.

Результат этапа должен быть демонстрируемым: проект поднимается в Docker, база данных мигрирует без потерь, данные проверены на целостность, есть минимальная «заглушка» интерфейса для проверки.

## 2. Цель этапа

- **КРИТИЧНО:** Сохранить все существующие данные семейного древа при миграции MySQL → SQLite.
- Адаптировать схему из [`backend/database/migrations/structure.sql`](../../../../backend/database/migrations/structure.sql) под SQLite (синтаксис, типы данных, индексы).
- Проверить целостность перенесенных данных (отсутствие битых связей, NULL-значений где не должно быть).
- Создать Laravel-миграции для воспроизводимого развертывания схемы.
- Документировать структуру данных: какие таблицы используются, как связаны, какие поля критичны.
- Подготовить скрипт экспорта данных из MySQL и импорта в SQLite.

## 3. Функциональные требования

### 3.1. Адаптация схемы MySQL → SQLite

- Система должна иметь **Laravel-миграции** для всех таблиц из `structure.sql`:
  - Основные: `gen_user`, `gen_person`, `gen_relation`, `gen_name`, `gen_name_lang`, `gen_surname`, `gen_surname_lang`
  - Связующие: `gen_mixed_name_lang`, `gen_mixed_surname_lang`
  - Вспомогательные: `gen_person_info_lang`, `gen_user_right`, `gen_menu`, `gen_menu_order`, `gen_message`, `gen_message_text`, `gen_mixed_menu_mess`
- Миграции должны учитывать различия MySQL/SQLite:
  - `auto_increment` → `autoIncrement()` в Laravel
  - `int unsigned` → `unsignedInteger()`
  - `datetime` → `dateTime()` с nullable где нужно
  - `charset=utf8` → убрать (SQLite всегда UTF-8)
  - `row_format=COMPACT` → убрать
- Система должна создать **отсутствующую таблицу типов связей** `gen_relation_type` с полями: ID, NAME, CODE.
- Миграции должны создавать **индексы** на внешние ключи для производительности (PID1, PID2, USER_ID, FNAME_ID и т.д.).

### 3.2. Экспорт/импорт существующих данных

- Система должна иметь **команду экспорта данных из MySQL**:
  - Команда: `php artisan db:export-mysql --host=... --database=... --user=... --password=...`
  - Экспортирует данные всех таблиц в формат, совместимый с SQLite (JSON или SQL INSERT)
  - Сохраняет результат в файл `database/data/export_YYYY-MM-DD_HH-MM-SS.json` (или `.sql`)
- Система должна иметь **команду импорта данных в SQLite**:
  - Команда: `php artisan db:import --file=database/data/export_YYYY-MM-DD_HH-MM-SS.json`
  - Импортирует данные в текущую БД SQLite
  - Проверяет целостность перед импортом (таблицы существуют, структура совпадает)

### 3.3. Проверка целостности данных

- Система должна иметь **команду проверки целостности данных**:
  - Команда: `php artisan db:validate-integrity`
  - Проверяет:
    - Отсутствие битых связей (FNAME_ID, SNAME_ID, SURNAME_ID, BSURNAME_ID указывают на существующие записи)
    - Отсутствие битых связей в `gen_relation` (PID1, PID2 указывают на существующие персоны)
    - Корректность USER_ID (все персоны/имена/фамилии привязаны к существующим пользователям)
    - Корректность языковых связей (gen_mixed_name_lang, gen_mixed_surname_lang)
  - Выводит отчет с найденными проблемами
  - Возвращает код ошибки, если есть проблемы

### 3.4. Проверочный эндпоинт

- Система должна иметь **эндпоинт статуса БД**:
  - URL: `GET /api/status`
  - Формат ответа: JSON с полями `status`, `message`, `database`
  - Проверяет:
    - Подключение к БД (выполняет простой SELECT)
    - Наличие основных таблиц
    - Количество записей в основных таблицах
  - Коды ответов:
    - `200 OK` — БД доступна и работает
      ```json
      {
        "status": "ok",
        "message": "Database connection is healthy",
        "database": {
          "tables_exist": true,
          "users_count": 5,
          "persons_count": 42,
          "relations_count": 38
        }
      }
      ```
    - `500 Internal Server Error` — БД недоступна или ошибка
      ```json
      {
        "status": "error",
        "message": "Database connection failed: SQLSTATE[HY000] [14] unable to open database file"
      }
      ```

### 3.5. Документация структуры данных

- Система должна иметь **документ с описанием структуры данных**:
  - Файл: `Doc/Database/Schema.md`
  - Содержит:
    - Описание всех таблиц и их полей
    - ER-диаграмму связей (можно текстовую или ссылку на изображение)
    - Примеры запросов для получения данных
    - Описание многоязычной модели и гендерных форм
    - Описание связей персон

## 4. Нефункциональные требования

- **Сохранность данных:** ни одна запись из существующей БД не должна быть потеряна при миграции.
- **Воспроизводимость:** развертывание должно быть воспроизводимым через Docker/Makefile без ручных действий.
- **Целостность:** все связи между таблицами должны быть корректными после миграции.
- **Производительность:** команды экспорта/импорта должны работать с базой размером до 10000 записей персон за разумное время (до 5 минут).
- **Документированность:** каждая команда должна иметь справку (`--help`) и примеры использования.
- **Архитектура:** изменения должны соответствовать правилам проекта (Clean Architecture + CQRS).
- **Понятность:** документация должна быть понятна нетехническому пользователю.

## 5. Сценарии использования

### 5.1. Разработчик переносит существующую БД

1. Подключается к существующей MySQL БД с данными.
2. Выполняет команду экспорта: `make php-run CMD="php artisan db:export-mysql --host=localhost --database=genealogy --user=root --password=secret"`
3. Система создает файл `database/data/export_2026-01-21_15-30-45.json` с данными.
4. Выполняет команду импорта: `make php-run CMD="php artisan db:import --file=database/data/export_2026-01-21_15-30-45.json"`
5. Система импортирует данные в SQLite.
6. Выполняет проверку целостности: `make php-run CMD="php artisan db:validate-integrity"`
7. Получает отчет: "Проверено 42 персоны, 38 связей. Найдено 0 проблем."

### 5.2. Стейкхолдер запускает проект с мигрированными данными

1. Открывает инструкцию запуска в README.
2. Выполняет команду: `make install`
3. Система разворачивает Docker, применяет миграции.
4. Открывает в браузере `http://localhost/api/status`
5. Видит JSON с подтверждением работы БД и количеством записей.

### 5.3. Разработчик проверяет структуру БД

1. Запускает миграции: `make php-run CMD="php artisan migrate"`
2. Убеждается, что все таблицы из `structure.sql` созданы.
3. Открывает файл `Doc/Database/Schema.md`
4. Изучает структуру данных, примеры запросов, диаграмму связей.

### 5.4. Разработчик разворачивает проект в чистом окружении

1. Клонирует репозиторий.
2. Выполняет: `make install`
3. Система создает пустую БД со схемой.
4. Если есть файл экспорта данных, выполняет импорт.
5. Проверяет статус через `/api/status`.

## 6. Критерии приемки

### 6.1. Миграции и схема БД

- ✅ Все таблицы из `structure.sql` создаются через Laravel-миграции.
- ✅ Создана отсутствующая таблица `gen_relation_type` с базовыми типами связей (родитель-ребенок, супруги).
- ✅ Индексы созданы на всех внешних ключах.
- ✅ Синтаксис совместим с SQLite (нет MySQL-специфичных конструкций).
- ✅ Миграции выполняются без ошибок: `make php-run CMD="php artisan migrate"`

### 6.2. Экспорт и импорт данных

- ✅ Команда `php artisan db:export-mysql` экспортирует данные из MySQL в JSON/SQL файл.
- ✅ Команда `php artisan db:import` импортирует данные в SQLite.
- ✅ После импорта все данные сохранены (количество записей совпадает).
- ✅ Кодировка UTF-8 корректно обрабатывается (кириллица не ломается).

### 6.3. Проверка целостности

- ✅ Команда `php artisan db:validate-integrity` проверяет:
  - Битые связи в `gen_person` (FNAME_ID, SNAME_ID, SURNAME_ID, BSURNAME_ID)
  - Битые связи в `gen_relation` (PID1, PID2, RELATION_TYPE_ID)
  - Корректность USER_ID во всех таблицах
  - Корректность связей в `gen_mixed_name_lang` и `gen_mixed_surname_lang`
- ✅ Команда выводит детальный отчет с найденными проблемами.
- ✅ Команда возвращает ненулевой код ошибки, если есть проблемы.

### 6.4. API эндпоинт статуса

- ✅ Эндпоинт `GET /api/status` доступен.
- ✅ Возвращает JSON с полями: `status`, `message`, `database`.
- ✅ При успехе возвращает код 200 и количество записей в основных таблицах.
- ✅ При ошибке возвращает код 500 и описание проблемы.

### 6.5. Документация

- ✅ Создан файл `Doc/Database/Schema.md` с описанием структуры БД.
- ✅ Документ содержит описание всех таблиц и их полей.
- ✅ Документ содержит описание многоязычной модели и гендерных форм.
- ✅ Документ содержит примеры запросов для получения данных.
- ✅ Все команды имеют справку `--help` с примерами.

### 6.6. Воспроизводимость

- ✅ Проект разворачивается в чистом окружении через `make install`.
- ✅ После развертывания БД создана, схема применена.
- ✅ Если есть файл экспорта, данные импортируются автоматически.

## 7. Зависимости

- Нет (это стартовый этап).
- Требуется доступ к существующей MySQL БД с данными (если они есть).

## 8. Риски этапа

- **Потеря данных при экспорте:** неправильная обработка типов данных MySQL → JSON.
- **Ошибки импорта:** различия в типах данных MySQL vs SQLite могут вызвать ошибки.
- **Проблемы с кодировкой:** кириллица может сломаться при экспорте/импорте.
- **Битые связи в существующих данных:** если в исходной БД уже есть проблемы, они проявятся при проверке.

## 9. Оценка трудозатрат

- **Оценка:** 3–5 дней.
- **Основные факторы:**
  - Создание Laravel-миграций для всех 15+ таблиц
  - Реализация команд экспорта/импорта с обработкой типов данных
  - Реализация команды проверки целостности с детальной валидацией
  - Создание API эндпоинта статуса
  - Написание детальной документации по схеме БД
  - Тестирование процесса миграции на реальных данных
