# Спецификация: Создание и управление профилями членов семьи (Этап 2)

## Описание проблемы/потребности

На текущем этапе проект имеет базовую структуру и систему аутентификации. Однако отсутствует возможность хранить и управлять данными о членах семьи, что является основной ценностью приложения. Пользователям необходим инструмент для цифровизации своего генеалогического древа: создания карточек родственников, описания их биографических данных и установления связей между ними.

Данная функциональность решает задачу структурированного хранения семейной истории и подготовки данных для визуализации древа.

## Функциональные требования

1.  **Управление профилями (CRUD):**
    *   Создание профиля члена семьи.
    *   Просмотр списка всех профилей.
    *   Просмотр детальной информации о конкретном члене семьи.
    *   Редактирование данных профиля.
    *   Удаление профиля (с учетом связанных данных).
2.  **Персональные данные:**
    *   Обязательные поля: Имя, Фамилия, Пол.
    *   Дополнительные поля: Отчество, Дата рождения, Место рождения, Дата смерти, Место смерти, Биография (текстовое описание).
3.  **Управление семейными связями:**
    *   Установка связи "Родитель - Ребенок".
    *   Установка связи "Брак" (Супруги).
    *   Возможность указания типа связи при создании (например, биологический родитель, усыновитель).
    *   Автоматическое создание обратных связей (например, при установке "Родитель", у ребенка автоматически появляется связь "Ребенок").
4.  **Валидация:**
    *   Проверка корректности дат (дата смерти не может быть раньше даты рождения).
    *   Предотвращение циклических связей (человек не может быть своим собственным предком).
    *   Проверка логической целостности (например, ребенок не может быть старше родителя).
    *   Проверка на дублирование связей (нельзя добавить одного и того же родителя дважды).
    *   Валидация пола для специфических типов связей (если применимо в будущем, пока базово).
5.  **Поиск и фильтрация:**
    *   Поиск членов семьи по имени/фамилии для удобного установления связей.

## Нефункциональные требования

1.  **Производительность:** Время отклика API для операций CRUD не должно превышать 100 мс.
2.  **Безопасность:**
    *   Доступ к управлению профилями имеют только аутентифицированные пользователи.
    *   Защита персональных данных от несанкционированного доступа.
3.  **Надежность:** Обеспечение целостности данных при удалении профилей (каскадное удаление связей или запрет удаления при наличии активных связей).
4.  **Usability:** Интуитивно понятные формы ввода данных с подсказками по валидации.

## Модель предметной области

### Сущности (Entities)

1.  **FamilyMember (Член семьи):**
    *   `id`: Integer (в БД мапится на `gen_person.ID`)
    *   `firstName`: String (мапится на `gen_name_lang.FNAME` через `gen_person.FNAME_ID`)
    *   `lastName`: String (мапится на `gen_surname_lang.MALE_SURNAME/FEMALE_SURNAME` через `gen_person.SURNAME_ID`)
    *   `middleName`: String (nullable, мапится на `gen_name_lang.MALE_SNAME/FEMALE_SNAME` через `gen_person.SNAME_ID`)
    *   `gender`: Enum (male, female) - будет добавлено в таблицу gen_person
    *   `birthDate`: Date (nullable, мапится на `gen_person.BDATE`)
    *   `birthPlace`: String (nullable) - будет добавлено в таблицу gen_person
    *   `deathDate`: Date (nullable, мапится на `gen_person.DDATE`)
    *   `deathPlace`: String (nullable) - будет добавлено в таблицу gen_person
    *   `biography`: Text (nullable) - будет добавлено в таблицу gen_person_info_lang
    *   `userId`: Integer (мапится на `gen_person.USER_ID`)
    *   `createdAt`: Timestamp - будет добавлено в таблицу gen_person
    *   `updatedAt`: Timestamp - будет добавлено в таблицу gen_person

2.  **Relationship (Связь):**
    *   `id`: Integer (в БД мапится на ID в таблице связей)
    *   `personId`: Integer (ссылка на FamilyMember, мапится на `gen_relation.PID1`)
    *   `relativeId`: Integer (ссылка на FamilyMember, мапится на `gen_relation.PID2`)
    *   `type`: Enum (parent, child, spouse, мапится на `gen_relation.RELATION_TYPE_ID`)
    *   `metadata`: JSON (дополнительная информация, например, тип усыновления) - будет добавлено в таблицу gen_relation

### Объекты-значения (Value Objects)

1.  **FullName:** Комбинация имени, фамилии и отчества.
2.  **LifePeriod:** Период между датой рождения и датой смерти с логикой валидации.

## Технические детали (API и БД)

### API Эндпоинты (Профили)
- `POST /api/v1/family-members` — Создание профиля.
- `GET /api/v1/family-members` — Список профилей (с фильтрацией по имени).
- `GET /api/v1/family-members/{id}` — Детальная информация.
- `PUT /api/v1/family-members/{id}` — Обновление данных.
- `DELETE /api/v1/family-members/{id}` — Удаление профиля.

### API Эндпоинты (Связи)
- `POST /api/v1/relationships` — Создание связи.
- `DELETE /api/v1/relationships/{id}` — Удаление связи.

### Структура БД (SQLite)
Реализация должна опираться на существующую схему в [`backend/database/migrations/structure.sql`](backend/database/migrations/structure.sql):
- **Профили:** Таблицы `gen_person`, `gen_name`, `gen_name_lang`, `gen_surname`, `gen_surname_lang`, `gen_person_info_lang`.
- **Связи:** Таблица `gen_relation`.
- **Пользователи:** Таблица `gen_user`.

*Примечание: Для полного соответствия модели предметной области необходимо внести изменения в структуру БД:*
1. Добавить поля `gender`, `birthPlace`, `deathPlace`, `createdAt`, `updatedAt` в таблицу `gen_person`
2. Добавить поле `INFO` в таблицу `gen_person_info_lang` для хранения биографии
3. Добавить поле `metadata` в таблицу `gen_relation`

## Зависимости

1.  **Auth Module:** Используется для проверки прав доступа к операциям.
2.  **Core Module:** Базовые классы для CQRS и Clean Architecture.
3.  **Database (SQLite):** Хранение данных в таблицах `family_members` и `relationships`.

## Сценарии использования

### Сценарий 1: Добавление нового родственника
**Актер:** Аутентифицированный пользователь.
1. Пользователь открывает форму "Добавить члена семьи".
2. Вводит имя "Иван", фамилию "Иванов", выбирает пол "Мужской".
3. Указывает дату рождения "01.01.1980".
4. Нажимает "Сохранить".
5. Система проверяет данные, сохраняет запись и возвращает ID нового профиля.

### Сценарий 2: Установка связи между отцом и сыном
**Актер:** Аутентифицированный пользователь.
1. Пользователь открывает профиль "Ивана Иванова".
2. Выбирает действие "Добавить ребенка".
3. Выбирает из списка существующего профиля "Петра Иванова".
4. Система проверяет, что Петр младше Ивана и нет циклической зависимости.
5. Система создает запись в таблице связей.

### Сценарий 3: Удаление профиля
**Актер:** Аутентифицированный пользователь.
1. Пользователь выбирает профиль для удаления.
2. Система проверяет наличие связей.
3. При подтверждении система удаляет профиль и все связанные с ним записи в таблице `relationships`.

## Риски

1.  **Целостность данных:** Риск появления "сиротских" связей при некорректном удалении.
2.  **Сложная валидация:** Трудности в реализации проверок на биологическую невозможность связей (например, слишком большая разница в возрасте или пересекающиеся браки).
3.  **Производительность:** При большом количестве связей (тысячи) выборка списка может замедлиться.

## Критерии приемки

1.  Реализованы API эндпоинты для создания, чтения, обновления и удаления профилей.
2.  Реализован механизм установки и удаления связей (родитель, ребенок, супруг).
3.  Все обязательные поля валидируются на стороне сервера.
4.  Система выдает ошибку при попытке создать циклическую связь.
5.  Данные успешно сохраняются в SQLite и корректно извлекаются.
6.  Тесты (Unit и Integration) покрывают основные сценарии CRUD и логику связей.

## Не входит в реализацию

1.  Загрузка фотографий и медиафайлов (будет в следующих этапах).
2.  Визуальное построение графа древа (Frontend часть).
3.  Импорт/экспорт данных в формате GEDCOM.
4.  Публичный доступ к профилям без авторизации.
