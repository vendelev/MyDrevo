# План тестирования: Профили членов семьи и связи

## Структура тестов
Тесты должны быть организованы в соответствии с модульной структурой:
- `backend/tests/Suite/Family/Unit`: Тесты доменных сущностей и Value Objects.
- `backend/tests/Suite/Family/Functional`: Тесты UseCases с моками репозиториев.
- `backend/tests/Suite/Family/Integration`: Тесты репозиториев с реальной SQLite (in-memory).
- `backend/tests/Suite/Family/E2E`: Тесты API эндпоинтов.

## Функциональные тесты (Application слой)

### UseCase: CreateFamilyMember
- **Дано**: Валидные данные профиля (Имя, Фамилия, Пол).
- **Проверяемое**: Вызов репозитория на сохранение.
- **Ожидаемый результат**: Возврат UUID нового профиля.

### UseCase: AddRelationship (Валидация)
- **Сценарий 1 (Цикл)**: Попытка добавить родителя, который уже является потомком.
- **Ожидаемый результат**: `CyclicRelationshipException`.
- **Сценарий 2 (Возраст)**: Попытка добавить ребенка, который старше родителя.
- **Ожидаемый результат**: Ошибка валидации бизнес-логики.

## Integration тесты (Infrastructure слой)

### EloquentFamilyMemberRepository
- **Сценарий**: Сохранение профиля и его получение по ID.
- **Проверяемое**: Корректность маппинга на таблицы `gen_person`, `gen_name_lang` и т.д.
- **Ожидаемый результат**: Данные в БД соответствуют доменной сущности.

### EloquentRelationshipRepository
- **Сценарий**: Создание связи "Родитель-Ребенок".
- **Проверяемое**: Запись в таблице `gen_relation`.
- **Ожидаемый результат**: Связь успешно сохранена и извлекается.

## E2E тесты (Presentation слой)

### API: POST /api/v1/family-members
- **Дано**: JSON с данными профиля, заголовок авторизации.
- **Проверяемое**: HTTP статус 201 и структура ответа.
- **Ожидаемый результат**: Профиль создан в БД.

### API: POST /api/v1/relationships
- **Дано**: JSON с ID двух участников и типом связи.
- **Проверяемое**: HTTP статус 201.
- **Ожидаемый результат**: Связь установлена.

## Чек-лист выполнения
- [ ] `make php-run CMD="php artisan test tests/Suite/Family"`
- [ ] Проверка покрытия тестами (минимум 80% для Application слоя).

## Критерии приемки (из Spec.md)
1. Реализованы API эндпоинты для CRUD профилей.
2. Реализован механизм установки связей (родитель, ребенок, супруг).
3. Валидация обязательных полей работает.
4. Ошибка при циклической связи.
5. Данные сохраняются в SQLite.
6. Тесты покрывают основные сценарии.
