# Спецификация бизнес-требований TZ1_04_1

## Метаинформация

- **Номер задачи:** TZ1_04_1
- **Название:** Создание персоны с многоязычными данными и гендерными формами
- **Родительская задача:** TZ1_04 — Управление персонами (CRUD)
- **Эпик:** TZ1 — Веб-сайт семейного генеалогического древа
- **Этап:** Stage 4 — Управление персонами
- **Дата создания:** 2026-01-23
- **Статус:** Черновик

## Описание проблемы/потребности

### Контекст

После завершения этапов 1-3 проект имеет:

- Готовую схему базы данных SQLite с мигрированными данными генеалогического древа
- Доменную модель (Entity: Person, Name, Surname) с поддержкой многоязычности
- Репозитории для работы с данными через многоязычную схему БД
- Веб-интерфейс для просмотра списка персон и карточек с многоязычными именами/фамилиями

Родительская задача TZ1_04 определяет полный функционал управления персонами (создание, редактирование, удаление). Текущая задача TZ1_04_1 фокусируется **ТОЛЬКО на создании** новой персоны.

### Проблема

**КРИТИЧНО:** Пользователь НЕ может добавлять новых родственников в свое генеалогическое древо, потому что:

1. **Нет формы создания персоны:** Отсутствует интерфейс для ввода данных новой персоны
2. **Нет поддержки многоязычного ввода:** Невозможно указать имена/фамилии на русском и английском языках одновременно
3. **Сложность работы с гендерными формами:** Пользователю непонятно, как корректно вводить мужские/женские формы фамилий (Петров/Петрова) и отчеств (Иванович/Ивановна)
4. **Отсутствие автоматизации рутины:** Пользователь вынужден вручную генерировать отчества и гендерные формы фамилий
5. **Нет валидации данных:** Возможно создание персоны с некорректными данными (пустые имена, дата смерти раньше рождения, девичья фамилия для мужчин)
6. **Дублирование имен/фамилий в БД:** Каждая персона создает новые записи имен/фамилий, даже если они уже существуют

### Бизнес-ценность решения

Реализация создания персоны обеспечит:

- **Возможность расширения дерева:** Пользователь сможет самостоятельно добавлять родственников
- **Поддержку многоязычности:** Ввод имен/фамилий на русском и английском языках сразу при создании
- **Автоматизацию рутины:** Автогенерация отчеств из имени отца, автоподстановка гендерных форм фамилий
- **Корректность данных:** Валидация обязательных полей, дат, девичьих фамилий на уровне формы
- **Экономию места в БД:** Переиспользование существующих имен/фамилий вместо создания дубликатов
- **Удобство ввода:** Autocomplete для имен/фамилий из существующих записей пользователя
- **Аудит изменений:** Логирование всех операций создания для отслеживания истории
- **Основу для следующих задач:** Создание персоны — базовая операция для редактирования, удаления, управления связями

## Функциональные требования

### FR-1. Маршрут и контроллер страницы создания персоны

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять страницу с формой создания новой персоны.

**Детализация:**

Создать маршрут `GET /persons/create` с контроллером `PersonController@create`, который:

1. Получает текущий язык интерфейса из `App::getLocale()`
2. Получает ID тестового пользователя (первый пользователь из таблицы `gen_user`)
3. Загружает справочные данные для формы:
   - Список существующих имен пользователя (для autocomplete) через `NameRepository::findByUserId()`
   - Список существующих фамилий пользователя (для autocomplete) через `SurnameRepository::findByUserId()`
   - Список родителей-мужчин пользователя (для автогенерации отчеств) через `PersonRepository::findByUserId()` с фильтром `Gender::MALE`
4. Передает данные в Blade-шаблон `persons/create.blade.php`

**Требования:**

- На этапе 4 авторизация НЕ реализована — используется тестовый пользователь (первый из БД с ID=1)
- Логика выбора пользователя должна быть централизована для легкой замены на этапе 7 (авторизация)
- Справочные данные (имена, фамилии, родители) должны быть отфильтрованы по userId
- Если пользователь не найден — вернуть ошибку 500 с понятным сообщением

**Критерии приемки FR-1:**

- ✅ Маршрут `GET /persons/create` доступен
- ✅ Контроллер загружает тестового пользователя (ID=1)
- ✅ Контроллер загружает справочные данные (имена, фамилии, родители)
- ✅ Контроллер передает данные в Blade-шаблон

---

### FR-2. Форма создания персоны с многоязычными полями

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять форму с полями для ввода многоязычных данных персоны (русский, английский) и автоматической генерацией гендерных форм.

**Детализация:**

Создать Blade-шаблон `persons/create.blade.php` со следующей структурой:

#### Заголовок формы

- Текст: "Создание новой персоны"
- Язык интерфейса: текущий язык (`ru` или `en`)

#### Раздел "Основная информация"

**Пол (обязательное поле):**

- Тип: Radio buttons
- Варианты:
  - Мужской (значение: `Gender::MALE`)
  - Женский (значение: `Gender::FEMALE`)
  - Неизвестный (значение: `Gender::UNKNOWN`)
- Метка: Звездочка (*) для обозначения обязательности
- Поведение: При выборе пола автоматически:
  - Показать/скрыть раздел "Девичья фамилия"
  - Автозаполнить гендерные формы фамилий

**Дата рождения (необязательное поле):**

- Тип: Поле ввода даты (date input)
- Формат: YYYY-MM-DD
- Валидация: Не может быть в будущем

**Дата смерти (необязательное поле):**

- Тип: Поле ввода даты (date input)
- Формат: YYYY-MM-DD
- Валидация: Не может быть раньше даты рождения
- Условие: Если указана дата смерти, дата рождения становится обязательной

#### Раздел "Имя (русский язык)"

**Имя (ru) — обязательное поле:**

- Тип: Текстовое поле с autocomplete
- Длина: 1-100 символов
- Autocomplete: Список существующих имен пользователя на русском языке
- Placeholder: "Иван"

**Отчество (ru) — необязательное поле:**

- Два режима ввода (переключатель):
  1. **Автоматическая генерация:**
     - Выпадающий список родителей-мужчин пользователя
     - При выборе отца система автоматически подставляет отчество из `NameTranslation::malePatronymic` и `femalePatronymic`
     - Пример: Выбран "Иван" → мужская форма "Иванович", женская форма "Ивановна"
  2. **Ручной ввод:**
     - Текстовое поле "Отчество (ru) - мужская форма" (1-100 символов)
     - Текстовое поле "Отчество (ru) - женская форма" (1-100 символов)
     - Placeholder: "Иванович" / "Ивановна"
- Пользователь может переключаться между режимами
- Если выбран пол персоны, показывается только соответствующая форма отчества

#### Раздел "Имя (английский язык)"

**Имя (en) — обязательное поле:**

- Тип: Текстовое поле с autocomplete
- Длина: 1-100 символов
- Autocomplete: Список существующих имен пользователя на английском языке
- Placeholder: "Ivan"

**Отчество (en) — необязательное поле:**

- Тип: Текстовое поле
- Длина: 1-100 символов
- Примечание: В английском языке отчество обычно не используется, но доступно
- Placeholder: "Ivanovich" (транслитерация)

#### Раздел "Фамилия (русский язык)"

**Фамилия (ru) - мужская форма — обязательное поле:**

- Тип: Текстовое поле с autocomplete
- Длина: 1-100 символов
- Autocomplete: Список существующих фамилий пользователя на русском языке
- Placeholder: "Петров"

**Фамилия (ru) - женская форма — обязательное поле:**

- Тип: Текстовое поле
- Длина: 1-100 символов
- Автоподстановка: При вводе мужской формы система автоматически заполняет женскую форму:
  - "-ов" → "-ова" (Петров → Петрова)
  - "-ев" → "-ева" (Сергеев → Сергеева)
  - "-ин" → "-ина" (Ильин → Ильина)
  - "-ский" → "-ская" (Московский → Московская)
  - "-кий" → "-кая" (Вольский → Вольская)
  - В остальных случаях — копировать мужскую форму
- Поведение при выборе пола:
  - Если пол = Мужской: активно только поле мужской формы, женская форма неактивна (но заполнена)
  - Если пол = Женский: активно только поле женской формы, мужская форма неактивна (но заполнена)
  - Если пол = Неизвестный: активны оба поля
- Пользователь может изменить автозаполненное значение вручную
- Placeholder: "Петрова"

#### Раздел "Фамилия (английский язык)"

**Фамилия (en) - мужская форма — обязательное поле:**

- Тип: Текстовое поле с autocomplete
- Длина: 1-100 символов
- Autocomplete: Список существующих фамилий пользователя на английском языке
- Placeholder: "Petrov"

**Фамилия (en) - женская форма — обязательное поле:**

- Тип: Текстовое поле
- Длина: 1-100 символов
- Примечание: В английском языке обе формы обычно одинаковы
- Автоподстановка: Копирование мужской формы
- Пользователь может изменить автозаполненное значение вручную
- Placeholder: "Petrova"

#### Раздел "Девичья фамилия" (только для женщин)

**Условие отображения:** Раздел отображается ТОЛЬКО если выбран пол = Женский

**Девичья фамилия (ru) - женская форма — необязательное поле:**

- Тип: Текстовое поле с autocomplete
- Длина: 1-100 символов
- Autocomplete: Список существующих фамилий пользователя на русском языке
- Placeholder: "Смирнова"

**Девичья фамилия (ru) - мужская форма — необязательное поле:**

- Тип: Текстовое поле
- Длина: 1-100 символов
- Автозаполнение: При вводе женской формы автоматически заполняется мужская форма (обратная логика автоподстановки)
- Placeholder: "Смирнов"

**Девичья фамилия (en) - женская форма — необязательное поле:**

- Тип: Текстовое поле с autocomplete
- Длина: 1-100 символов
- Placeholder: "Smirnova"

**Девичья фамилия (en) - мужская форма — необязательное поле:**

- Тип: Текстовое поле
- Длина: 1-100 символов
- Автозаполнение: Копирование женской формы
- Placeholder: "Smirnov"

#### Раздел "Дополнительная информация"

**Информация (ru) — необязательное поле:**

- Тип: Многострочное текстовое поле (textarea)
- Длина: До 5000 символов
- Назначение: Биография, заметки, дополнительные сведения о персоне
- Placeholder: "Биография, заметки, дополнительная информация..."

**Информация (en) — необязательное поле:**

- Тип: Многострочное текстовое поле (textarea)
- Длина: До 5000 символов
- Placeholder: "Biography, notes, additional information..."

#### Кнопки управления

- **Создать персону** — основная кнопка (зеленый цвет), отправка формы на `POST /persons`
- **Отмена** — вторичная кнопка (серый цвет), возврат к списку персон `/persons?lang={lang}`

**Требования к форме:**

- Все обязательные поля должны быть визуально помечены звездочкой (*)
- Autocomplete должен работать после ввода минимум 2 символов
- Autocomplete должен предлагать не более 10 вариантов
- Автозаполнение гендерных форм должно происходить динамически (JavaScript/Alpine.js/Vue.js)
- Раздел "Девичья фамилия" должен скрываться/показываться при смене пола (JavaScript)
- Форма должна быть адаптивной (responsive) для мобильных устройств
- Все поля должны иметь понятные названия на текущем языке интерфейса

**Критерии приемки FR-2:**

- ✅ Форма содержит все разделы и поля согласно описанию
- ✅ Обязательные поля помечены визуально (звездочка)
- ✅ Autocomplete работает для имен и фамилий
- ✅ Автогенерация отчеств работает при выборе отца из списка
- ✅ Автоподстановка гендерных форм фамилий работает корректно
- ✅ Раздел "Девичья фамилия" отображается только для женщин
- ✅ Пользователь может изменить автозаполненные значения вручную
- ✅ Форма адаптивна для мобильных устройств

---

### FR-3. API для autocomplete имен и фамилий

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять API эндпоинты для autocomplete при вводе имен и фамилий в форме.

**Детализация:**

#### API эндпоинт для autocomplete имен

Создать маршрут `GET /api/autocomplete/names` с контроллером, который:

**Входные параметры:**

- `q` (обязательный) — строка поиска, минимум 2 символа
- `lang` (обязательный) — язык (`ru` или `en`)

**Логика обработки:**

1. Получает ID тестового пользователя
2. Ищет имена в таблице `gen_name_lang`:
   - Условие: `WHERE FNAME LIKE '{query}%' AND LANG = '{lang}' AND USER_ID = {userId}`
   - Сортировка: По частоте использования (количество персон с этим именем) — `ORDER BY usage_count DESC`
   - Лимит: 10 результатов
3. Возвращает JSON-массив с именами:

```json
[
  {
    "id": 1,
    "name": "Иван",
    "usageCount": 15
  },
  {
    "id": 2,
    "name": "Игорь",
    "usageCount": 8
  }
]
```

#### API эндпоинт для autocomplete фамилий

Создать маршрут `GET /api/autocomplete/surnames` с контроллером, который:

**Входные параметры:**

- `q` (обязательный) — строка поиска, минимум 2 символа
- `lang` (обязательный) — язык (`ru` или `en`)

**Логика обработки:**

Аналогично autocomplete имен, но для таблицы `gen_surname_lang`:

- Условие: `WHERE SNAME LIKE '{query}%' AND LANG = '{lang}' AND USER_ID = {userId}`
- Сортировка: По частоте использования
- Лимит: 10 результатов

**Требования:**

- Autocomplete должен работать только для авторизованного пользователя (на этапе 4 — тестовый пользователь)
- Результаты должны быть отсортированы по популярности (частоте использования)
- Запрос должен быть защищен от SQL-инъекций (параметризованные запросы)
- Если параметр `q` меньше 2 символов — вернуть пустой массив
- Если язык не `ru` или `en` — вернуть ошибку 400
- Производительность: Ответ должен приходить менее чем за 0.5 секунды на 1000 имен/фамилий

**Критерии приемки FR-3:**

- ✅ API эндпоинт `GET /api/autocomplete/names` работает корректно
- ✅ API эндпоинт `GET /api/autocomplete/surnames` работает корректно
- ✅ Результаты отфильтрованы по userId
- ✅ Результаты отсортированы по популярности
- ✅ Запросы защищены от SQL-инъекций
- ✅ Производительность: ответ менее 0.5 сек на 1000 записей

---

### FR-4. Обработка формы создания персоны

**Приоритет:** Высокий

**Описание:**
Система должна обрабатывать отправленную форму создания персоны, валидировать данные и сохранять персону в БД.

**Детализация:**

Создать маршрут `POST /persons` с контроллером `PersonController@store`, который:

**Шаг 1. Валидация входных данных (см. FR-5)**

Использовать Laravel Request Validation для проверки всех полей формы.

**Шаг 2. Получение тестового пользователя**

- Получить ID тестового пользователя (первый из БД)
- Если пользователь не найден — вернуть ошибку 500

**Шаг 3. Обработка имени персоны**

Для каждого языка (ru, en):

1. Извлечь имя из формы: `$request->input('first_name_ru')`, `$request->input('first_name_en')`
2. Попытаться найти существующее имя через `NameRepository::findByName($name, $language, $userId)`
3. Если найдено — получить ID существующего имени
4. Если не найдено — создать новое имя:
   - Создать запись в `gen_name` с `USER_ID = {userId}`
   - Создать запись в `gen_name_lang` с переводом на текущий язык
   - Создать связь в `gen_mixed_name_lang` между `gen_name` и `gen_name_lang`
   - Получить ID созданного имени
5. Сохранить ID имени для дальнейшего использования

**Шаг 4. Обработка отчества персоны (если указано)**

Аналогично шагу 3, но для отчества:

- Извлечь отчество из формы: `$request->input('middle_name_ru_male')`, `$request->input('middle_name_ru_female')`, `$request->input('middle_name_en')`
- Если выбран режим автогенерации — использовать имя отца
- Поиск/создание через `NameRepository`

**Шаг 5. Обработка фамилии персоны**

Аналогично шагу 3, но для фамилии:

- Извлечь фамилию из формы: `$request->input('surname_ru_male')`, `$request->input('surname_ru_female')`, `$request->input('surname_en_male')`, `$request->input('surname_en_female')`
- Поиск/создание через `SurnameRepository`

**Шаг 6. Обработка девичьей фамилии (если указана)**

Если пол = Женский И указана девичья фамилия:

- Извлечь девичью фамилию из формы
- Поиск/создание через `SurnameRepository`

**Шаг 7. Создание объекта Person**

Создать объект `Person` со следующими данными:

```php
$person = new Person(
    id: null, // Будет присвоен БД
    userId: $userId,
    firstName: $firstName, // Объект Name
    middleName: $middleName, // Объект Name или null
    surname: $surname, // Объект Surname
    birthSurname: $birthSurname, // Объект Surname или null
    birthDate: $request->input('birth_date'), // DateTime или null
    deathDate: $request->input('death_date'), // DateTime или null
    info: [
        'ru' => $request->input('info_ru'),
        'en' => $request->input('info_en'),
    ],
    gender: Gender::from($request->input('gender'))
);
```

**Шаг 8. Сохранение персоны в БД**

1. Обернуть операцию в транзакцию БД
2. Вызвать `PersonRepository::save($person)`
3. Получить ID созданной персоны
4. Зафиксировать транзакцию (commit)
5. При ошибке — откатить транзакцию (rollback)

**Шаг 9. Логирование операции**

Создать запись в таблице `audit_logs`:

```php
[
    'user_id' => $userId,
    'action' => 'person.created',
    'entity_type' => 'Person',
    'entity_id' => $person->id,
    'old_value' => null,
    'new_value' => json_encode([
        'fullName' => $person->getFullName($language),
        'birthDate' => $person->birthDate?->format('Y-m-d'),
        'deathDate' => $person->deathDate?->format('Y-m-d'),
        'gender' => $person->gender->value,
    ]),
    'created_at' => now(),
]
```

**Шаг 10. Перенаправление и flash-сообщение**

1. Перенаправить на карточку созданной персоны: `/persons/{id}?lang={lang}`
2. Показать flash-сообщение: "Персона успешно создана: {Полное имя}"

**Требования:**

- Вся операция должна выполняться в одной транзакции БД
- При ошибке на любом этапе — откатить все изменения
- При ошибке валидации — вернуть форму с сохраненными данными и сообщениями об ошибках
- При ошибке сохранения — откатить транзакцию и показать понятное сообщение пользователю
- Переиспользовать существующие имена/фамилии через поиск по тексту и userId
- Autocomplete использует индексы БД на полях FNAME и SNAME для производительности

**Критерии приемки FR-4:**

- ✅ Форма обрабатывается маршрутом `POST /persons`
- ✅ Валидация работает корректно (см. FR-5)
- ✅ Система переиспользует существующие имена/фамилии
- ✅ Создаются новые имена/фамилии только если не найдены существующие
- ✅ Персона сохраняется в `gen_person` со ссылками на имена/фамилии
- ✅ Операция выполняется в транзакции БД
- ✅ Операция логируется в `audit_logs`
- ✅ После успешного создания — редирект на карточку персоны с flash-сообщением
- ✅ При ошибке валидации — форма возвращается с сохраненными данными и ошибками
- ✅ При ошибке сохранения — транзакция откатывается

---

### FR-5. Валидация данных при создании персоны

**Приоритет:** Высокий

**Описание:**
Система должна валидировать все поля формы создания персоны и отклонять некорректные данные с понятными сообщениями об ошибках.

**Детализация:**

Использовать Laravel Request Validation для проверки следующих правил:

#### Валидация обязательных полей

**Пол (gender):**

- Правило: `required|in:male,female,unknown`
- Сообщение об ошибке: "Укажите пол персоны"

**Имя (ru):**

- Правило: `required|string|min:1|max:100`
- Сообщение об ошибке: "Укажите имя на русском языке (1-100 символов)"

**Имя (en):**

- Правило: `required|string|min:1|max:100`
- Сообщение об ошибке: "Укажите имя на английском языке (1-100 символов)"

**Фамилия (ru) - мужская форма:**

- Правило: `required|string|min:1|max:100`
- Сообщение об ошибке: "Укажите фамилию на русском языке - мужская форма (1-100 символов)"

**Фамилия (ru) - женская форма:**

- Правило: `required|string|min:1|max:100`
- Сообщение об ошибке: "Укажите фамилию на русском языке - женская форма (1-100 символов)"

**Фамилия (en) - мужская форма:**

- Правило: `required|string|min:1|max:100`
- Сообщение об ошибке: "Укажите фамилию на английском языке - мужская форма (1-100 символов)"

**Фамилия (en) - женская форма:**

- Правило: `required|string|min:1|max:100`
- Сообщение об ошибке: "Укажите фамилию на английском языке - женская форма (1-100 символов)"

#### Валидация необязательных полей

**Отчество (ru) - мужская форма:**

- Правило: `nullable|string|min:1|max:100`
- Сообщение об ошибке: "Отчество на русском (мужская форма) должно быть 1-100 символов"

**Отчество (ru) - женская форма:**

- Правило: `nullable|string|min:1|max:100`
- Сообщение об ошибке: "Отчество на русском (женская форма) должно быть 1-100 символов"

**Отчество (en):**

- Правило: `nullable|string|min:1|max:100`
- Сообщение об ошибке: "Отчество на английском должно быть 1-100 символов"

**Дата рождения:**

- Правило: `nullable|date|before_or_equal:today`
- Сообщение об ошибке: "Дата рождения должна быть корректной датой и не в будущем"

**Дата смерти:**

- Правило: `nullable|date|after_or_equal:birth_date`
- Сообщение об ошибке: "Дата смерти не может быть раньше даты рождения"
- Дополнительное правило: Если указана дата смерти, дата рождения обязательна
- Сообщение: "Если указана дата смерти, укажите дату рождения"

**Девичья фамилия (все формы):**

- Правило: `nullable|string|min:1|max:100`
- Сообщение об ошибке: "Девичья фамилия должна быть 1-100 символов"

**Информация (ru):**

- Правило: `nullable|string|max:5000`
- Сообщение об ошибке: "Информация на русском не должна превышать 5000 символов"

**Информация (en):**

- Правило: `nullable|string|max:5000`
- Сообщение об ошибке: "Информация на английском не должна превышать 5000 символов"

#### Валидация бизнес-правил

**Девичья фамилия только для женщин:**

- Правило: Если указана девичья фамилия, пол должен быть `Gender::FEMALE`
- Сообщение об ошибке: "Девичья фамилия может быть указана только для женщин"

**Дата смерти не раньше даты рождения:**

- Правило: `death_date >= birth_date`
- Сообщение об ошибке: "Дата смерти не может быть раньше даты рождения"

**Дата рождения не в будущем:**

- Правило: `birth_date <= today`
- Сообщение об ошибке: "Дата рождения не может быть в будущем"

**Требования к сообщениям об ошибках:**

- Все сообщения должны быть на русском языке (на текущем этапе)
- Сообщения должны быть понятны нетехническому пользователю
- Сообщения должны указывать, как исправить ошибку
- Сообщения должны отображаться рядом с соответствующим полем формы

**Критерии приемки FR-5:**

- ✅ Валидация обязательных полей работает корректно
- ✅ Валидация необязательных полей работает корректно
- ✅ Бизнес-правила валидации работают (девичья фамилия, даты)
- ✅ Сообщения об ошибках понятны и информативны
- ✅ Сообщения отображаются рядом с полями
- ✅ При ошибке валидации форма возвращается с сохраненными данными

---

### FR-6. Навигация и интеграция с интерфейсом

**Приоритет:** Средний

**Описание:**
Система должна интегрировать форму создания персоны в существующий интерфейс просмотра.

**Детализация:**

#### Кнопка создания на странице списка персон

На странице списка персон `GET /persons` добавить:

- Кнопку "Добавить персону" или "Создать персону"
- Расположение: Сверху списка, визуально заметна (зеленый цвет, иконка "+")
- Действие: Переход на `/persons/create?lang={lang}` (сохранение текущего языка)

#### Flash-сообщение об успешном создании

После успешного создания персоны на карточке персоны показать:

- Тип: Flash-сообщение (зеленый цвет, иконка "✓")
- Текст: "Персона успешно создана: {Полное имя}"
- Автоматическое исчезновение: Через 5 секунд
- Полное имя: В формате "{Имя} {Отчество} {Фамилия}" на текущем языке

#### Сохранение текущего языка

Все ссылки должны сохранять текущий язык интерфейса:

- Форма создания: `/persons/create?lang={lang}`
- После создания: `/persons/{id}?lang={lang}`
- Кнопка "Отмена": `/persons?lang={lang}`

**Критерии приемки FR-6:**

- ✅ На странице списка персон есть кнопка "Добавить персону"
- ✅ Кнопка визуально заметна и понятна
- ✅ Все ссылки сохраняют текущий язык интерфейса
- ✅ Flash-сообщение отображается после успешного создания
- ✅ Flash-сообщение автоматически исчезает через 5 секунд

---

## Нефункциональные требования

### NFR-1. Авторизация (ограниченная на этапе 4)

**Описание:**
На этапе 4 авторизация не реализована, используется тестовый пользователь.

**Критерии:**

- Все операции выполняются от имени тестового пользователя (первый в таблице `gen_user` с ID=1)
- Логика выбора пользователя централизована для легкой замены на этапе 7 (авторизация)
- Все справочные данные (имена, фамилии, родители) отфильтрованы по userId тестового пользователя

**Проверка:**

- Попытка получить доступ к форме создания без пользователя возвращает ошибку 500
- Все autocomplete API возвращают данные только тестового пользователя

---

### NFR-2. Транзакционность изменений

**Описание:**
Все операции записи должны быть транзакционными для обеспечения целостности данных.

**Критерии:**

- Создание персоны выполняется в одной транзакции БД
- При ошибке на любом этапе (создание имени, фамилии, персоны) — откат всех изменений
- Нет частично сохраненных данных (например, имя создано, но персона не сохранилась)

**Проверка:**

- Симулировать ошибку в середине транзакции (например, дублирование ключа)
- Убедиться, что БД не изменилась (нет новых записей в gen_name, gen_surname, gen_person)

---

### NFR-3. Понятность формы для нетехнического пользователя

**Описание:**
Форма должна быть интуитивно понятна пользователю без технического бэкграунда.

**Критерии:**

- Все поля имеют понятные названия на русском/английском языках
- Обязательные поля визуально помечены звездочкой (*)
- Подсказки (placeholder) объясняют, что вводить
- Сообщения об ошибках понятны ("Укажите дату рождения", а не "birth_date is required")
- Автозаполнение упрощает ввод (отчества, гендерные формы фамилий)
- Раздел "Девичья фамилия" отображается только для женщин

**Проверка:**

- Ревью формы нетехническим пользователем
- Usability-тестирование с записью экрана

---

### NFR-4. Аудит операции создания

**Описание:**
Операция создания персоны должна логироваться в таблицу `audit_logs`.

**Критерии:**

- Каждое создание персоны создает запись в audit_logs
- Логируются: user_id, action, entity_type, entity_id, old_value (null), new_value (данные персоны), created_at
- Формат new_value: JSON с полями fullName, birthDate, deathDate, gender
- Логи не удаляются при удалении персоны (будет на задаче TZ1_04_3)

**Проверка:**

- После создания персоны проверить наличие записи в audit_logs
- Проверить корректность сохраненных данных в new_value

---

### NFR-5. Производительность

**Описание:**
Форма и autocomplete должны работать быстро даже на больших объемах данных.

**Критерии:**

- Форма создания загружается менее чем за 1 секунду
- Autocomplete возвращает результаты менее чем за 0.5 секунды на 1000 имен/фамилий
- Сохранение персоны занимает менее 2 секунд
- Используются индексы БД на полях FNAME и SNAME для ускорения autocomplete

**Проверка:**

- Измерить время загрузки формы на тестовых данных (1000+ персон)
- Измерить время работы autocomplete на 1000+ имен
- Измерить время сохранения персоны

---

### NFR-6. Безопасность

**Описание:**
Форма должна быть защищена от типичных уязвимостей.

**Критерии:**

- Защита от SQL-инъекций: Использовать параметризованные запросы или Eloquent ORM
- Защита от XSS-атак: Использовать экранирование в Blade-шаблонах (`{{ }}`, а не `{!! !!}`)
- Валидация всех входных данных на стороне сервера (не только JavaScript)
- Защита от CSRF-атак: Использовать Laravel CSRF-токены в формах

**Проверка:**

- Попытаться отправить SQL-инъекцию в поле имени
- Попытаться отправить XSS-скрипт в поле информации
- Проверить наличие CSRF-токена в форме

---

## Модель предметной области

Задача TZ1_04_1 использует доменную модель, созданную на этапе 2. Основные сущности:

### Person (Персона)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец дерева
- `firstName: Name` — имя (многоязычное)
- `middleName: ?Name` — отчество (опционально)
- `surname: ?Surname` — текущая фамилия (опционально)
- `birthSurname: ?Surname` — девичья фамилия (опционально)
- `birthDate: ?DateTime` — дата рождения
- `deathDate: ?DateTime` — дата смерти
- `info: array<string, string>` — описание по языкам (`['ru' => '...', 'en' => '...']`)
- `gender: Gender` — пол персоны (enum: MALE, FEMALE, UNKNOWN)

**Бизнес-правила:**

- Девичья фамилия может быть указана ТОЛЬКО для женщин (Gender::FEMALE)
- Если указана дата смерти, дата рождения обязательна
- Дата смерти не может быть раньше даты рождения
- Дата рождения не может быть в будущем

**Методы:**

- `getFullName(string $language): string` — возвращает полное имя на указанном языке

### Name (Имя/Отчество)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец имени
- `translations: array<NameTranslation>` — переводы на языки

**NameTranslation (Перевод имени):**

- `language: string` — язык (ru, en)
- `name: string` — текст имени на языке
- `malePatronymic: ?string` — мужская форма отчества (Иванович)
- `femalePatronymic: ?string` — женская форма отчества (Ивановна)

### Surname (Фамилия)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец фамилии
- `translations: array<SurnameTranslation>` — переводы на языки

**SurnameTranslation (Перевод фамилии):**

- `language: string` — язык (ru, en)
- `maleSurname: string` — мужская форма фамилии (Петров)
- `femaleSurname: string` — женская форма фамилии (Петрова)

### Gender (Пол)

**Enum:**

- `MALE` — мужской
- `FEMALE` — женский
- `UNKNOWN` — неизвестный

### Репозитории

**NameRepository:**

- `findByName(string $name, string $language, int $userId): ?Name` — поиск имени по тексту и языку
- `findByUserId(int $userId): array<Name>` — все имена пользователя
- `save(Name $name): void` — сохранение имени

**SurnameRepository:**

- `findBySurname(string $surname, string $language, int $userId): ?Surname` — поиск фамилии по тексту и языку
- `findByUserId(int $userId): array<Surname>` — все фамилии пользователя
- `save(Surname $surname): void` — сохранение фамилии

**PersonRepository:**

- `save(Person $person): void` — сохранение персоны
- `findById(int $id, string $language): ?Person` — поиск персоны по ID
- `findByUserId(int $userId): array<Person>` — все персоны пользователя

---

## Зависимости

### Внешние зависимости

- **Laravel 12** — фреймворк для web routes, контроллеров, Blade, validation
- **PHP 8.5** — язык программирования
- **SQLite** — СУБД с данными
- **JavaScript (Alpine.js/Vue.js)** — для динамического поведения формы (autocomplete, автозаполнение)

### Внутренние зависимости

Задача TZ1_04_1 **зависит** от:

- **Этап 1 (TZ1_01)** — требует готовую схему БД с таблицами:
  - gen_user
  - gen_person
  - gen_name, gen_name_lang, gen_mixed_name_lang
  - gen_surname, gen_surname_lang, gen_mixed_surname_lang
  - gen_person_info_lang
  - audit_logs
- **Этап 2 (TZ1_02)** — требует доменную модель и репозитории:
  - Entity: Person, Name, Surname
  - ValueObject: Gender, NameTranslation, SurnameTranslation
  - Repositories: PersonRepository, NameRepository, SurnameRepository
  - Методы: save(), findByName(), findBySurname(), findByUserId()
- **Этап 3 (TZ1_03)** — требует интерфейс просмотра:
  - Страница списка персон `/persons`
  - Карточка персоны `/persons/{id}`
  - Blade-layout для единообразия интерфейса

Задача TZ1_04_1 **является блокирующей** для:

- **TZ1_04_2** — Редактирование персоны (требует созданных персон)
- **TZ1_04_3** — Удаление персоны (требует созданных персон)
- **Этап 5** — Управление связями (требует возможность создавать персон для связей)

---

## Сценарии использования

### UC-1. Пользователь создает персону с полными многоязычными данными

**Актор:** Пользователь

**Предусловия:**

- Пользователь авторизован (тестовый пользователь ID=1)
- В БД есть существующие персоны (для автогенерации отчеств)
- В БД есть существующие имена и фамилии (для autocomplete)

**Основной сценарий:**

1. Пользователь открывает список персон `/persons?lang=ru`
2. Видит кнопку "Добавить персону" сверху списка
3. Кликает на кнопку "Добавить персону"
4. Переходит на форму создания `/persons/create?lang=ru`
5. Видит форму "Создание новой персоны" с разделами:
   - Основная информация
   - Имя (русский язык)
   - Имя (английский язык)
   - Фамилия (русский язык)
   - Фамилия (английский язык)
   - Дополнительная информация
6. Заполняет основную информацию:
   - Выбирает пол: **Женский** (radio button)
   - Вводит дату рождения: **1990-05-15**
7. Заполняет имя (русский):
   - Вводит имя: "Мар" → autocomplete предлагает "Мария" → выбирает "Мария"
   - Выбирает режим автогенерации отчества
   - Выбирает отца из списка: "Иван Петрович Сидоров"
   - Система автоматически заполняет отчество: "Ивановна" (женская форма)
8. Заполняет имя (английский):
   - Вводит имя: "Mary"
9. Заполняет фамилию (русский):
   - Вводит мужскую форму: "Петров"
   - Система автоматически заполняет женскую форму: "Петрова"
   - Так как пол = Женский, активно только поле женской формы
10. Заполняет фамилию (английский):
    - Вводит мужскую форму: "Petrova"
    - Система автоматически заполняет женскую форму: "Petrova" (одинаковы)
11. Заполняет девичью фамилию (раздел отображается автоматически, т.к. пол = Женский):
    - Вводит женскую форму: "Смирнова"
    - Система автоматически заполняет мужскую форму: "Смирнов"
12. Заполняет дополнительную информацию:
    - Информация (ru): "Замужем, двое детей. Работает учителем."
    - Информация (en): "Married, has two children. Works as a teacher."
13. Кликает кнопку "Создать персону"
14. Система валидирует данные — все корректно
15. Система обрабатывает данные:
    - Ищет имя "Мария" (ru) — находит существующее, получает ID
    - Ищет имя "Mary" (en) — находит существующее, получает ID
    - Ищет отчество "Ивановна" (ru) — создает новое (не существовало)
    - Ищет фамилию "Петрова/Петров" (ru) — находит существующую, получает ID
    - Ищет фамилию "Petrova" (en) — создает новую
    - Ищет девичью фамилию "Смирнова/Смирнов" (ru) — находит существующую
    - Создает объект Person с полученными данными
    - Сохраняет персону в БД в транзакции
    - Логирует операцию в audit_logs
16. Пользователь перенаправляется на карточку созданной персоны `/persons/{id}?lang=ru`
17. Видит flash-сообщение (зеленый цвет): "Персона успешно создана: Мария Ивановна Петрова"
18. Проверяет корректность отображения всех данных:
    - Полное имя: "Мария Ивановна Петрова (дев. Смирнова)"
    - Даты: "15.05.1990 — н.в."
    - Информация: "Замужем, двое детей. Работает учителем."
19. Переключает язык на английский (`?lang=en`)
20. Видит корректное отображение:
    - Полное имя: "Mary Petrova (maiden Smirnova)"
    - Информация: "Married, has two children. Works as a teacher."

**Постусловия:**

- В БД создана новая персона в таблице `gen_person`
- Переиспользованы существующие имена и фамилии (нет дубликатов)
- Создано новое отчество "Ивановна" в таблицах gen_name, gen_name_lang, gen_mixed_name_lang
- Девичья фамилия связана с персоной
- Информация сохранена на обоих языках в gen_person_info_lang
- Операция залогирована в audit_logs
- Гендерные формы корректны (Петрова, Ивановна)

---

### UC-2. Пользователь создает персону с минимальным набором данных

**Актор:** Пользователь

**Предусловия:**

- Пользователь авторизован (тестовый пользователь)

**Основной сценарий:**

1. Пользователь открывает форму создания `/persons/create?lang=ru`
2. Заполняет только обязательные поля:
   - Пол: **Мужской**
   - Имя (ru): "Алексей"
   - Имя (en): "Alexey"
   - Фамилия (ru) - мужская форма: "Иванов"
   - Фамилия (ru) - женская форма: "Иванова" (автозаполнено)
   - Фамилия (en) - мужская форма: "Ivanov"
   - Фамилия (en) - женская форма: "Ivanova" (автозаполнено)
3. Оставляет пустыми необязательные поля:
   - Отчество (ru/en) — не заполнено
   - Дата рождения — не заполнено
   - Дата смерти — не заполнено
   - Информация (ru/en) — не заполнено
4. Кликает "Создать персону"
5. Система валидирует данные — все корректно
6. Система создает персону с минимальным набором данных
7. Пользователь перенаправляется на карточку `/persons/{id}?lang=ru`
8. Видит flash-сообщение: "Персона успешно создана: Алексей Иванов"
9. На карточке видит:
   - Полное имя: "Алексей Иванов"
   - Даты: "Неизвестно"
   - Информация: "Нет данных"

**Постусловия:**

- Персона создана с минимальным набором данных
- Необязательные поля установлены в null
- Отчество отсутствует (middleName = null)
- Даты рождения/смерти отсутствуют

---

### UC-3. Система предотвращает ошибки валидации

**Актор:** Пользователь

**Предусловия:**

- Пользователь на форме создания персоны

**Основной сценарий:**

1. Пользователь заполняет форму с ошибками:
   - Пол: **Женский**
   - Имя (ru): "Мария"
   - Имя (en): "" **(пустое — ошибка)**
   - Фамилия (ru): "Петрова" / "Петров"
   - Фамилия (en): "" / "" **(пустые — ошибки)**
   - Дата рождения: **2030-01-01** (в будущем — ошибка)
   - Дата смерти: **2000-01-01** (раньше даты рождения — ошибка)
   - Девичья фамилия (ru): "Смирнова" / "Смирнов"
2. Кликает "Создать персону"
3. Система выполняет валидацию и находит ошибки:
   - Имя (en) обязательно
   - Фамилия (en) - мужская форма обязательна
   - Фамилия (en) - женская форма обязательна
   - Дата рождения не может быть в будущем
   - Дата смерти не может быть раньше даты рождения
4. Система возвращает форму с сохраненными данными
5. Показывает сообщения об ошибках рядом с полями (красный цвет):
   - Имя (en): "Укажите имя на английском языке (1-100 символов)"
   - Фамилия (en) - мужская форма: "Укажите фамилию на английском языке - мужская форма (1-100 символов)"
   - Фамилия (en) - женская форма: "Укажите фамилию на английском языке - женская форма (1-100 символов)"
   - Дата рождения: "Дата рождения должна быть корректной датой и не в будущем"
   - Дата смерти: "Дата смерти не может быть раньше даты рождения"
6. Пользователь исправляет ошибки:
   - Имя (en): "Mary"
   - Фамилия (en): "Petrova" / "Petrova"
   - Дата рождения: **1990-01-01**
   - Дата смерти: **2020-01-01**
7. Кликает "Создать персону" снова
8. Система валидирует данные — все корректно
9. Персона успешно создана

**Постусловия:**

- Валидация предотвратила некорректные данные
- Пользователь увидел понятные сообщения об ошибках
- Форма сохранила введенные данные (не потеряны после ошибки)
- Персона создана с корректными данными

---

### UC-4. Пользователь пытается создать персону с девичьей фамилией для мужчины

**Актор:** Пользователь

**Предусловия:**

- Пользователь на форме создания персоны

**Основной сценарий:**

1. Пользователь заполняет форму:
   - Пол: **Мужской** (раздел "Девичья фамилия" скрыт)
   - Имя (ru): "Иван"
   - Имя (en): "Ivan"
   - Фамилия (ru): "Петров" / "Петрова"
   - Фамилия (en): "Petrov" / "Petrova"
2. Пользователь использует инструменты разработчика браузера, чтобы показать скрытый раздел "Девичья фамилия"
3. Заполняет девичью фамилию: "Смирнов" / "Смирнова"
4. Кликает "Создать персону"
5. Система выполняет валидацию на стороне сервера
6. Обнаруживает нарушение бизнес-правила: "Девичья фамилия может быть указана только для женщин"
7. Возвращает форму с ошибкой:
   - Сообщение: "Девичья фамилия может быть указана только для женщин"
8. Пользователь удаляет девичью фамилию
9. Создает персону успешно

**Постусловия:**

- Валидация на стороне сервера предотвратила нарушение бизнес-правила
- Пользователь не может обойти валидацию через инструменты разработчика

---

### UC-5. Система переиспользует существующие имена и фамилии

**Актор:** Пользователь

**Предусловия:**

- В БД уже есть персона "Иван Петрович Сидоров" с именем "Иван" (ru), "Ivan" (en) и фамилией "Сидоров/Сидорова" (ru)

**Основной сценарий:**

1. Пользователь создает новую персону:
   - Пол: Мужской
   - Имя (ru): "Иван" (такое же, как у существующей персоны)
   - Имя (en): "Ivan" (такое же)
   - Отчество (ru): "Петрович" (такое же)
   - Фамилия (ru): "Сидоров" / "Сидорова" (такая же)
   - Фамилия (en): "Sidorov" / "Sidorova"
2. Кликает "Создать персону"
3. Система обрабатывает данные:
   - Ищет имя "Иван" (ru) — **находит существующее**, получает ID (например, 5)
   - Ищет имя "Ivan" (en) — **находит существующее**, получает ID (5)
   - Ищет отчество "Петрович" (ru) — **находит существующее**, получает ID (10)
   - Ищет фамилию "Сидоров/Сидорова" (ru) — **находит существующую**, получает ID (8)
   - Ищет фамилию "Sidorov/Sidorova" (en) — **не находит**, создает новую, получает ID (новый)
   - Создает персону со ссылками на существующие имена/фамилии
4. В БД:
   - **НЕ создано** новых записей в gen_name для имени "Иван" (переиспользовано)
   - **НЕ создано** новых записей в gen_name для отчества "Петрович" (переиспользовано)
   - **НЕ создано** новых записей в gen_surname для фамилии "Сидоров" (переиспользовано)
   - **Создана** новая запись в gen_surname для английской фамилии "Sidorov"
   - **Создана** новая персона в gen_person со ссылками на имена/фамилии

**Постусловия:**

- Система экономит место в БД, переиспользуя существующие имена/фамилии
- Нет дубликатов имен/фамилий в таблицах gen_name и gen_surname
- Связь между персонами через общие имена/фамилии

---

## Риски

### Риск 1. Сложность многоязычной формы для пользователя

**Описание:**
Форма с полями для двух языков может быть перегружена и сложна для понимания нетехнического пользователя.

**Вероятность:** Средняя

**Влияние:** Среднее (плохой UX, пользователь может отказаться от использования)

**Меры снижения:**

- Разделить форму на визуальные секции (аккордеоны или табы)
- Использовать подсказки (tooltip) и плейсхолдеры для объяснения полей
- Провести usability-тестирование с нетехническими пользователями
- Добавить кнопку "Помощь" с объяснением полей и примерами заполнения

**План реагирования:**

- Если пользователи испытывают трудности — упростить форму (например, скрыть английские поля в аккордеон "Перевод на английский")
- Добавить видео-инструкцию по заполнению формы

---

### Риск 2. Дублирование имен и фамилий в БД

**Описание:**
Если логика переиспользования имен/фамилий работает некорректно, в БД могут появиться дубликаты (например, "Иван" с разными ID).

**Вероятность:** Средняя (ошибка в логике поиска)

**Влияние:** Низкое (данные остаются корректными, но неоптимальны)

**Меры снижения:**

- Использовать точный поиск существующих имен через `NameRepository::findByName()` (поиск по тексту и userId)
- Поиск должен быть чувствителен к регистру
- Покрыть тестами логику переиспользования имен/фамилий
- На будущих этапах можно добавить дедупликацию через команду

**План реагирования:**

- Если обнаружены дубликаты — создать команду для слияния дублирующих имен
- Добавить уникальный индекс на поля FNAME+LANG+USER_ID в gen_name_lang

---

### Риск 3. Производительность autocomplete на больших объемах

**Описание:**
Если у пользователя тысячи имен, autocomplete может работать медленно (более 0.5 сек).

**Вероятность:** Низкая (для учебного проекта)

**Влияние:** Среднее (плохой UX)

**Меры снижения:**

- Использовать индексы на поля FNAME и SNAME в таблицах gen_name_lang и gen_surname_lang
- Ограничить результаты autocomplete (максимум 10)
- Добавить дебаунс (задержка 300 мс перед запросом) для снижения нагрузки
- Измерить производительность на тестовых данных (1000+ имен)

**План реагирования:**

- Если autocomplete медленный — добавить кеширование популярных имен в Redis
- Использовать пагинацию в autocomplete (загружать по 10 результатов по требованию)

---

### Риск 4. Потеря данных при ошибке сохранения

**Описание:**
Если транзакция откатывается из-за ошибки, персона не сохранится, но пользователь потеряет введенные данные.

**Вероятность:** Низкая

**Влияние:** Высокое (плохой UX, потеря работы пользователя)

**Меры снижения:**

- При ошибке валидации — вернуть форму с сохраненными данными (Laravel old() helper)
- При ошибке сохранения — показать понятное сообщение об ошибке и вернуть форму с данными
- Логировать ошибки сохранения в audit_logs для диагностики

**План реагирования:**

- Если ошибка повторяется — добавить автосохранение формы в localStorage (JavaScript)
- Восстановить данные из localStorage при повторном открытии формы

---

### Риск 5. Некорректная автогенерация гендерных форм фамилий

**Описание:**
Автоподстановка гендерных форм фамилий может работать некорректно для нестандартных фамилий (например, иностранных: Smith, Brown).

**Вероятность:** Средняя

**Влияние:** Низкое (пользователь может исправить вручную)

**Меры снижения:**

- Автоподстановка работает только для русских фамилий с типичными окончаниями (-ов, -ев, -ин, -ский, -кий)
- Для нестандартных фамилий — копировать мужскую форму
- Пользователь ВСЕГДА может изменить автозаполненное значение вручную
- Добавить подсказку: "Проверьте корректность автозаполненных форм"

**План реагирования:**

- Если пользователи жалуются — улучшить алгоритм автоподстановки (добавить больше правил)
- На будущих этапах можно добавить справочник фамилий с предопределенными формами

---

## Критерии приемки

Задача считается завершенной, если выполнены **все** следующие критерии:

### Критерии по функциональности создания

- ✅ Доступна форма создания персоны по адресу `GET /persons/create`
- ✅ Форма содержит все разделы и поля согласно FR-2
- ✅ Обязательные поля визуально помечены звездочкой (*)
- ✅ Autocomplete работает для имен и фамилий (API FR-3)
- ✅ Автогенерация отчеств работает при выборе отца из списка
- ✅ Автоподстановка гендерных форм фамилий работает при вводе мужской формы
- ✅ Раздел "Девичья фамилия" отображается только при выборе пола = Женский
- ✅ Пользователь может изменить автозаполненные значения вручную
- ✅ Валидация работает корректно, показывает понятные сообщения об ошибках (FR-5)
- ✅ После создания — редирект на карточку персоны с flash-сообщением
- ✅ Операция логируется в audit_logs

### Критерии по валидации

- ✅ Обязательные поля валидируются (пол, имя ru/en, фамилия ru/en - обе формы)
- ✅ Необязательные поля валидируются (отчество, даты, девичья фамилия, информация)
- ✅ Бизнес-правила валидации работают:
  - Девичья фамилия только для женщин
  - Дата смерти не раньше даты рождения
  - Дата рождения не в будущем
  - Если указана дата смерти, дата рождения обязательна
- ✅ Сообщения об ошибках понятны и информативны
- ✅ При ошибке валидации форма возвращается с сохраненными данными

### Критерии по многоязычности

- ✅ Система переиспользует существующие имена/фамилии через поиск по тексту и userId
- ✅ Создаются новые имена/фамилии только если не найдены существующие
- ✅ Autocomplete API возвращает результаты менее чем за 0.5 секунды на 1000 имен
- ✅ Автогенерация отчеств работает корректно (Иван → Иванович/Ивановна)
- ✅ Автоподстановка гендерных форм работает корректно (Петров → Петрова)

### Критерии по навигации

- ✅ На странице списка персон есть кнопка "Добавить персону"
- ✅ Кнопка визуально заметна и понятна
- ✅ Все ссылки сохраняют текущий язык интерфейса (`?lang={lang}`)
- ✅ Flash-сообщение отображается после успешного создания
- ✅ Flash-сообщение автоматически исчезает через 5 секунд

### Критерии по безопасности

- ✅ Все операции выполняются от имени тестового пользователя (ID=1)
- ✅ Справочные данные (имена, фамилии, родители) отфильтрованы по userId
- ✅ Операция создания выполняется в транзакции БД
- ✅ Нет SQL-инъекций (параметризованные запросы)
- ✅ Нет XSS-уязвимостей (экранирование в Blade)
- ✅ CSRF-защита включена в форме

### Критерии по аудиту

- ✅ Создание персоны логируется в audit_logs
- ✅ Лог содержит: user_id, action (person.created), entity_type (Person), entity_id, old_value (null), new_value (данные персоны), created_at

### Критерии по тестам

- ✅ Написаны E2E тесты для создания персоны с полными многоязычными данными (UC-1)
- ✅ Тесты проверяют создание персоны с минимальным набором данных (UC-2)
- ✅ Тесты проверяют валидацию обязательных полей
- ✅ Тесты проверяют валидацию бизнес-правил (девичья фамилия, даты)
- ✅ Тесты проверяют автогенерацию отчеств
- ✅ Тесты проверяют автоподстановку гендерных форм
- ✅ Тесты проверяют переиспользование существующих имен/фамилий (UC-5)
- ✅ Тесты проверяют логирование в audit_logs

### Критерии по коду

- ✅ Код соответствует стилю проекта (/.ai/Rule/CodeStyle.md)
- ✅ Код проходит статический анализ PHPStan без ошибок
- ✅ Код проходит проверку PHP_CodeSniffer без ошибок
- ✅ Контроллеры используют репозитории (не работают с БД напрямую)
- ✅ Операция создания выполняется в транзакции БД

---

## Не входит в реализацию

Следующие функции **НЕ входят** в реализацию текущей задачи:

### Не входит в TZ1_04_1

- ❌ **Редактирование существующей персоны** — будет реализовано в задаче TZ1_04_2
- ❌ **Удаление персоны** — будет реализовано в задаче TZ1_04_3
- ❌ **Управление связями (создание/удаление)** — будет реализовано на Stage 5
- ❌ **Авторизация и аутентификация** — будет реализована на Stage 7
- ❌ **Массовое создание персон** — не входит в эпик TZ1
- ❌ **Импорт персон из файлов (GEDCOM, CSV)** — не входит в эпик TZ1
- ❌ **Загрузка фотографий персон** — не входит в эпик TZ1
- ❌ **История изменений персоны (версионирование)** — не входит в эпик TZ1
- ❌ **Отмена создания (undo)** — может быть добавлена на Stage 7

### Допущения текущей задачи

На текущей задаче допускаются следующие упрощения:

- ✅ **Один тестовый пользователь** — авторизация будет на Stage 7
- ✅ **Возможны дубликаты имен/фамилий** — дедупликация может быть добавлена позже
- ✅ **Минимальный дизайн формы** — улучшение UX будет на Stage 6
- ✅ **Нет автосохранения формы** — может быть добавлено на Stage 7

---

## Дополнительные замечания

### Важные особенности реализации

1. **Многоязычность критична:** Форма должна корректно работать с двумя языками одновременно, сохраняя все переводы в БД.

2. **Автозаполнение упрощает ввод:** Автогенерация отчеств и автоподстановка гендерных форм значительно упрощают работу пользователя.

3. **Переиспользование имен экономит место:** Важно использовать `NameRepository::findByName()` и `SurnameRepository::findBySurname()` перед созданием новых записей.

4. **Транзакционность обязательна:** Без транзакций возможны частично сохраненные данные (имя создано, но персона не сохранилась).

5. **Аудит для истории:** Логирование в audit_logs позволит отследить, кто и когда создал персону.

### Рекомендации по реализации

1. **Начать с маршрутов и контроллеров:** Создать базовую структуру контроллера PersonController с методами create и store.

2. **Использовать Blade-компоненты:** Создать переиспользуемые компоненты для полей имен/фамилий, чтобы избежать дублирования кода.

3. **JavaScript для динамического поведения:** Использовать Alpine.js или Vue.js для автозаполнения, autocomplete, показа/скрытия разделов.

4. **Тестировать на реальных данных:** Использовать существующие данные из БД для проверки корректности переиспользования имен/фамилий.

5. **Логировать детально:** В audit_logs сохранять полное имя, даты, пол для возможности восстановления.

---

## Глоссарий

- **Autocomplete** — автодополнение, подсказки при вводе текста
- **Гендерная форма** — разная форма слова для мужчин и женщин (Петров/Петрова, Иванович/Ивановна)
- **Девичья фамилия** — фамилия женщины до замужества
- **Автогенерация отчеств** — создание отчества из имени отца (Иван → Иванович/Ивановна)
- **Автоподстановка** — автоматическое заполнение поля на основе других данных
- **Flash-сообщение** — временное уведомление пользователю о результате операции
- **Аудит (audit log)** — журнал всех действий пользователя для отслеживания истории
- **Транзакция БД** — группа операций, которые выполняются вместе (все или ничего)
- **Валидация** — проверка корректности введенных данных
- **Тестовый пользователь** — первый пользователь из БД (ID=1), используемый до реализации авторизации
- **Переиспользование** — использование существующей записи БД вместо создания новой
- **Clean Architecture** — архитектурный подход с разделением на слои (Domain, Application, Infrastructure, Presentation)
- **CQRS** — паттерн разделения команд (изменение данных) и запросов (чтение данных)
- **Repository** — паттерн для работы с хранилищем данных (абстракция над БД)

---

**Конец спецификации TZ1_04_1**
