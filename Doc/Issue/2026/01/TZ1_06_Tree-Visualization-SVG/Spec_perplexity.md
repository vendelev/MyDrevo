# Спецификация: Минимальная визуализация дерева и улучшение UX

## Описание AI

Этот документ создан через https://www.perplexity.ai/search/sozdai-spetsifikatsiiu-dlia-st-3WAYqQZ7SWGoCL5Qwz2BZA#0
Модель: Claude Sonnet 4.5 без рассуждений

## Описание проблемы/потребности

В текущей версии системы пользователь может просматривать генеалогическое дерево только в виде списка персон и их связей. Это затрудняет восприятие структуры семейных отношений и навигацию между родственниками. Для улучшения пользовательского опыта необходимо добавить визуальное представление дерева в виде графической схемы, где родственные связи будут отображаться наглядно.

Визуализация должна быть простой и понятной, не перегружать пользователя избыточной информацией, но при этом позволять быстро ориентироваться в структуре семейных связей и переходить между разными персонами.

## Функциональные требования

### Визуализация дерева

1. Система должна предоставлять страницу «Дерево», где отображается визуальная схема генеалогического дерева
2. Технология визуализации: серверный рендер с использованием SVG
3. Визуализация должна отображать древовидную структуру, где иерархия «родитель → ребёнок» читается визуально
4. Узлы (персоны) отображаются как отдельные графические элементы с указанием имени персоны
5. Между узлами отображаются линии связей, показывающие родственные отношения

### Интерактивность и навигация

1. Выбранная персона отображается в центре визуализации
2. Вокруг выбранной персоны отображаются ближайшие связи: родители, дети, супруги (1 уровень)
3. При клике на узел (персону) происходит переход к просмотру дерева с этой персоной в центре
4. Схема перестраивается вокруг новой выбранной персоны
5. Пользователь может выбрать «корневую» персону для просмотра дерева
6. Выбранная персона сохраняется в URL при обновлении страницы (например, `?personId=123`)

### Обработка граничных случаев

1. **Превышение лимита узлов:**
   - Если для отображения требуется более 50 узлов, система отображает первые 50 узлов
   - При превышении лимита показывается сообщение: "Дерево слишком большое, отображены первые 50 узлов"

2. **Невалидный personId в URL:**
   - Если персона с указанным ID не найдена, система отображает корень дерева (дефолтную корневую персону)
   - При ошибке показывается сообщение: "Персона не найдена"

3. **Пустое дерево:**
   - Если в системе нет ни одной персоны, отображается сообщение о необходимости добавить первого человека

## Нефункциональные требования

### Производительность

1. Время генерации SVG-схемы не должно превышать 2 секунд для дерева до 50 узлов
2. Максимальное количество узлов на схеме ограничено 50 для обеспечения читаемости и производительности
3. Глубина отображения ограничена 1 уровнем вокруг выбранной персоны

### Юзабилити

1. Интерфейс должен быть понятным и не перегруженным
2. Схема должна быть читаемой: размер узлов и шрифтов должен обеспечивать комфортное восприятие
3. Линии связей не должны пересекаться без необходимости
4. Визуальное выделение текущей (центральной) персоны от остальных узлов

### Адаптивность

1. Базовая адаптивность для экранов ноутбука (разрешение от 1366x768)
2. Базовая адаптивность для мобильных устройств (разрешение от 375x667)
3. Возможность горизонтальной и вертикальной прокрутки для больших схем

### Безопасность

1. Валидация параметра `personId` из URL для предотвращения SQL-инъекций
2. Проверка прав доступа пользователя к просматриваемым персонам (если реализована система авторизации)

## Доменная модель

### Существующие Entity

- **Person** (Персона) — основная сущность, представляющая человека в генеалогическом дереве
  - ID: уникальный идентификатор
  - FullName: полное имя персоны
  - BirthDate: дата рождения (опционально)
  - DeathDate: дата смерти (опционально)

- **Relationship** (Связь) — связь между двумя персонами
  - ID: уникальный идентификатор
  - PersonId1: ID первой персоны
  - PersonId2: ID второй персоны
  - RelationType: тип связи (родитель-ребёнок, супруги)

### Новые ValueObject

- **TreeNode** (Узел дерева) — представление персоны для визуализации
  - PersonId: ID персоны
  - DisplayName: имя для отображения
  - X: координата X на схеме
  - Y: координата Y на схеме
  - IsCenter: флаг центральной персоны

- **TreeEdge** (Ребро дерева) — представление связи для визуализации
  - FromNodeId: ID исходного узла
  - ToNodeId: ID целевого узла
  - RelationType: тип связи
  - Path: SVG-путь для отрисовки линии

- **TreeLayout** (Раскладка дерева) — результат расчёта позиций узлов
  - Nodes: коллекция узлов (TreeNode)
  - Edges: коллекция рёбер (TreeEdge)
  - Width: ширина схемы
  - Height: высота схемы
  - CenterNodeId: ID центрального узла

## Зависимости

### Внутренние зависимости

1. **Модуль Person:** требуется доступ к данным персон (чтение имён, дат, идентификаторов)
2. **Модуль Relationship:** требуется доступ к данным о связях между персонами для построения дерева
3. **Этап 4:** должны быть реализованы управление связями и корректное хранение данных о родственных отношениях

### Внешние зависимости

1. **SVG-библиотека:** для серверного рендеринга может потребоваться библиотека для генерации SVG (например, встроенные средства PHP или специализированная библиотека)
2. **Алгоритм компоновки графа:** может потребоваться реализация или использование готового алгоритма для расчёта позиций узлов (например, алгоритм Sugiyama для иерархических графов)

## Сценарии использования

### UC-1: Просмотр визуального дерева

**Участник:** Пользователь

**Предусловие:** В системе есть хотя бы одна персона с данными

**Основной сценарий:**

1. Пользователь переходит в раздел «Дерево»
2. Система определяет корневую персону (первая добавленная или указанная по умолчанию)
3. Система загружает данные персоны и её ближайшего окружения (родители, дети, супруги)
4. Система рассчитывает позиции узлов и связей
5. Система генерирует SVG-схему с отображением персон и связей
6. Пользователь видит визуальную схему дерева с выбранной персоной в центре

**Результат:** Пользователь видит наглядное представление структуры семейных связей

### UC-2: Навигация по дереву

**Участник:** Пользователь

**Предусловие:** Пользователь находится на странице визуализации дерева

**Основной сценарий:**

1. Пользователь видит схему дерева с центральной персоной
2. Пользователь нажимает на узел родственника
3. Система фиксирует выбор и обновляет URL с новым `personId`
4. Система перезагружает страницу с новой центральной персоной
5. Схема перестраивается вокруг выбранной персоны
6. Пользователь видит обновлённую схему дерева

**Результат:** Пользователь может исследовать дерево, переходя от персоны к персоне

### UC-3: Обработка большого дерева

**Участник:** Пользователь

**Предусловие:** У выбранной персоны более 50 родственников в пределах одного уровня

**Основной сценарий:**

1. Пользователь открывает страницу «Дерево» или переходит к персоне с большим количеством связей
2. Система определяет, что количество узлов превышает 50
3. Система отбирает первые 50 узлов для отображения (например, по приоритету: родители, супруги, дети)
4. Система генерирует схему с ограниченным набором узлов
5. Система отображает сообщение: "Дерево слишком большое, отображены первые 50 узлов"
6. Пользователь видит частичную схему дерева с предупреждением

**Результат:** Система корректно обрабатывает большие деревья, не перегружая интерфейс

### UC-4: Обработка невалидного ID

**Участник:** Пользователь

**Предусловие:** Пользователь переходит по ссылке с несуществующим `personId` в URL

**Основной сценарий:**

1. Пользователь переходит по URL с параметром `?personId=999` (несуществующий ID)
2. Система пытается загрузить персону с ID 999
3. Система обнаруживает, что персона не найдена
4. Система определяет корневую персону по умолчанию
5. Система отображает дерево с корневой персоной
6. Система показывает сообщение: "Персона не найдена"

**Результат:** Пользователь видит дерево, несмотря на ошибку в URL

### UC-5: Демонстрация заинтересованному лицу

**Участник:** Стейкхолдер/Заказчик

**Предусловие:** В системе есть тестовые данные с несколькими персонами и связями

**Основной сценарий:**

1. Стейкхолдер открывает раздел «Дерево»
2. Стейкхолдер видит визуальную схему семейных связей
3. Стейкхолдер кликает по разным персонам и наблюдает перестроение дерева
4. Стейкхолдер оценивает наглядность и удобство интерфейса
5. Стейкхолдер принимает решение о готовности продукта к демонстрации

**Результат:** Продукт становится визуально демонстрируемым и понятным

## Риски

### Технические риски

1. **Сложность реализации алгоритма раскладки:**
   - Расчёт оптимальных позиций узлов и рёбер может потребовать значительных усилий
   - Минимизация: использование готовых алгоритмов или библиотек

2. **Производительность при большом количестве связей:**
   - Расчёт и генерация SVG для сложных деревьев может занимать много времени
   - Минимизация: ограничение количества узлов (50) и уровня глубины (1)

3. **Сложности с SVG на мобильных устройствах:**
   - Интерактивность и масштабирование SVG на мобильных могут работать нестабильно
   - Минимизация: тестирование на реальных устройствах, упрощённый интерфейс для мобильных

### Бизнес-риски

1. **Недостаточная наглядность простой схемы:**
   - Пользователи могут посчитать визуализацию слишком примитивной
   - Минимизация: фокус на функциональности и удобстве навигации, возможность улучшения в будущем

2. **Ограничения по глубине могут не устроить пользователей:**
   - Отображение только 1 уровня связей может быть недостаточным для некоторых сценариев
   - Минимизация: чёткое объяснение ограничений, возможность навигации по дереву для просмотра других уровней

## Критерии приёмки

1. ✅ Реализована страница «Дерево» с визуальной схемой генеалогического дерева
2. ✅ Визуализация использует серверный рендер с SVG
3. ✅ На схеме отображаются узлы (персоны) с именами и линии связей между ними
4. ✅ Реализована древовидная структура с визуально читаемой иерархией «родитель → ребёнок»
5. ✅ Выбранная персона отображается в центре схемы
6. ✅ Вокруг центральной персоны отображаются ближайшие связи (родители, дети, супруги) — 1 уровень
7. ✅ Реализована возможность клика по узлу для перехода к другой персоне
8. ✅ При клике схема перестраивается вокруг новой выбранной персоны
9. ✅ Выбранная персона сохраняется в URL через параметр `personId`
10. ✅ При обновлении страницы отображается персона из URL
11. ✅ При превышении 50 узлов система отображает первые 50 и показывает сообщение "Дерево слишком большое, отображены первые 50 узлов"
12. ✅ При невалидном `personId` в URL система отображает корневую персону и показывает сообщение "Персона не найдена"
13. ✅ Визуализация корректно работает на тестовых данных
14. ✅ Интерфейс адаптирован для экранов ноутбука (от 1366x768)
15. ✅ Интерфейс адаптирован для мобильных устройств (от 375x667)
16. ✅ Визуализация не ломается при граничных случаях (пустое дерево, одна персона, циклические связи)
17. ✅ Написаны автоматические тесты для основных сценариев использования
18. ✅ Проведено ручное тестирование на разных типах деревьев (линейное, ветвистое, с супругами)

## Что НЕ входит в реализацию

### Функциональность, выходящая за рамки этапа

1. **Расширенная визуализация:**
   - Отображение фотографий персон на узлах
   - Отображение дополнительной информации (даты рождения, места) на схеме
   - Цветовое кодирование узлов по полу, возрасту или другим критериям

2. **Продвинутая навигация:**
   - Отображение более 1 уровня связей вокруг персоны
   - Zoom и pan (масштабирование и перемещение) схемы
   - Полноэкранный режим визуализации

3. **Интерактивность:**
   - Редактирование связей непосредственно на схеме (drag-and-drop)
   - Контекстное меню на узлах для быстрых действий
   - Анимированные переходы между персонами

4. **Экспорт и печать:**
   - Экспорт схемы в PDF, PNG или другие форматы
   - Печать дерева с оптимизацией для бумажного носителя

5. **Альтернативные виды:**
   - Отображение дерева в виде фанчарта (веерная диаграмма)
   - Отображение дерева в виде временной шкалы
   - Отображение дерева в виде списка с отступами (TreeView)

6. **Расширенные фильтры:**
   - Фильтрация узлов по дате рождения, месту, полу
   - Поиск персоны на схеме с автоматическим переходом

7. **Статистика и аналитика:**
   - Отображение статистики дерева (количество поколений, средний возраст и т.д.)
   - Визуализация распределения персон по различным критериям

### Ограничения текущей реализации

1. Максимум 50 узлов на схеме
2. Только 1 уровень глубины вокруг выбранной персоны
3. Только серверный рендеринг (без клиентской интерактивности через JavaScript)
4. Базовая адаптивность (без полной оптимизации для всех устройств)
5. Простое оформление узлов и связей (без продвинутого дизайна)
