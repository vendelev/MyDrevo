# План тестирования: Импорт структуры базы данных из MySQL в SQLite

## 1. Цель тестирования

Обеспечить корректность и надежность миграции базы данных из MySQL-формата в SQLite. Проверить соответствие созданных таблиц исходной структуре, работоспособность всех ограничений и индексов, а также идемпотентность миграции.

## 2. Стратегия тестирования

Тестирование будет проводиться по принципу "черного ящика" с фокусом на проверку результата миграции. Используются unit-тесты для проверки отдельных аспектов и integration-тесты для проверки комплексного поведения. Соответствует стратегии тестирования в архитектуре проекта ([Architecture.md](/Doc/Rule/Architecture.md)).

## 3. Тестовые окружения

- **Тестовое окружение 1**: Чистая база данных SQLite (для проверки первоначального применения миграции)
- **Тестовое окружение 2**: База данных после применения миграции (для проверки идемпотентности)
- **Тестовое окружение 3**: База данных с частично примененной миграцией (для проверки обработки ошибок)

## 4. План тестирования

### 4.1. Подготовка тестовых данных

1. Создать копию исходного файла `backend/database/migrations/structure.sql`
2. Создать тестовую базу данных SQLite для каждого тестового окружения
3. Настроить подключение к тестовой базе данных в `backend/.env.testing`

### 4.2. Тесты структуры базы данных

#### Тест 1: Проверка создания таблиц
- **Цель**: Убедиться, что все таблицы из исходной структуры созданы
- **Шаги**:
  1. Применить миграцию к чистой базе данных
  2. Проверить наличие всех таблиц:
     - `gen_user`
     - `gen_person`
     - `gen_name`, `gen_name_lang`
     - `gen_surname`, `gen_surname_lang`
     - `gen_relation`
     - `gen_menu`
     - `gen_message`, `gen_message_text`
     - `gen_user_right`
- **Ожидаемый результат**: Все таблицы существуют в базе данных

#### Тест 2: Проверка структуры таблиц
- **Цель**: Убедиться, что структура каждой таблицы соответствует исходной
- **Шаги**:
  1. Для каждой таблицы получить список колонок
  2. Сравнить с ожидаемой структурой из `structure.sql`
  3. Проверить типы данных, названия колонок, ограничения
- **Ожидаемый результат**: Структура всех таблиц соответствует исходной

#### Тест 3: Проверка первичных ключей
- **Цель**: Убедиться, что все первичные ключи корректно созданы
- **Шаги**:
  1. Проверить наличие `PRIMARY KEY` для каждой таблицы
  2. Убедиться, что первичные ключи имеют автоинкремент (где необходимо)
- **Ожидаемый результат**: Все первичные ключи существуют и работают корректно

#### Тест 4: Проверка уникальных ограничений
- **Цель**: Убедиться, что все уникальные ограничения перенесены
- **Шаги**:
  1. Попытаться вставить дублирующие записи в поля с `UNIQUE` ограничением
  2. Проверить, что операция завершается с ошибкой
- **Ожидаемый результат**: Вставка дублирующих записей отклоняется с ошибкой уникальности

#### Тест 5: Проверка внешних ключей
- **Цель**: Убедиться, что все внешние ключи работают корректно
- **Шаги**:
  1. Включить поддержку внешних ключей: `PRAGMA foreign_keys = ON;`
  2. Попытаться вставить запись с несуществующим внешним ключом
  3. Проверить, что операция завершается с ошибкой
  4. Попытаться удалить запись, на которую ссылаются другие таблицы
  5. Проверить поведение при удалении (CASCADE/RESTRICT)
- **Ожидаемый результат**: Внешние ключи работают корректно, обеспечивают целостность данных

#### Тест 6: Проверка индексов
- **Цель**: Убедиться, что все необходимые индексы созданы
- **Шаги**:
  1. Получить список индексов для каждой таблицы
  2. Сравнить с ожидаемыми индексами из `structure.sql`
- **Ожидаемый результат**: Все необходимые индексы существуют

### 4.3. Тесты миграции

#### Тест 7: Проверка идемпотентности
- **Цель**: Убедиться, что миграция может быть применена несколько раз без ошибок
- **Шаги**:
  1. Применить миграцию к базе данных, где она уже была применена
  2. Проверить, что операция завершается успешно
- **Ожидаемый результат**: Миграция не пытается повторно создать существующие таблицы

#### Тест 8: Проверка отката миграции
- **Цель**: Убедиться, что миграция может быть отменена
- **Шаги**:
  1. Применить миграцию
  2. Выполнить откат: `php artisan migrate:rollback`
  3. Проверить, что все таблицы удалены
- **Ожидаемый результат**: Все таблицы, созданные миграцией, удалены

#### Тест 9: Проверка порядка выполнения
- **Цель**: Убедиться, что миграция выполняется в правильном порядке
- **Шаги**:
  1. Создать дополнительную миграцию, зависящую от таблиц из этой миграции
  2. Попытаться применить миграции
  3. Проверить порядок выполнения
- **Ожидаемый результат**: Миграция импорта выполняется до зависимых миграций

### 4.4. Производительность

#### Тест 10: Проверка времени выполнения
- **Цель**: Убедиться, что миграция выполняется за приемлемое время
- **Шаги**:
  1. Замерить время выполнения миграции на чистой базе данных
  2. Повторить измерение 5 раз
- **Ожидаемый результат**: Среднее время выполнения менее 5 секунд

## 5. Инструменты тестирования

- **PHPUnit**: Основной фреймворк для написания тестов
- **Laravel Testing**: Встроенные возможности Laravel для тестирования
- **SQLite**: Тестовая база данных
- **PHPStan**: Статический анализ кода миграции
- **PHP_CodeSniffer**: Проверка соответствия стилю кодирования

## 6. Критерии приемки тестов

1. Все unit-тесты проходят успешно
2. Все integration-тесты проходят успешно
3. Покрытие кода миграции тестами не менее 90%
4. Время выполнения тестов не превышает 2 минут
5. Нет предупреждений от PHPStan и PHP_CodeSniffer

## 7. План выполнения тестирования

1. Настроить тестовое окружение
2. Запустить unit-тесты
3. Запустить integration-тесты
4. Проверить покрытие кода
5. Провести статический анализ
6. Зафиксировать результаты тестирования
7. Подготовить отчет о тестировании

## 8. Отчет о тестировании

Отчет должен содержать:
- Статус выполнения каждого теста (пройден/не пройден)
- Время выполнения тестов
- Покрытие кода
- Обнаруженные дефекты
- Рекомендации по улучшению

## 9. Зависимости

- Наличие файла `backend/database/migrations/structure.sql`
- Работоспособность системы тестирования Laravel
- Доступ к тестовой базе данных SQLite
- Наличие инструментов статического анализа

## 10. Команды для запуска тестов

```bash
# Запуск всех тестов
make php-run CMD="php artisan test"

# Запуск только unit-тестов
make php-run CMD="php artisan test" --group=unit

# Запуск только integration-тестов
make php-run CMD="php artisan test" --group=integration

# Проверка покрытия кода
make php-run CMD="php artisan test" --coverage

# Статический анализ кода
make php-run CMD="vendor/bin/phpstan analyse"
make php-run CMD="vendor/bin/phpcs"
