# Спецификация: Визуализация семейного дерева (Этап 3)

## Описание проблемы/потребности

После реализации управления профилями и связями (Этап 2), данные о семье хранятся в структурированном виде, но их трудно воспринимать в виде списков. Основная ценность генеалогического сервиса заключается в наглядном представлении родственных связей.

Данная функциональность решает задачу визуализации накопленных данных в виде интерактивного графа (дерева), что позволяет пользователям видеть "общую картину" своей родословной, легко перемещаться между поколениями и быстро получать доступ к информации о родственниках.

## Функциональные требования

1.  **Генерация данных для дерева (Backend API):**
    *   Эндпоинт для получения структуры дерева для конкретного пользователя/персоны.
    *   Поддержка рекурсивного сбора данных о предках и потомках.
    *   Включение базовой информации в ответ API: ФИО, годы жизни, пол, тип связи, ссылка на фото (если есть).
2.  **Визуальное представление (Frontend):**
    *   Отображение узлов (персон) и ребер (связей).
    *   Различение типов связей (прямая линия для родитель-ребенок, горизонтальная для брака).
    *   Визуальная индикация пола (например, цветом или иконкой).
3.  **Интерактивность и навигация:**
    *   Масштабирование (Zoom in/out) и перемещение (Pan) холста.
    *   Центрирование дерева на выбранной персоне.
    *   "Клик" по узлу: отображение краткой карточки-превью с основной информацией.
    *   Переход к полному профилю персоны из карточки-превью.
4.  **Форматы отображения:**
    *   Переключение между вертикальным (предки сверху, потомки снизу) и горизонтальным режимами.
5.  **Оптимизация:**
    *   Ленивая загрузка или эффективная отрисовка для деревьев с количеством узлов > 100.
    *   Минимизация пересечений линий связей.

## Нефункциональные требования

1.  **Производительность:**
    *   Время формирования JSON-ответа API для дерева из 100 персон не более 200 мс.
    *   Плавность анимации при перемещении и масштабировании (60 FPS).
2.  **Usability:**
    *   Интуитивно понятное управление (мышь, тач-жесты).
    *   Адаптивность: корректное отображение на мобильных устройствах (скрытие второстепенных элементов, удобный Zoom).
3.  **Доступность:** Контрастное отображение текста и связей.

## Модель предметной области

### Сущности (Entities)

1.  **FamilyTree (Семейное дерево):** Агрегат, представляющий структуру связей для визуализации.
2.  **TreeNode (Узел дерева):**
    *   `id`: `FamilyMemberId` (соответствует `gen_person.ID`).
    *   `label`: String (ФИО, собирается из `gen_name_lang` и `gen_surname_lang`).
    *   `gender`: `Gender` (определяется по `gen_name_lang.MALE_ID` или связанным полям).
    *   `lifePeriod`: `LifePeriod` (на основе `gen_person.BDATE` и `gen_person.DDATE`).
    *   `photoUrl`: String (ссылка на превью фото).
3.  **TreeEdge (Связь в дереве):**
    *   `source`: `FamilyMemberId` (соответствует `gen_relation.PID1`).
    *   `target`: `FamilyMemberId` (соответствует `gen_relation.PID2`).
    *   `relationType`: `RelationType` (на основе `gen_relation.RELATION_TYPE_ID`).

### Объекты-значения (Value Objects)

1.  **TreeLayout:** Параметры расположения узлов (координаты X, Y), вычисляемые алгоритмом визуализации на стороне клиента.
2.  **TreeConfiguration:** Настройки отображения (ориентация, глубина вложенности).

## Технические детали (API)

### API Эндпоинты
- `GET /api/v1/family-tree/{root_id}` — Получение структуры дерева, начиная от указанной персоны.
    *   Параметры: `depth` (глубина вложенности), `direction` (up/down/both).

### Формат ответа (пример)
```json
{
  "nodes": [
    {"id": "uuid-1", "name": "Иван Иванов", "gender": "male", "life_period": "1950-2010"},
    {"id": "uuid-2", "name": "Мария Иванова", "gender": "female", "life_period": "1955-н.в."}
  ],
  "links": [
    {"source": "uuid-1", "target": "uuid-3", "type": "parent-child"}
  ]
}
```

## Зависимости

1.  **Family Member Module (S2):** Источник данных о персонах и их связях.
2.  **Graph Library (Frontend):** Использование специализированной библиотеки (например, D3.js, Cytoscape.js или React Flow) для отрисовки графа.
3.  **Auth Module:** Проверка прав на просмотр дерева конкретной семьи.

## Сценарии использования

### Сценарий 1: Просмотр родословной
**Актер:** Пользователь.
1. Пользователь переходит в раздел "Мое дерево".
2. Система запрашивает данные через API для текущего пользователя.
3. На экране отрисовывается граф, где пользователь находится в центре.
4. Пользователь колесиком мыши отдаляет дерево, чтобы увидеть всех предков до 4-го колена.

### Сценарий 2: Изучение информации о родственнике
**Актер:** Пользователь.
1. Пользователь находит в дереве узел своего прадеда.
2. Кликает на узел.
3. Сбоку или над узлом появляется всплывающее окно с фото, датами жизни и краткой биографией.
4. Пользователь нажимает "Подробнее" и переходит на страницу полного профиля.

### Сценарий 3: Смена ориентации дерева
**Актер:** Пользователь.
1. Пользователь нажимает кнопку "Сменить ориентацию".
2. Дерево плавно перестраивается из вертикального вида в горизонтальный (слева направо).

## Риски

1.  **Сложные графы:** При наличии множественных браков, перекрестных связей или инбридинга алгоритм автоматической раскладки может создавать "кашу" из линий.
2.  **Производительность клиента:** Большие деревья (500+ человек) могут тормозить браузер при отрисовке через SVG. Возможно, потребуется Canvas.
3.  **Конфиденциальность:** Риск отображения данных живых родственников, если настройки приватности не будут учтены в API дерева.

## Критерии приемки

1.  **Backend API:**
    *   Эндпоинт `GET /api/v1/family-tree/{root_id}` возвращает валидный JSON со списками `nodes` и `links`.
    *   API корректно обрабатывает параметр `depth` (ограничение глубины рекурсии).
    *   API возвращает 404, если `root_id` не найден.
    *   API возвращает 403, если у пользователя нет прав на просмотр дерева этой семьи.
2.  **Визуализация:**
    *   Дерево отрисовывается корректно (узлы и линии связей).
    *   Разные типы связей (родитель-ребенок, брак) визуально различимы.
    *   Пол персоны визуально идентифицируется (цвет/иконка).
3.  **Интерактивность:**
    *   Работает Zoom (колесико/жесты) и Pan (перетаскивание холста).
    *   При клике на узел открывается превью-карточка с ФИО, фото и годами жизни.
    *   Кнопка "Подробнее" в карточке ведет на страницу профиля `/family-members/{id}`.
4.  **Режимы:**
    *   Переключатель "Вертикальный/Горизонтальный" корректно перестраивает граф.
5.  **Производительность:**
    *   Дерево на 100 узлов отрисовывается и масштабируется без видимых задержек (60 FPS).

## Не входит в реализацию

1.  Редактирование связей прямо на графе (Drag-and-drop для изменения родителей) — только просмотр.
2.  Экспорт дерева в PDF/PNG (будет в будущих этапах).
3.  Анимированные переходы при изменении данных (только базовая перерисовка).
4.  Сложные фильтры (например, "показать только ветку по материнской линии").
