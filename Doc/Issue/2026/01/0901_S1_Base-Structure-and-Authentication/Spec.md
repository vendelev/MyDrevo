# Спецификация: Базовая структура и аутентификация

## Описание проблемы/потребности

Для разработки сайта генеалогического древа необходимо заложить фундамент приложения.
Потребность: создать базовый каркас Laravel, настроить SQLite и реализовать web-аутентификацию
(регистрация, вход, выход) для защиты будущих персональных данных.

## Функциональные требования

1. **Инициализация проекта**: Laravel 12 в директории `backend/`.
2. **Настройка БД**: SQLite, таблица пользователей `gen_user` (создаётся миграцией импорта структуры на этапе `0901_S0`).
3. **Регистрация пользователей**:
   - форма регистрации: логин, Email, пароль, подтверждение пароля, ФИО;
   - валидация (уникальность email, минимальная сложность пароля);
   - автоматический вход после успешной регистрации.
4. **Аутентификация**:
   - форма входа (Email, пароль);
   - «Запомнить меня» — опционально (UI есть, поддержка long-lived remember-token не обязательна на текущем этапе);
   - выход из системы (logout).
5. **Базовые страницы**:
   - главная страница (доступна всем);
   - страницы входа/регистрации;
   - dashboard (только для авторизованных).
6. **Защита маршрутов**: middleware `auth` для ограничения доступа.

## Нефункциональные требования

1. **Безопасность**:
   - хеширование паролей (BCRYPT/ARGON2);
   - защита от CSRF;
   - защита от XSS при выводе данных;
   - разделение гостевых и защищённых разделов.
2. **Usability**: понятные сообщения об ошибках валидации на формах.
3. **Архитектура**: модульная структура согласно `AGENTS.md` и `Architecture.md` (Clean Architecture + CQRS).
   - код в модуле `Auth`;
   - UseCase для бизнес-логики;
   - DTO для передачи данных.

## Модель предметной области

### Entity (Сущности)

* **User**:
  - `id`: int (маппинг на `gen_user.id`)
  - `login`: string (маппинг на `gen_user.login`)
  - `password`: string (маппинг на `gen_user.password`)
  - `firstName`: string (маппинг на `gen_user.fname`)
  - `middleName`: ?string (маппинг на `gen_user.sname`)
  - `lastName`: string (маппинг на `gen_user.surname`)
  - `email`: string (маппинг на `gen_user.email`)
  - `userType`: int (маппинг на `gen_user.user_type`)
  - `active`: int (маппинг на `gen_user.active`)
  - `createdAt`: string (маппинг на `gen_user.create_date`)

### Value Objects (Объекты-значения)

*   **Email**: Валидный адрес электронной почты.
*   **Password**: Строка, соответствующая требованиям безопасности.

## Зависимости

*   **Laravel Framework**: Основа приложения.
*   **SQLite**: СУБД для хранения данных.
*   **Composer**: Менеджер пакетов PHP.
*   **Docker**: Среда для запуска приложения (согласно `AGENTS.md`).
*   **Makefile**: Для управления командами разработки.

## Сценарии использования

### Сценарий 1: Регистрация нового пользователя

1.  Пользователь открывает страницу `/register`.
2.  Вводит свои данные (Имя, Email, Пароль, Подтверждение пароля).
3.  Система проверяет, что email не занят, пароли совпадают и соответствуют требованиям сложности.
4.  Система создает запись в таблице `users`.
5.  Пользователь автоматически входит в систему и перенаправляется на `/dashboard`.

### Сценарий 2: Вход в систему

1.  Пользователь открывает страницу `/login`.
2.  Вводит email и пароль.
3.  Система проверяет соответствие учетных данных.
4.  При успехе создается сессия, пользователь перенаправляется на `/dashboard`.

### Сценарий 3: Выход из системы

1.  Авторизованный пользователь нажимает кнопку "Выход".
2.  Система завершает сессию пользователя.
3.  Пользователь перенаправляется на страницу входа.

## Риски

1.  **Безопасность**: Неправильная настройка сессий или middleware может привести к несанкционированному доступу.
2.  **Окружение**: Возможные конфликты версий PHP/расширений в Docker контейнере (необходимо следовать `AGENTS.md`).
3.  **Интеграция**: Сложности с реализацией Clean Architecture в рамках стандартных механизмов аутентификации Laravel.

## Критерии приемки

1.  Приложение успешно запускается через `make up` и отображает главную страницу.
2.  Страницы регистрации и входа доступны по соответствующим маршрутам.
3.  Новые пользователи могут успешно зарегистрироваться.
4.  Существующие пользователи могут войти в систему.
5.  Защищенные маршруты (например, `/dashboard`) недоступны без аутентификации (перенаправление на `/login`).
6.  После выхода пользователь не имеет доступа к защищенным маршрутам.
7.  Пароли в базе данных хранятся в хешированном виде.
8.  Код организован согласно правилам `Architecture.md`.

## Не входит в реализацию

*   Восстановление пароля через email (запланировано на следующие этапы).
*   Подтверждение email (Email Verification).
*   Двухфакторная аутентификация.
*   Профили пользователей с расширенными данными (фото, биография).
*   Функционал самого генеалогического древа.
