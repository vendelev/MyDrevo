# План тестирования: Базовая структура и аутентификация

## Структура тестов
Тесты организованы в директории `backend/tests/Suite/Auth`:
- `Domain/`: тесты сущностей и DTO.
- `Application/`: тесты CQRS-команд.
- `Functional/`: тесты UseCase (Application слой).
- `Integration/`: тесты команд/запросов и работы с БД.
- `Presentation/`: тесты контроллеров и представлений.
- `E2E/`: тесты полного web-флоу через HTTP.

## Функциональные тесты (Application слой)

### UseCase: RegisterUser
- **Сценарий 1: Успешная регистрация**
    - **Дано**: валидные данные (имя, email, пароль).
    - **Проверяемое**: вызов `RegisterUser->handle()`.
    - **Ожидаемый результат**: пользователь создан, пароль захеширован, возвращена сущность `User`.
- **Сценарий 2: Регистрация с существующим email**
    - **Дано**: email, который уже есть в системе.
    - **Проверяемое**: вызов `RegisterUser->handle()`.
    - **Ожидаемый результат**: `RuntimeException` с текстом `Email already exists`.

### UseCase: LoginUser
- **Сценарий 1: Успешный вход**
    - **Дано**: корректные email и пароль.
    - **Проверяемое**: вызов `LoginUser->handle()`.
    - **Ожидаемый результат**: возвращена сущность `User`.
- **Сценарий 2: Вход с неверным паролем**
    - **Дано**: корректный email, неверный пароль.
    - **Проверяемое**: вызов `LoginUser->handle()`.
    - **Ожидаемый результат**: `RuntimeException` с текстом `Invalid credentials`.

## Application тесты (CQRS-команды)

### RegisterUserCommand
- **Сценарий 1: Сохранение пользователя**
    - **Дано**: доменная сущность `User`.
    - **Проверяемое**: `RegisterUserCommand->handle()`.
    - **Ожидаемый результат**: данные сохранены в `gen_user`.

## Integration тесты (Query/Command)

### GetUserByEmailQuery / GetUserByIdQuery
- **Сценарий 1: Поиск пользователя**
    - **Дано**: ранее сохранённый пользователь.
    - **Проверяемое**: `handle()` возвращает корректную сущность.
    - **Ожидаемый результат**: данные совпадают с сохранёнными.

## Presentation тесты (HTTP)

### Контроллеры и шаблоны
- **Сценарий 1: Рендер форм**
    - **Дано**: GET `/login`, GET `/register`.
    - **Ожидаемый результат**: страницы возвращают форму и валидный HTML.

## E2E тесты (Presentation слой)

### Web Authentication Flow
- **Сценарий 1: Полный цикл регистрации и доступа к Dashboard**
    - **Дано**: гость на странице `/register`.
    - **Проверяемое**: отправка формы регистрации -> редирект на `/dashboard` -> доступ разрешен.
    - **Ожидаемый результат**: статус 200 на Dashboard, пользователь аутентифицирован.
- **Сценарий 2: Защита Dashboard от гостей**
    - **Дано**: неавторизованный пользователь.
    - **Проверяемое**: запрос GET `/dashboard`.
    - **Ожидаемый результат**: редирект на `/login`.

## Чек-лист выполнения
- [ ] Запуск всех тестов: `make php-run CMD="php artisan test"`
- [ ] Запуск только тестов Auth: `make php-run CMD="php artisan test tests/Suite/Auth"`

## Критерии приемки
1. Новые пользователи могут успешно зарегистрироваться.
2. Существующие пользователи могут войти в систему.
3. Защищенные маршруты недоступны без аутентификации.
4. Пароли в базе данных хранятся в хешированном виде.
5. Все тесты проходят успешно.
