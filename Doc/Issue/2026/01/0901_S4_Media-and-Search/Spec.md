# Спецификация: Добавление медиа и поиск (Этап 4)

## Описание проблемы/потребности

После реализации визуализации семейного дерева (Этап 3), пользователям необходимо наполнять профили визуальным контентом и документами для сохранения семейного наследия. Текущая система позволяет хранить только текстовые данные и связи. 

Данная функциональность решает две ключевые задачи:
1. **Медиа-архив**: Возможность загрузки фотографий и документов (сканов свидетельств, писем) для каждого члена семьи.
2. **Навигация и поиск**: По мере роста дерева пользователям становится сложно находить конкретных людей или события. Необходим эффективный инструмент поиска по всей базе данных семьи.

## Функциональные требования

### 1. Управление медиафайлами
*   **Загрузка файлов**:
    *   Загрузка изображений (аватары и галерея) в форматах JPG, PNG.
    *   Загрузка документов в форматах PDF, DOC, DOCX.
    *   Привязка медиафайла к конкретному профилю члена семьи (`FamilyMember`).
*   **Обработка изображений**:
    *   Автоматическое создание превью (thumbnails) для изображений.
    *   Оптимизация размера оригиналов для веб-просмотра.
*   **Просмотр и управление**:
    *   Получение списка медиафайлов профиля.
    *   Удаление медиафайлов.
    *   Установка одного из изображений как "основного" (аватара).

### 2. Система поиска
*   **Простой поиск**:
    *   Поиск по ФИО (включая частичное совпадение).
*   **Расширенный поиск**:
    *   Фильтрация по датам (год рождения/смерти).
    *   Фильтрация по месту (место рождения/смерти).
    *   Фильтрация по полу.
*   **Производительность поиска**:
    *   Результаты должны возвращаться не более чем за 200 мс.

## Нефункциональные требования

1.  **Безопасность**:
    *   Проверка MIME-типов файлов для предотвращения загрузки вредоносного ПО.
    *   Ограничение размера загружаемого файла (например, до 10 МБ).
    *   Доступ к медиафайлам только для авторизованных пользователей.
2.  **Хранение**:
    *   Использование файловой системы (Laravel Storage) с организацией по папкам.
    *   Хранение метаданных в БД (путь к файлу, тип, размер, привязка к персоне).
3.  **Масштабируемость**:
    *   Архитектура должна позволять в будущем легко перейти на облачное хранилище (S3).

## Модель предметной области

### Сущности (Entities)

1.  **Media (Медиафайл):**
    *   `id`: UUID.
    *   `owner_id`: UUID (ссылка на `FamilyMember`).
    *   `file_path`: String (путь к оригинальному файлу).
    *   `thumbnail_path`: String (nullable, путь к превью).
    *   `file_name`: String (оригинальное имя файла).
    *   `mime_type`: String.
    *   `file_size`: Integer (в байтах).
    *   `type`: Enum (image, document).
    *   `is_primary`: Boolean (флаг основного фото).
    *   `created_at`: Timestamp.

### Объекты-значения (Value Objects)

1.  **SearchCriteria**: Объект, инкапсулирующий параметры поиска (query, dates, places, gender).

## Технические детали (API и БД)

### API Эндпоинты (Медиа)
- `POST /api/v1/family-members/{id}/media` — Загрузка файла.
- `GET /api/v1/family-members/{id}/media` — Список медиафайлов профиля.
- `PATCH /api/v1/media/{media_id}/set-primary` — Установка основного фото.
- `DELETE /api/v1/media/{media_id}` — Удаление файла.

### API Эндпоинты (Поиск)
- `GET /api/v1/search` — Поиск по критериям.
    *   Параметры: `q` (строка), `birth_year`, `death_year`, `place`, `gender`.

### Структура БД (SQLite)
Необходимо создать новую таблицу `gen_media` (или аналогичную в соответствии с существующим именованием):
- `ID` (int unsigned auto_increment)
- `PERSON_ID` (int unsigned, FK to `gen_person`)
- `FILE_PATH` (varchar)
- `THUMB_PATH` (varchar, nullable)
- `FILE_NAME` (varchar)
- `MIME_TYPE` (varchar)
- `FILE_SIZE` (int)
- `MEDIA_TYPE` (tinyint: 1-image, 2-document)
- `IS_PRIMARY` (boolean)

## Зависимости

1.  **Family Member Module (S2)**: Медиа привязываются к персонам.
2.  **Laravel Storage**: Для работы с файловой системой.
3.  **Intervention Image** (или аналог): Для обработки изображений и создания превью.

## Сценарии использования

### Сценарий 1: Загрузка семейного фото
1. Пользователь открывает профиль дедушки.
2. Нажимает "Добавить фото".
3. Выбирает старый отсканированный снимок.
4. Система загружает файл, создает превью и сохраняет запись в БД.
5. Фото появляется в галерее профиля.

### Сценарий 2: Поиск родственника по месту рождения
1. Пользователь вводит в поиске "Саратов".
2. Система находит всех членов семьи, у которых в поле "Место рождения" указан Саратов.
3. Пользователь видит список карточек с результатами.

## Риски

1.  **Безопасность**: Риск загрузки исполняемых файлов под видом документов. Решение: строгая валидация расширений и MIME-типов.
2.  **Место на диске**: Быстрое заполнение хранилища. Решение: квоты на пользователя или сжатие изображений.
3.  **Производительность поиска**: При росте базы данных поиск по `LIKE %...%` в SQLite может замедлиться. Решение: индексация текстовых полей.

## Критерии приемки

1.  Реализована загрузка и удаление файлов через API.
2.  Изображения автоматически получают превью.
3.  Файлы сохраняются в защищенную директорию `storage/app/public/media`.
4.  Поиск возвращает корректные результаты по имени и фильтрам.
5.  API поиска укладывается в лимит 200 мс.
6.  Написаны тесты на загрузку файлов (включая негативные сценарии с неверными типами).

## Не входит в реализацию

1.  Редактирование изображений (обрезка, фильтры).
2.  Распознавание лиц на фото.
3.  Полнотекстовый поиск по содержимому PDF-документов.
4.  Публичные ссылки на медиа (доступ только через API с авторизацией).
