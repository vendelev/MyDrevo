# Спецификация бизнес-требований TZ1_05

## Метаинформация

- **Номер задачи:** TZ1_05
- **Эпик:** TZ1 — Веб-сайт семейного генеалогического древа
- **Этап:** Stage 5 — Управление связями (создание, удаление, проверки)
- **Дата создания:** 2026-01-23
- **Статус:** Черновик

## Описание проблемы/потребности

### Контекст

После реализации управления персонами (этапы 3-4), пользователи могут создавать, просматривать и редактировать информацию о родственниках в генеалогическом древе. 
Однако каждая персона существует изолированно — нет возможности указать родственные отношения между ними.

Текущее состояние:

- Реализована доменная модель Person, Name, Surname с репозиториями (этап 2)
- Пользователи могут создавать и редактировать персоны с многоязычными данными (этап 4)
- Пользователи могут удалять персоны (этап 4)
- Связи между персонами не отображаются в UI
- Невозможно создать или удалить связь через интерфейс
- Нет валидации корректности связей (циклы, несоответствие дат и т.д.)

### Проблема

**КРИТИЧНО:** Без возможности связывать персоны между собой генеалогическое древо теряет свою основную ценность:

1. **Потеря контекста родства:** Нельзя понять, кто кому приходится родственником
2. **Невозможность построения древа:** Визуализация генеалогического древа требует информации о связях
3. **Отсутствие валидации данных:** Пользователь может создать противоречивые данные (например, человек — родитель самого себя, или ребенок старше родителя)
4. **Риск некорректных данных:** Без проверок связи могут содержать логические ошибки
5. **Сложность навигации:** Невозможно быстро найти родственников конкретного человека
6. **Отсутствие целостности:** При удалении персоны связи остаются висячими, что приводит к ошибкам

### Бизнес-ценность решения

Реализация управления связями обеспечит:

- **Полноценное генеалогическое древо:** Пользователи смогут видеть родственные отношения
- **Корректность данных:** Автоматические проверки предотвратят создание некорректных связей
- **Удобную навигацию:** Легко перейти от одной персоны к её родственникам
- **Целостность данных:** Автоматическое создание обратных связей и управление зависимостями
- **Основу для визуализации:** Данные о связях станут фундаментом для отображения генеалогического древа (этап 6)
- **Интуитивный интерфейс:** Пользователи смогут добавлять родственников прямо из карточки персоны

## Функциональные требования

### FR-1. Поддержка базовых типов связей

**Приоритет:** Высокий

**Описание:**
Система должна поддерживать минимальный набор типов родственных связей, необходимых для построения генеалогического древа.

**Детализация:**

#### FR-1.1. Типы связей

Система должна поддерживать следующие типы связей:

1. **Родитель → Ребенок** (PARENT_CHILD)
   - Направленная связь: A — родитель B
   - Обратная связь автоматически: B — ребенок A

2. **Супруг ↔ Супруга** (SPOUSE)
   - Симметричная связь: A — супруг B, B — супруг A
   - Хранится как одна запись в БД (без дублирования)

**Требования:**

- Типы связей должны быть определены в enum RelationType
- Каждый тип должен иметь код для хранения в БД
- Система должна различать направленные и симметричные связи

#### FR-1.2. Модель хранения связей в БД

**Описание:**
Связи должны храниться в таблице `gen_relation` с правильной нормализацией для предотвращения дубликатов.

**Требования:**

- Связь хранится как одна запись с полями:
  - `PID1` (person1_id) — идентификатор первой персоны
  - `PID2` (person2_id) — идентификатор второй персоны
  - `RELATION_TYPE_ID` — тип связи (ссылка на gen_relation_type)
- Для симметричных связей (супруг) система должна нормализовать пару: всегда сохранять меньший ID первым (PID1 < PID2)
- Уникальность связи обеспечивается уникальным индексом на (PID1, PID2, RELATION_TYPE_ID)
- Для направленных связей (родитель/ребенок) направление важно и не нормализуется

**Критерии приемки FR-1:**

- ✅ Определен enum RelationType с типами PARENT_CHILD и SPOUSE
- ✅ Enum имеет методы toCode() и fromCode() для маппинга на БД
- ✅ Система различает направленные и симметричные связи
- ✅ Для SPOUSE пара идентификаторов нормализуется (PID1 < PID2)
- ✅ Уникальный индекс в БД предотвращает дублирование связей

---

### FR-2. Создание связей между персонами

**Приоритет:** Высокий

**Описание:**
Пользователь должен иметь возможность создавать связи между персонами через UI с автоматическим созданием обратных связей.

**Детализация:**

#### FR-2.1. Use Case: Создание связи

**Актор:** Авторизованный пользователь

**Предусловия:**
- В системе существует минимум 2 персоны, принадлежащие пользователю
- Пользователь авторизован

**Основной сценарий:**

1. Пользователь открывает карточку персоны A
2. Нажимает кнопку "Добавить связь"
3. В форме выбирает:
   - Вторую персону B из списка своих персон
   - Тип связи (Родитель, Ребенок, Супруг)
4. Нажимает "Сохранить"
5. Система выполняет проверки (см. FR-3)
6. Если проверки пройдены:
   - Создается связь A → B с выбранным типом
   - Автоматически создается обратная связь (если применимо)
   - Связь отображается в карточках обеих персон
7. Если проверки не пройдены:
   - Отображается понятное сообщение об ошибке

**Альтернативный сценарий: Создание симметричной связи (супруг)**

1. Пользователь выбирает тип "Супруг" для связи A—B
2. Система:
   - Нормализует пару (если ID(A) > ID(B), меняет местами)
   - Сохраняет одну запись в БД
   - Отображает связь у обеих персон как "Супруг/Супруга"

**Альтернативный сценарий: Создание направленной связи (родитель/ребенок)**

1. Пользователь выбирает тип "Родитель" для связи A—B (A родитель B)
2. Система:
   - Создает связь A—родитель—B
   - Автоматически создает обратную связь B—ребенок—A
   - Отображает в карточке A: "Родитель для: B"
   - Отображает в карточке B: "Ребенок: A"

#### FR-2.2. Интерфейс создания связи

**Требования к UI:**

- Форма должна содержать:
  - Dropdown для выбора второй персоны (autocomplete для больших списков)
  - Radio buttons для выбора типа связи
  - Кнопки "Сохранить" и "Отмена"
- При выборе типа связи должна отображаться подсказка о значении
- После сохранения пользователь должен видеть обновленную карточку с новой связью

#### FR-2.3. API для создания связи

**Endpoint:** `POST /api/relations`

**Request body:**

```json
{
  "person_id_1": 123,
  "person_id_2": 456,
  "relation_type": "parent_child"
}
```

**Response (успех):**

```json
{
  "success": true,
  "relation": {
    "person_id_1": 123,
    "person_id_2": 456,
    "relation_type": "parent_child"
  },
  "reverse_relation": {
    "person_id_1": 456,
    "person_id_2": 123,
    "relation_type": "child_parent"
  }
}
```

**Response (ошибка валидации):**

```json
{
  "success": false,
  "error": "Неверная связь: ребенок не может быть старше родителя"
}
```

**Критерии приемки FR-2:**

- ✅ Реализована форма создания связи в UI
- ✅ Пользователь может выбрать вторую персону и тип связи
- ✅ API endpoint принимает данные и создает связь
- ✅ Для направленных связей создается обратная связь автоматически
- ✅ Для симметричных связей пара нормализуется
- ✅ После создания связь отображается в карточках обеих персон
- ✅ При ошибке валидации отображается понятное сообщение

---

### FR-3. Валидация связей при создании

**Приоритет:** Высокий

**Описание:**
Система должна предотвращать создание некорректных связей с понятными сообщениями об ошибках.

**Детализация:**

#### FR-3.1. Проверка: Запрет самосвязей

**Правило:** Нельзя создать связь, где обе персоны — одно и то же лицо.

**Проверка:**
- person_id_1 ≠ person_id_2

**Сообщение об ошибке:**
> Неверная связь: человек не может быть связан сам с собой

#### FR-3.2. Проверка: Запрет дублирования связей

**Правило:** Нельзя создать повторную связь того же типа между теми же персонами.

**Проверка:**

- Для направленных связей: проверить, что не существует записи (PID1, PID2, TYPE)
- Для симметричных связей: проверить, что не существует записи (min(PID1,PID2), max(PID1,PID2), TYPE)

**Сообщение об ошибке:**
> Неверная связь: такая связь уже существует

#### FR-3.3. Проверка: Запрет циклов родитель-ребенок

**Правило:** Один человек не может быть одновременно родителем и ребенком другого человека.

**Проверка:**

- Если существует связь A—родитель—B, то запретить:
  - A—ребенок—B
  - B—родитель—A (т.к. это автоматически создаст A—ребенок—B)
- Если существует связь A—ребенок—B, то запретить:
  - A—родитель—B
  - B—ребенок—A

**Сообщение об ошибке:**
> Неверная связь: противоречивые отношения родитель/ребенок между этими персонами

#### FR-3.4. Проверка: Даты рождения родитель-ребенок

**Правило:** Если у обеих персон указаны даты рождения, родитель должен быть старше ребенка.

**Проверка:**

- Если создается связь A—родитель—B:
  - Если birth_date(A) ≠ NULL И birth_date(B) ≠ NULL
  - То birth_date(A) < birth_date(B)
- Если хотя бы одна дата NULL — проверка пропускается

**Сообщение об ошибке:**
> Неверная связь: родитель не может быть младше ребенка (даты рождения: родитель YYYY-MM-DD, ребенок YYYY-MM-DD)

#### FR-3.5. Проверка прав доступа

**Правило:** Пользователь может создавать связи только между своими персонами.

**Проверка:**

- user_id(person1) == current_user_id
- user_id(person2) == current_user_id

**Сообщение об ошибке:**
> Неверная связь: нет доступа к одной или обеим персонам

**Критерии приемки FR-3:**

- ✅ Все 5 проверок реализованы в бизнес-логике (Use Case)
- ✅ Проверки выполняются перед сохранением в БД
- ✅ При нарушении правила возвращается понятное сообщение об ошибке
- ✅ Формат сообщения: "Неверная связь: [описание]"
- ✅ Уникальный индекс в БД предотвращает дублирование на уровне СУБД
- ✅ Все сообщения об ошибках на русском языке

---

### FR-4. Отображение связей

**Приоритет:** Высокий

**Описание:**
Пользователь должен видеть все связи персоны в её карточке и в отдельном списке связей.

**Детализация:**

#### FR-4.1. Отображение связей в карточке персоны

**Требования:**

- В карточке персоны должен быть раздел "Связи"
- Связи должны быть сгруппированы по типам:
  - **Родители:** список персон, для которых текущая персона — ребенок
  - **Дети:** список персон, для которых текущая персона — родитель
  - **Супруги:** список персон, связанных как супруги
- Для каждой связи отображать:
  - Полное имя связанной персоны (на текущем языке интерфейса)
  - Тип связи (понятный текст: "Отец", "Мать", "Сын", "Дочь", "Супруг", "Супруга")
  - Кнопку "Удалить связь"
  - Ссылку на карточку связанной персоны

**Пример отображения:**

```
Связи:

Родители:
- Иван Петров (Отец) [Удалить] [Перейти к карточке]
- Мария Петрова (Мать) [Удалить] [Перейти к карточке]

Дети:
- Анна Сидорова (Дочь) [Удалить] [Перейти к карточке]

Супруги:
- Алексей Сидоров (Супруг) [Удалить] [Перейти к карточке]
```

#### FR-4.2. Список всех связей пользователя

**Требования:**

- Должна быть страница "Связи" со списком всех связей
- Фильтрация по типу связи
- Поиск по имени персоны
- Для каждой связи отображать:
  - Персона 1 → Тип связи → Персона 2
  - Кнопку "Удалить"

**Критерии приемки FR-4:**

- ✅ Связи отображаются в карточке персоны
- ✅ Связи сгруппированы по типам (Родители, Дети, Супруги)
- ✅ Типы связей отображаются понятным текстом на русском языке
- ✅ Есть ссылки для перехода к карточкам связанных персон
- ✅ Есть кнопка удаления связи
- ✅ Реализована страница со списком всех связей
- ✅ Поддерживается фильтрация и поиск

---

### FR-5. Удаление связей

**Приоритет:** Высокий

**Описание:**
Пользователь должен иметь возможность удалять связи между персонами с автоматическим удалением обратных связей.

**Детализация:**

#### FR-5.1. Use Case: Удаление связи

**Актор:** Авторизованный пользователь

**Предусловия:**
- Существует связь между персонами A и B
- Пользователь — владелец обеих персон

**Основной сценарий:**

1. Пользователь открывает карточку персоны A
2. В разделе "Связи" находит связь с персоной B
3. Нажимает кнопку "Удалить" рядом со связью
4. Система запрашивает подтверждение: "Удалить связь с [Имя персоны]?"
5. Пользователь подтверждает
6. Система:
   - Удаляет связь A → B
   - Автоматически удаляет обратную связь B → A (если применимо)
   - Обновляет отображение карточки

**Альтернативный сценарий: Удаление симметричной связи**

1. При удалении связи типа "Супруг" A—B
2. Система удаляет одну запись из БД
3. Связь исчезает из карточек обеих персон

**Альтернативный сценарий: Удаление направленной связи**

1. При удалении связи "A — родитель — B"
2. Система удаляет обе записи:
   - A—родитель—B
   - B—ребенок—A
3. Связь исчезает из карточек обеих персон

#### FR-5.2. API для удаления связи

**Endpoint:** `DELETE /api/relations/{person_id_1}/{person_id_2}/{relation_type}`

**Response (успех):**

```json
{
  "success": true,
  "message": "Связь удалена"
}
```

**Response (ошибка):**

```json
{
  "success": false,
  "error": "Связь не найдена или нет доступа"
}
```

#### FR-5.3. Автоматическое удаление связей при удалении персоны

**Требование:**
При удалении персоны все её связи должны быть автоматически удалены.

**Реализация:**

- В методе PersonRepository::delete() перед удалением персоны:
  1. Загрузить все связи, где персона участвует (PID1 или PID2)
  2. Удалить все найденные связи
  3. Удалить персону

**Критерии приемки FR-5:**

- ✅ Пользователь может удалить связь из карточки персоны
- ✅ Перед удалением запрашивается подтверждение
- ✅ При удалении направленной связи автоматически удаляется обратная
- ✅ При удалении симметричной связи удаляется одна запись
- ✅ API endpoint корректно обрабатывает запрос на удаление
- ✅ При удалении персоны автоматически удаляются все её связи
- ✅ После удаления связь исчезает из UI

---

## Нефункциональные требования

### NFR-1. Производительность

**Описание:**
Операции со связями должны выполняться быстро даже при большом количестве персон.

**Критерии:**

- Создание связи: < 200ms
- Удаление связи: < 200ms
- Загрузка связей для одной персоны: < 100ms
- Загрузка списка всех связей (до 1000 записей): < 500ms

**Проверка:**

- Измерить время выполнения операций на тестовых данных (100 персон, 200 связей)

---

### NFR-2. Безопасность

**Описание:**
Пользователь может управлять связями только между своими персонами.

**Критерии:**

- Проверка прав доступа на уровне Use Case
- Невозможность создать связь с чужой персоной
- Невозможность удалить связь, если не владелец обеих персон

**Проверка:**

- Попытка создания связи с чужой персоной возвращает ошибку 403
- Попытка удаления чужой связи возвращает ошибку 403

---

### NFR-3. Целостность данных

**Описание:**
Данные о связях должны быть всегда консистентными.

**Критерии:**

- Уникальный индекс в БД предотвращает дублирование
- Обратные связи всегда создаются/удаляются автоматически
- При удалении персоны связи удаляются каскадно
- Транзакции обеспечивают атомарность операций

**Проверка:**

- Невозможно создать дубликат связи
- При сбое создания обратной связи откатывается вся транзакция
- После удаления персоны в БД нет висячих связей

---

### NFR-4. Usability

**Описание:**
Интерфейс управления связями должен быть интуитивно понятным.

**Критерии:**

- Форма создания связи понятна без инструкции
- Типы связей имеют понятные названия на русском языке
- Сообщения об ошибках понятны нетехническому пользователю
- Подтверждение перед удалением связи

**Проверка:**

- Пользовательское тестирование: пользователь может создать связь без инструкции
- Сообщения об ошибках не содержат технических терминов

---

## Модель предметной области

### Основные Entity

#### Relation (Связь)

**Описание:** Связь между двумя персонами в генеалогическом древе.

**Атрибуты:**

- `personId1: int` — идентификатор первой персоны
- `personId2: int` — идентификатор второй персоны
- `type: RelationType` — тип связи

**Методы:**

- `validate(): void` — проверка корректности связи (самосвязи, дубликаты)
- `isSymmetric(): bool` — является ли связь симметричной
- `normalize(): Relation` — нормализация пары для симметричных связей

---

### Enumerations

#### RelationType (Тип связи)

**Значения:**

- `PARENT_CHILD` — Родитель → Ребенок (направленная)
- `SPOUSE` — Супруг ↔ Супруга (симметричная)

**Методы:**

- `toCode(): string` — преобразование в код БД ('parent_child', 'spouse')
- `fromCode(string $code): RelationType` — создание из кода БД
- `isSymmetric(): bool` — проверка симметричности
- `getReverseType(): ?RelationType` — получить обратный тип (для PARENT_CHILD возвращает CHILD_PARENT)

---

### Диаграмма взаимодействия

```
┌─────────────┐
│    User     │
└─────────────┘
       │ owns
       ▼
┌─────────────┐        ┌─────────────┐
│   Person    │◄──────►│  Relation   │
│      A      │        └─────────────┘
└─────────────┘              │
                             │ relates
                             ▼
                       ┌─────────────┐
                       │   Person    │
                       │      B      │
                       └─────────────┘

Типы связей:
- A—родитель—B  ⇄  B—ребенок—A  (автоматическая обратная)
- A—супруг—B  (симметричная, одна запись)
```

---

## Зависимости

### Внешние зависимости

- **Laravel 12** — фреймворк для реализации Use Cases и API
- **PHP 8.5** — язык программирования
- **SQLite** — СУБД для хранения связей

### Внутренние зависимости

Этот этап (Stage 5) **зависит** от:

- **Stage 2** (TZ1_02) — требует реализованную доменную модель Relation и RelationRepository
- **Stage 3** (TZ1_03) — требует UI для просмотра персон
- **Stage 4** (TZ1_04) — требует UI для управления персонами

Этот этап **является блокирующим** для:

- **Stage 6** — Визуализация генеалогического древа (требует данные о связях)

---

## Сценарии использования

### UC-1. Пользователь добавляет связь "родитель-ребенок"

**Актор:** Пользователь

**Предусловия:**

- В системе есть персона "Иван Петров" (id=1, дата рождения: 1950-05-10)
- В системе есть персона "Анна Петрова" (id=2, дата рождения: 1975-08-15)
- Пользователь авторизован и владеет обеими персонами

**Основной сценарий:**

1. Пользователь открывает карточку "Иван Петров"
2. Нажимает кнопку "Добавить связь"
3. В форме:
   - Выбирает персону "Анна Петрова" из dropdown
   - Выбирает тип связи "Родитель"
4. Нажимает "Сохранить"
5. Система:
   - Проверяет, что id(Иван) ≠ id(Анна) ✓
   - Проверяет, что связь не дублируется ✓
   - Проверяет даты рождения: 1950 < 1975 ✓
   - Создает связь: Иван—родитель—Анна
   - Автоматически создает обратную: Анна—ребенок—Иван
6. В карточке Ивана отображается:
   - Раздел "Дети": Анна Петрова (Дочь)
7. В карточке Анны отображается:
   - Раздел "Родители": Иван Петров (Отец)

**Постусловия:**

- Связь создана и отображается в карточках обеих персон
- Пользователь может перейти от Ивана к Анне и обратно по ссылкам

---

### UC-2. Система предотвращает некорректную связь

**Актор:** Пользователь

**Предусловия:**

- В системе есть персона "Мария Сидорова" (id=3, дата рождения: 1980-03-20)
- В системе есть персона "Петр Сидоров" (id=4, дата рождения: 1955-11-30)
- Пользователь авторизован

**Сценарий: Попытка создать связь с противоречивыми датами**

1. Пользователь открывает карточку "Мария Сидорова"
2. Нажимает "Добавить связь"
3. Выбирает:
   - Персона: "Петр Сидоров"
   - Тип: "Родитель" (Мария — родитель Петра)
4. Нажимает "Сохранить"
5. Система проверяет даты:
   - Дата рождения Марии: 1980
   - Дата рождения Петра: 1955
   - 1980 > 1955 — ошибка!
6. Отображается сообщение об ошибке:
   > Неверная связь: родитель не может быть младше ребенка (даты рождения: родитель 1980-03-20, ребенок 1955-11-30)
7. Связь не создается

**Постусловия:**

- Некорректная связь не сохранена
- Пользователь понимает причину ошибки

---

### UC-3. Пользователь добавляет супружескую связь

**Актор:** Пользователь

**Предусловия:**

- В системе есть персона "Александр Иванов" (id=5)
- В системе есть персона "Елена Иванова" (id=6)

**Основной сценарий:**

1. Пользователь открывает карточку "Александр Иванов"
2. Нажимает "Добавить связь"
3. Выбирает:
   - Персона: "Елена Иванова"
   - Тип: "Супруг"
4. Нажимает "Сохранить"
5. Система:
   - Нормализует пару: min(5,6)=5, max(5,6)=6
   - Создает одну запись: (PID1=5, PID2=6, TYPE=SPOUSE)
6. В карточке Александра отображается:
   - Раздел "Супруги": Елена Иванова (Супруга)
7. В карточке Елены отображается:
   - Раздел "Супруги": Александр Иванов (Супруг)

**Постусловия:**

- Создана одна симметричная связь
- Связь отображается у обеих персон

---

### UC-4. Пользователь удаляет связь

**Актор:** Пользователь

**Предусловия:**

- Существует связь: Иван—родитель—Анна
- Существует обратная связь: Анна—ребенок—Иван

**Основной сценарий:**

1. Пользователь открывает карточку "Иван Петров"
2. В разделе "Дети" видит: "Анна Петрова (Дочь)"
3. Нажимает кнопку "Удалить" рядом со связью
4. Появляется диалог подтверждения: "Удалить связь с Анна Петрова?"
5. Пользователь нажимает "Да"
6. Система:
   - Удаляет связь Иван—родитель—Анна
   - Автоматически удаляет обратную Анна—ребенок—Иван
7. Связь исчезает из карточек обеих персон

**Постусловия:**

- Связь удалена из БД
- UI обеих персон обновлен

---

### UC-5. Система автоматически удаляет связи при удалении персоны

**Актор:** Пользователь

**Предусловия:**

- Персона "Петр Сидоров" (id=4) имеет связи:
  - Родитель: Иван (id=1)
  - Дети: Ольга (id=7), Сергей (id=8)
  - Супруга: Мария (id=3)

**Основной сценарий:**

1. Пользователь открывает карточку "Петр Сидоров"
2. Нажимает кнопку "Удалить персону"
3. Подтверждает удаление
4. Система:
   - Находит все связи Петра:
     - Петр—ребенок—Иван (и обратная)
     - Петр—родитель—Ольга (и обратная)
     - Петр—родитель—Сергей (и обратная)
     - Петр—супруг—Мария
   - Удаляет все найденные связи
   - Удаляет персону Петра
5. В карточках Ивана, Ольги, Сергея, Марии связи с Петром исчезают

**Постусловия:**

- Персона удалена
- Все связи удалены
- Нет висячих ссылок в БД

---

## Риски

### Риск 1. Сложность автоматического создания обратных связей

**Описание:**
Автоматическое создание обратных связей (например, при создании "родитель" автоматически создается "ребенок") требует синхронизации и может привести к ошибкам при сбоях.

**Вероятность:** Средняя

**Влияние:** Высокое (несогласованные данные)

**Меры снижения:**

- Использовать транзакции для атомарности операции
- Создавать обе связи в одной транзакции (commit или rollback для обеих)
- Тестировать сценарии с имитацией сбоев (прерывание транзакции)

**План реагирования:**

- Если обнаружены несогласованные связи — написать команду для проверки и исправления
- Добавить уникальные индексы в БД для предотвращения дублей

---

### Риск 2. Неполнота проверок валидации

**Описание:**
Проверки на этапе 5 охватывают базовые случаи, но могут не учитывать все возможные противоречия (например, циклы в дереве предков).

**Вероятность:** Средняя

**Влияние:** Среднее (некорректные данные)

**Меры снижения:**

- Четко определить минимальный набор проверок на этапе 5
- Добавить расширенные проверки (циклы в дереве) на этапе 6, когда будет реализована визуализация
- Документировать, какие проверки реализованы, а какие — в планах

**План реагирования:**

- Собирать feedback от пользователей о некорректных данных
- Приоритизировать дополнительные проверки на основе частоты проблем

---

### Риск 3. Производительность при большом количестве связей

**Описание:**
Загрузка персоны со всеми её связями может быть медленной, если связей много (например, у персоны 50 детей).

**Вероятность:** Низкая (редкий случай)

**Влияние:** Среднее (медленная загрузка UI)

**Меры снижения:**

- Использовать eager loading для загрузки связей
- Ограничить количество отображаемых связей (например, показать первые 10 + кнопка "Показать все")
- Измерить производительность на реальных данных

**План реагирования:**

- Если обнаружена медленная загрузка — добавить пагинацию для списка связей
- Использовать lazy loading (загрузка связей по требованию)

---

### Риск 4. Usability формы создания связи

**Описание:**
Форма выбора персоны и типа связи может быть непонятной для пользователя, особенно при выборе направления связи (кто родитель, кто ребенок).

**Вероятность:** Средняя

**Влияние:** Среднее (пользовательские ошибки)

**Меры снижения:**

- Добавить подсказки в форму (например, "Иван — родитель для — Анна")
- Использовать понятные названия типов связей ("Родитель", "Ребенок", "Супруг")
- Провести пользовательское тестирование формы

**План реагирования:**

- Собрать feedback от первых пользователей
- Улучшить UI на основе обратной связи

---

### Риск 5. Каскадное удаление связей при удалении персоны

**Описание:**
При удалении персоны с большим количеством связей операция может быть медленной или привести к timeout.

**Вероятность:** Низкая

**Влияние:** Среднее (timeout операции)

**Меры снижения:**

- Использовать batch delete для удаления связей
- Измерить производительность на тестовых данных (персона со 100 связями)
- Рассмотреть использование ON DELETE CASCADE на уровне БД

**План реагирования:**

- Если удаление медленное — оптимизировать запросы
- Добавить фоновое удаление (queue) для персон с большим количеством связей

---

## Критерии приемки

### Критерии приемки этапа

Этап считается завершенным, если выполнены **все** следующие критерии:

#### Критерии по типам связей

- ✅ Определены типы связей: PARENT_CHILD, SPOUSE
- ✅ Система различает направленные и симметричные связи
- ✅ Для симметричных связей пара нормализуется (PID1 < PID2)
- ✅ Уникальный индекс в БД предотвращает дублирование

#### Критерии по созданию связей

- ✅ Реализована форма создания связи в UI
- ✅ Пользователь может выбрать персону и тип связи
- ✅ API endpoint создает связь и возвращает результат
- ✅ Для направленных связей автоматически создается обратная
- ✅ Для симметричных связей создается одна запись
- ✅ Связь отображается в карточках обеих персон

#### Критерии по валидации

- ✅ Проверка: запрет самосвязей (person_id_1 ≠ person_id_2)
- ✅ Проверка: запрет дублирования связей
- ✅ Проверка: запрет циклов родитель-ребенок
- ✅ Проверка: даты рождения (родитель старше ребенка)
- ✅ Проверка: права доступа (только свои персоны)
- ✅ Все сообщения об ошибках начинаются с "Неверная связь:"
- ✅ Сообщения об ошибках понятны нетехническому пользователю

#### Критерии по отображению связей

- ✅ Связи отображаются в карточке персоны
- ✅ Связи сгруппированы по типам (Родители, Дети, Супруги)
- ✅ Типы связей отображаются на русском языке
- ✅ Есть ссылки для перехода к карточкам связанных персон
- ✅ Реализована страница со списком всех связей
- ✅ Поддерживается фильтрация по типу связи

#### Критерии по удалению связей

- ✅ Пользователь может удалить связь из карточки персоны
- ✅ Перед удалением запрашивается подтверждение
- ✅ При удалении направленной связи автоматически удаляется обратная
- ✅ При удалении симметричной связи удаляется одна запись
- ✅ API endpoint корректно обрабатывает удаление
- ✅ При удалении персоны автоматически удаляются все её связи
- ✅ После удаления связь исчезает из UI

#### Критерии по производительности

- ✅ Создание связи: < 200ms
- ✅ Удаление связи: < 200ms
- ✅ Загрузка связей для одной персоны: < 100ms
- ✅ Загрузка списка всех связей (до 1000): < 500ms

#### Критерии по целостности данных

- ✅ Уникальный индекс в БД работает
- ✅ Обратные связи создаются/удаляются атомарно (транзакции)
- ✅ При удалении персоны нет висячих связей
- ✅ Невозможно создать дубликат связи

#### Критерии по тестам

- ✅ Написаны unit-тесты для валидации связей
- ✅ Написаны integration-тесты для создания/удаления связей
- ✅ Тесты проверяют автоматическое создание обратных связей
- ✅ Тесты проверяют каскадное удаление при удалении персоны
- ✅ Тесты проверяют все правила валидации
- ✅ Тесты проверяют права доступа

#### Критерии по качеству кода

- ✅ Код соответствует стилю проекта (.ai/Rule/CodeStyle.md)
- ✅ Код проходит статический анализ PHPStan уровня 8-9
- ✅ Код проходит проверку PHP_CodeSniffer
- ✅ Код следует принципам Clean Architecture
- ✅ Используются строгие типы (declare(strict_types=1))

---

## Не входит в реализацию

Следующие функции **НЕ входят** в реализацию текущего этапа и будут реализованы на последующих этапах:

### Не входит в Stage 5

- ❌ **Расширенные типы связей** (бабушка/дедушка, двоюродные и т.д.) — могут быть добавлены в будущих этапах
- ❌ **Проверка циклов в дереве предков** — будет реализована на Stage 6 при визуализации
- ❌ **Множественные супруги** (развод/повторный брак) — может быть добавлено в будущем
- ❌ **Указание периода брака** (дата начала/окончания) — может быть добавлено в будущем
- ❌ **Биологические vs приемные связи** — может быть добавлено в будущем
- ❌ **Визуализация генеалогического древа** — будет реализована на Stage 6
- ❌ **Автоматическое построение древа** — будет реализовано на Stage 6
- ❌ **Экспорт древа в GEDCOM** — может быть реализовано на Stage 7+
- ❌ **История изменений связей** — может быть добавлено в будущем
- ❌ **Комментарии к связям** — может быть добавлено в будущем

### Допущения текущего этапа

На текущем этапе допускаются следующие упрощения:

- ✅ **Минимальный набор типов связей** — только Родитель/Ребенок/Супруг
- ✅ **Базовые проверки валидации** — расширенные проверки (циклы в дереве) будут на Stage 6
- ✅ **Один супруг на персону** — множественные браки не поддерживаются
- ✅ **Проверка дат только при их наличии** — если дата не указана, проверка пропускается
- ✅ **Отображение всех связей без пагинации** — пагинация может быть добавлена при необходимости

---

## Дополнительные замечания

### Важные особенности реализации

1. **Нормализация пары для симметричных связей критична:** Без нормализации могут появиться дубликаты (A—супруг—B и B—супруг—A как две отдельные записи).

2. **Автоматическое создание обратных связей должно быть атомарным:** Использовать транзакции, чтобы обе связи создавались или откатывались вместе.

3. **Каскадное удаление связей при удалении персоны обязательно:** Иначе в БД останутся висячие ссылки.

4. **Понятные сообщения об ошибках важны:** Пользователь должен понимать, почему связь не создается, без технических терминов.

5. **Права доступа критичны:** Пользователь не должен иметь возможности создавать связи с чужими персонами.

### Рекомендации по реализации

1. **Начать с валидации:** Сначала реализовать все проверки в Use Case, протестировать их.

2. **Тестировать атомарность:** Имитировать сбои при создании обратной связи, проверить откат транзакции.

3. **Проверить производительность каскадного удаления:** Создать персону со 100 связями, измерить время удаления.

4. **Пользовательское тестирование UI:** Проверить, что форма создания связи понятна без инструкции.

5. **Документировать формат сообщений об ошибках:** Все ошибки валидации должны начинаться с "Неверная связь:".

---

## Глоссарий

- **Связь (Relation)** — родственное отношение между двумя персонами в генеалогическом древе
- **Симметричная связь** — связь, которая одинакова в обе стороны (супруг ↔ супруга)
- **Направленная связь** — связь с разным значением в зависимости от направления (родитель → ребенок)
- **Обратная связь** — автоматически создаваемая связь в противоположном направлении (при создании A—родитель—B создается B—ребенок—A)
- **Нормализация пары** — упорядочивание идентификаторов персон для симметричных связей (меньший ID первым)
- **Каскадное удаление** — автоматическое удаление зависимых данных (связей при удалении персоны)
- **Висячая связь** — связь, указывающая на несуществующую персону
- **Цикл родитель-ребенок** — противоречивая ситуация, когда A — родитель B и одновременно A — ребенок B
- **Use Case** — бизнес-сценарий использования системы
- **Валидация** — проверка корректности данных перед сохранением
- **Транзакция** — группа операций БД, выполняемых атомарно (все или ничего)
- **Eager loading** — предварительная загрузка связанных данных для избежания N+1 проблемы

---

**Конец спецификации TZ1_05**
