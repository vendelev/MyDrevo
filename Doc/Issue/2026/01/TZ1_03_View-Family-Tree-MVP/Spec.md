# Спецификация бизнес-требований TZ1_03

## Метаинформация

- **Номер задачи:** TZ1_03
- **Эпик:** TZ1 — Веб-сайт семейного генеалогического древа
- **Этап:** Stage 3 — Просмотр дерева (MVP: список персон с многоязычными именами/фамилиями)
- **Дата создания:** 2026-01-22
- **Статус:** Черновик

## Описание проблемы/потребности

### Контекст

После завершения этапов 1 и 2 проект имеет:

- Готовую схему базы данных SQLite с мигрированными данными генеалогического древа
- Доменную модель (Entity: Person, Name, Surname, Relation, User) с поддержкой многоязычности
- Репозитории для работы с данными через многоязычную схему БД

Текущее состояние:

- В БД есть реальные данные о персонах, именах, фамилиях и связях
- Схема поддерживает многоязычность (русский/английский)
- Схема поддерживает гендерные формы (Иванович/Ивановна, Петров/Петрова)
- Бизнес-логика изолирована от деталей БД через репозитории

### Проблема

**КРИТИЧНО:** Пользователь НЕ может увидеть данные своего генеалогического древа, потому что:

1. **Отсутствие пользовательского интерфейса:** Нет веб-страниц для просмотра списка персон и связей
2. **Нет точки входа в приложение:** Пользователь не знает, куда перейти для просмотра данных
3. **Невозможность оценить прогресс:** Стейкхолдеры не могут увидеть работающий продукт
4. **Невозможность проверить корректность данных:** Пользователь не может убедиться, что его данные корректно отображаются с правильными гендерными формами и языковыми вариантами
5. **Нет демонстрируемого результата:** Нельзя показать "первый полезный экран" с реальными данными

### Бизнес-ценность решения

Реализация просмотра дерева обеспечит:

- **Первый полезный экран:** Пользователь сможет увидеть свои данные в понятном виде
- **Демонстрируемый результат:** Стейкхолдеры смогут оценить прогресс разработки
- **Проверка корректности миграции:** Пользователь сможет убедиться, что данные корректно перенесены из MySQL в SQLite
- **Проверка многоязычности:** Возможность переключения языка и проверки корректности переводов
- **Проверка гендерных форм:** Убедиться, что фамилии и отчества отображаются в правильных формах
- **Основу для дальнейшей разработки:** Интерфейс просмотра станет базой для редактирования (этап 4) и управления связями (этап 5)
- **Обратную связь от пользователей:** Возможность получить раннее feedback о структуре данных и интерфейсе

## Функциональные требования

### FR-1. Главная страница с выбором языка

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять главную страницу, которая позволяет пользователю выбрать язык интерфейса и перейти к просмотру данных.

**Детализация:**

#### FR-1.1. Маршрут главной страницы

Создать маршрут `GET /` с контроллером, который:

- Отображает страницу выбора языка
- Предлагает выбор между русским (ru) и английским (en)
- Содержит ссылки на `/persons?lang=ru` и `/persons?lang=en`

**Требования:**

- Страница должна быть простой и понятной
- Заголовок страницы: "Семейное генеалогическое древо" / "Family Genealogy Tree"
- Кнопки/ссылки выбора языка должны быть визуально заметными

#### FR-1.2. Blade-шаблон главной страницы

Создать Blade-шаблон `home.blade.php` с:

- Заголовком на двух языках
- Кнопками выбора языка
- Простым оформлением (минимальный CSS)

**Критерии приемки FR-1:**

- ✅ Доступна главная страница по адресу `GET /`
- ✅ На странице есть выбор языка (русский/английский)
- ✅ Клик на "Русский" переводит на `/persons?lang=ru`
- ✅ Клик на "English" переводит на `/persons?lang=en`
- ✅ Страница имеет понятный заголовок на обоих языках

---

### FR-2. Механизм выбора и сохранения языка

**Приоритет:** Высокий

**Описание:**
Система должна позволять пользователю выбрать язык через GET-параметр и запоминать выбор в сессии.

**Детализация:**

#### FR-2.1. Чтение языка из GET-параметра

Создать middleware `LanguageMiddleware`, который:

1. Читает параметр `?lang=ru` или `?lang=en` из URL
2. Если параметр присутствует — сохраняет выбор в сессию
3. Если параметра нет — читает язык из сессии
4. Если в сессии нет языка — устанавливает дефолтный язык `ru`
5. Устанавливает язык в Laravel `App::setLocale($language)`

**Требования:**

- Поддерживаемые языки: `ru`, `en`
- Если передан неподдерживаемый язык — использовать `ru`
- Сессия должна хранить язык в ключе `app.language`

#### FR-2.2. Применение языка ко всем страницам

Зарегистрировать middleware в `web` группе маршрутов, чтобы:

- Все страницы автоматически получали язык из сессии
- Параметр `?lang=` был опциональным на последующих страницах

**Критерии приемки FR-2:**

- ✅ Параметр `?lang=ru` устанавливает русский язык
- ✅ Параметр `?lang=en` устанавливает английский язык
- ✅ Выбор языка сохраняется в сессии
- ✅ При переходе на другую страницу без параметра `?lang=` — используется язык из сессии
- ✅ По умолчанию (без параметра и без сессии) используется русский язык
- ✅ Неподдерживаемый язык игнорируется, используется дефолтный

---

### FR-3. Страница списка персон

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять страницу со списком всех персон пользователя с многоязычными именами и фамилиями в правильных гендерных формах.

**Детализация:**

#### FR-3.1. Маршрут списка персон

Создать маршрут `GET /persons` с контроллером `PersonController@index`, который:

1. Получает текущий язык из `App::getLocale()`
2. Получает тестового пользователя (первый пользователь из БД)
3. Загружает всех персон пользователя через `PersonRepository::findByUserId($userId, $language)`
4. Передает данные в Blade-шаблон

**Требования:**

- На этапе 3 авторизация НЕ реализована — используется тестовый пользователь
- Тестовый пользователь: первый пользователь из таблицы `gen_user` (ID=1 или первый по порядку)
- Использовать eager loading для избежания N+1 проблемы

#### FR-3.2. Отображение списка персон

Создать Blade-шаблон `persons/index.blade.php` со следующей информацией для каждой персоны:

**Обязательные поля:**

- Полное имя (имя + отчество + фамилия) на выбранном языке с правильной гендерной формой
- Дата рождения в формате YYYY-MM-DD (если известна)
- Дата смерти в формате YYYY-MM-DD (если известна)
- Девичья фамилия в формате "(дев. ...)" или "(nee ...)" только для женщин

**Формат отображения (примеры):**

Русский язык:

- Иван Петрович Сидоров, 1950-05-15
- Мария Ивановна Петрова (дев. Смирнова), 1955-03-20 — 2010-12-01

Английский язык:

- John Petrovich Sidorov, 1950-05-15
- Mary Ivanovna Petrova (nee Smirnova), 1955-03-20 — 2010-12-01

**Требования:**

- Каждая персона должна быть кликабельной ссылкой на карточку персоны
- Ссылка должна сохранять текущий язык: `/persons/{id}?lang={lang}`
- Умершие персоны должны визуально отличаться (например, серым цветом или пометкой)
- Список должен быть отсортирован по фамилии, затем по имени

#### FR-3.3. Навигация и смена языка

На странице списка персон должна быть:

- Кнопка/ссылка смены языка (переключение между ru/en)
- Ссылка на главную страницу
- Заголовок страницы на выбранном языке

**Критерии приемки FR-3:**

- ✅ Доступна страница списка персон по адресу `GET /persons`
- ✅ Список содержит всех персон тестового пользователя
- ✅ Каждая персона отображается с полным именем на выбранном языке
- ✅ Гендерные формы фамилий и отчеств корректны (Петров/Петрова, Иванович/Ивановна)
- ✅ Девичья фамилия отображается только для женщин в формате "(дев. ...)" / "(nee ...)"
- ✅ Отображаются даты рождения и смерти (если есть)
- ✅ Умершие персоны визуально отличаются
- ✅ Каждая персона является кликабельной ссылкой на карточку
- ✅ Есть кнопка смены языка
- ✅ Список отсортирован по фамилии и имени
- ✅ Нет N+1 проблемы (используется eager loading)

---

### FR-4. Карточка персоны с детальной информацией

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять страницу с детальной информацией о персоне, включая связи с другими персонами.

**Детализация:**

#### FR-4.1. Маршрут карточки персоны

Создать маршрут `GET /persons/{person}` с контроллером `PersonController@show`, который:

1. Получает текущий язык из `App::getLocale()`
2. Загружает персону через `PersonRepository::findById($id, $language)`
3. Если персона не найдена — возвращает 404
4. Загружает связи персоны через `RelationRepository::findByPersonId($id)`
5. Для каждой связанной персоны загружает данные через `PersonRepository::findById($relatedId, $language)`
6. Группирует связи по типам (родители/дети/супруги)
7. Передает данные в Blade-шаблон

**Требования:**

- Использовать eager loading для избежания N+1
- Проверять, что персона принадлежит тестовому пользователю (безопасность)

#### FR-4.2. Отображение основных данных персоны

Создать Blade-шаблон `persons/show.blade.php` со следующими разделами:

**Раздел "Основная информация":**

- Полное имя на выбранном языке с правильной гендерной формой
- Дата рождения (если есть)
- Дата смерти (если есть)
- Возраст (вычислить из дат, если возможно)
- Девичья фамилия (если есть и персона — женщина)
- Статус: "Жив" / "Умер" / "Неизвестно"

**Раздел "Дополнительная информация":**

- Текст из `gen_person_info_lang` на выбранном языке
- Если информации нет — показать "Нет дополнительной информации"

**Требования:**

- Информация должна быть структурирована и легко читаться
- Пустые поля не должны отображаться (например, если нет даты смерти)
- Возраст должен вычисляться корректно (полные годы)

#### FR-4.3. Отображение связанных персон

На карточке персоны должны быть разделы:

**Раздел "Родители"** — список персон с типом связи PARENT_CHILD (где текущая персона — ребенок)

- Отображать для каждого родителя:
  - Полное имя с гендерной формой
  - Годы жизни в формате "YYYY-MM-DD — YYYY-MM-DD" или "YYYY-MM-DD" (если жив)
  - Ссылка на карточку родителя

**Раздел "Дети"** — список персон с типом связи PARENT_CHILD (где текущая персона — родитель)

- Отображать для каждого ребенка:
  - Полное имя с гендерной формой
  - Годы жизни
  - Ссылка на карточку ребенка

**Раздел "Супруги"** — список персон с типом связи SPOUSE

- Отображать для каждого супруга:
  - Полное имя с гендерной формой
  - Годы жизни
  - Ссылка на карточку супруга

**Требования:**

- Если нет связей определенного типа — показать "Нет родителей" / "Нет детей" / "Нет супругов"
- Связи должны быть сгруппированы и визуально разделены
- Ссылки на связанных персон должны сохранять текущий язык

#### FR-4.4. Навигация на карточке персоны

На карточке персоны должна быть:

- Кнопка "Назад к списку" → `/persons?lang={lang}`
- Кнопка смены языка
- Ссылка на главную страницу
- Заголовок страницы с именем персоны

**Критерии приемки FR-4:**

- ✅ Доступна карточка персоны по адресу `GET /persons/{id}`
- ✅ Отображается полное имя на выбранном языке с правильной гендерной формой
- ✅ Отображаются даты рождения и смерти (если есть)
- ✅ Отображается возраст (если можно вычислить)
- ✅ Отображается девичья фамилия для женщин
- ✅ Отображается дополнительная информация на выбранном языке
- ✅ Отображаются связанные персоны, сгруппированные по типам (родители/дети/супруги)
- ✅ Для каждой связанной персоны отображается полное имя и годы жизни
- ✅ Каждая связанная персона является кликабельной ссылкой
- ✅ Ссылки сохраняют текущий язык
- ✅ Есть навигация (назад к списку, смена языка, главная страница)
- ✅ Если персона не найдена — возвращается 404
- ✅ Нет N+1 проблемы

---

### FR-5. Корректное отображение гендерных форм

**Приоритет:** Высокий

**Описание:**
Система должна корректно отображать гендерные формы имен и фамилий в зависимости от пола персоны.

**Детализация:**

#### FR-5.1. Логика выбора гендерной формы фамилии

Для фамилии используется:

- Если персона — мужчина (Gender::MALE): использовать `SurnameTranslation::maleSurname`
- Если персона — женщина (Gender::FEMALE): использовать `SurnameTranslation::femaleSurname`
- Если пол неизвестен (Gender::UNKNOWN): использовать первую доступную форму (мужскую)

**Пример:**

- Мужчина: "Петров"
- Женщина: "Петрова"

#### FR-5.2. Логика выбора гендерной формы отчества

Для отчества персоны используется:

- Если персона — мужчина: использовать `NameTranslation::malePatronymic` от имени отца
- Если персона — женщина: использовать `NameTranslation::femalePatronymic` от имени отца

**Пример:**

Отец: Иван (NameTranslation: malePatronymic="Иванович", femalePatronymic="Ивановна")

- Сын: "Иванович"
- Дочь: "Ивановна"

#### FR-5.3. Отображение девичьей фамилии

Девичья фамилия (`birthSurname`) отображается только для женщин в формате:

- Русский язык: "(дев. Смирнова)"
- Английский язык: "(nee Smirnova)"

**Требования:**

- Для мужчин девичья фамилия НЕ отображается, даже если заполнена в БД
- Для женщин без девичьей фамилии ничего не отображается
- Девичья фамилия должна быть на выбранном языке с женской формой

**Критерии приемки FR-5:**

- ✅ Фамилии отображаются в правильной гендерной форме (Петров/Петрова)
- ✅ Отчества отображаются в правильной гендерной форме (Иванович/Ивановна)
- ✅ Девичья фамилия отображается только для женщин
- ✅ Формат девичьей фамилии зависит от языка: "(дев. ...)" для ru, "(nee ...)" для en
- ✅ При Gender::UNKNOWN используется первая доступная форма
- ✅ Нет ошибок типа "Мария Иванович Петров"

---

### FR-6. Фильтрация данных по тестовому пользователю

**Приоритет:** Высокий

**Описание:**
На этапе 3 авторизация не реализована, поэтому данные фильтруются по одному тестовому пользователю.

**Детализация:**

#### FR-6.1. Выбор тестового пользователя

Логика выбора тестового пользователя:

1. Получить первого пользователя из таблицы `gen_user` (ORDER BY ID LIMIT 1)
2. Если пользователей нет — показать сообщение "Нет данных для отображения"

**Требования:**

- Логика должна быть централизована (например, в сервисе или helper)
- Код должен быть готов к замене на реальную авторизацию на этапе 7

#### FR-6.2. Фильтрация персон по пользователю

Все запросы к репозиториям должны фильтровать данные по `userId`:

- `PersonRepository::findByUserId($userId, $language)` — получить персон пользователя
- `RelationRepository::findByUserId($userId)` — получить связи персон пользователя

**Требования:**

- Персоны других пользователей НЕ должны отображаться
- Связи между персонами разных пользователей НЕ должны отображаться
- Проверка принадлежности персоны пользователю при открытии карточки (безопасность)

**Критерии приемки FR-6:**

- ✅ Отображаются только персоны тестового пользователя
- ✅ Попытка открыть персону другого пользователя возвращает 404
- ✅ Связи фильтруются по пользователю
- ✅ Если в БД нет пользователей — показывается понятное сообщение

---

### FR-7. Обработка отсутствующих переводов (Fallback)

**Приоритет:** Средний

**Описание:**
Система должна корректно обрабатывать ситуации, когда перевода имени/фамилии нет на выбранном языке.

**Детализация:**

#### FR-7.1. Логика fallback для имен и фамилий

Если для выбранного языка нет перевода:

1. Использовать метод `Name::getFallbackTranslation()` / `Surname::getFallbackTranslation()`
2. Fallback возвращает первый доступный перевод (обычно русский)

**Требования:**

- Логика fallback реализована в доменной модели (этап 2)
- На этапе 3 контроллер просто использует эту логику
- Пользователь видит корректное имя, даже если нет перевода

#### FR-7.2. Логика fallback для дополнительной информации

Если в таблице `gen_person_info_lang` нет информации на выбранном языке:

1. Попробовать использовать информацию на дефолтном языке (ru)
2. Если информации нет вообще — показать "Нет дополнительной информации"

**Критерии приемки FR-7:**

- ✅ Если нет перевода имени на выбранный язык — отображается fallback (первый доступный)
- ✅ Если нет перевода фамилии — отображается fallback
- ✅ Если нет дополнительной информации на выбранном языке — показывается fallback или "Нет информации"
- ✅ Нет ошибок и пустых строк из-за отсутствия переводов

---

## Нефункциональные требования

### NFR-1. Производительность

**Описание:**
Страницы должны загружаться быстро на объеме до нескольких сотен персон.

**Критерии:**

- Список из 100 персон загружается менее чем за 1 секунду
- Карточка персоны со связями загружается менее чем за 0.5 секунды
- Используется eager loading для предотвращения N+1 проблемы
- Количество SQL-запросов для списка персон: не более 5 (независимо от количества персон)
- Количество SQL-запросов для карточки персоны: не более 10

**Проверка:**

- Измерить время загрузки на тестовых данных (100+ персон)
- Измерить количество SQL-запросов через Laravel Debugbar
- Запустить performance-тесты

---

### NFR-2. Понятность интерфейса

**Описание:**
Тексты и названия разделов должны быть понятны нетехническому пользователю на обоих языках.

**Критерии:**

- Заголовки страниц на русском и английском
- Кнопки имеют понятные названия ("Русский", "English", "Назад к списку")
- Разделы связей названы понятно ("Родители", "Дети", "Супруги")
- Пустые состояния имеют понятные сообщения ("Нет детей", "Нет дополнительной информации")
- Нет технических терминов в пользовательском интерфейсе

**Проверка:**

- Ревью интерфейса нетехническим пользователем
- Проверка корректности переводов

---

### NFR-3. Корректность отображения данных

**Описание:**
Все гендерные формы должны отображаться правильно, нет ошибок типа "Мария Иванович" или "Иван Петрова".

**Критерии:**

- Фамилии отображаются в правильной форме для пола персоны
- Отчества отображаются в правильной форме
- Девичьи фамилии отображаются только для женщин
- Формат дат единообразный (YYYY-MM-DD)
- Возраст вычисляется корректно

**Проверка:**

- Ручное тестирование на тестовых данных
- Автоматические E2E тесты для проверки гендерных форм

---

### NFR-4. Поддержка многоязычности

**Описание:**
Система должна корректно работать на русском и английском языках с fallback на русский.

**Критерии:**

- Поддерживаемые языки: ru, en
- Переключение языка работает без перезагрузки приложения
- Выбор языка сохраняется в сессии
- Если перевода нет — отображается дефолтный русский вариант
- Интерфейс (кнопки, заголовки) переведен на оба языка

**Проверка:**

- Тестирование на обоих языках
- Проверка fallback-логики

---

### NFR-5. Безопасность (ограниченная на этапе 3)

**Описание:**
На этапе 3 авторизация не реализована, но должны быть базовые проверки безопасности.

**Критерии:**

- Пользователь не может видеть персон других пользователей (фильтрация по userId)
- Попытка открыть персону другого пользователя возвращает 404
- Нет SQL-инъекций (используются параметризованные запросы)
- Нет XSS-уязвимостей (экранирование вывода в Blade)

**Проверка:**

- Попытаться открыть персону с неправильным ID
- Попытаться передать специальные символы в параметрах

---

### NFR-6. Простота поддержки и расширения

**Описание:**
Код должен быть готов к добавлению авторизации на этапе 7 и редактирования на этапе 4.

**Критерии:**

- Логика выбора тестового пользователя централизована (легко заменить на реальную авторизацию)
- Контроллеры используют репозитории (не работают с БД напрямую)
- Blade-шаблоны структурированы и переиспользуемы
- Код следует принципам Clean Architecture и CQRS

**Проверка:**

- Проверка структуры кода
- Соответствие архитектурным правилам проекта

---

## Модель предметной области

Этап 3 использует доменную модель, созданную на этапе 2. Основные сущности:

### Основные Entity

#### Person (Персона)

**Описание:** Человек в генеалогическом древе.

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец дерева
- `firstName: Name` — имя (многоязычное)
- `middleName: ?Name` — отчество (опционально)
- `surname: ?Surname` — текущая фамилия (опционально)
- `birthSurname: ?Surname` — девичья фамилия (опционально)
- `birthDate: ?DateTime` — дата рождения
- `deathDate: ?DateTime` — дата смерти
- `info: array<string, string>` — описание по языкам
- `gender: Gender` — пол персоны

**Методы для этапа 3:**

- `getFullName(string $language): string` — получить полное имя на нужном языке
- `getAge(): ?int` — получить возраст
- `isAlive(): bool` — жив ли человек

#### Name (Имя/Отчество)

**Атрибуты:**

- `translations: array<NameTranslation>` — переводы на языки

**Методы:**

- `getTranslation(string $language): ?NameTranslation`
- `getFallbackTranslation(): NameTranslation`

#### Surname (Фамилия)

**Атрибуты:**

- `translations: array<SurnameTranslation>` — переводы на языки

**Методы:**

- `getTranslation(string $language): ?SurnameTranslation`
- `getFallbackTranslation(): SurnameTranslation`

#### Relation (Связь)

**Атрибуты:**

- `personId1: int` — первая персона
- `personId2: int` — вторая персона
- `type: RelationType` — тип связи

#### User (Пользователь)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `login: string` — логин
- `email: string` — email

### Value Objects

#### NameTranslation (Перевод имени)

**Атрибуты:**

- `language: string` — код языка
- `name: string` — само имя
- `malePatronymic: ?string` — отчество для сына
- `femalePatronymic: ?string` — отчество для дочери

**Методы:**

- `getPatronymic(Gender $gender): ?string`

#### SurnameTranslation (Перевод фамилии)

**Атрибуты:**

- `language: string` — код языка
- `maleSurname: string` — мужская форма
- `femaleSurname: string` — женская форма

**Методы:**

- `getSurname(Gender $gender): string`

### Enumerations

#### Gender (Пол)

**Значения:**

- `MALE` — мужской
- `FEMALE` — женский
- `UNKNOWN` — неизвестный

#### RelationType (Тип связи)

**Значения:**

- `PARENT_CHILD` — Родитель → Ребенок
- `SPOUSE` — Супруг/Супруга

---

## Зависимости

### Внешние зависимости

- **Laravel 12** — фреймворк для web routes, контроллеров, Blade
- **PHP 8.5** — язык программирования
- **SQLite** — СУБД с данными

### Внутренние зависимости

Этап 3 **зависит** от:

- **Этап 1 (TZ1_01)** — требует готовую схему БД с мигрированными данными
- **Этап 2 (TZ1_02)** — требует доменную модель и репозитории

Этап 3 **является блокирующим** для:

- **Этап 4** — Управление персонами (использует те же страницы для редактирования)
- **Этап 5** — Управление связями (использует карточку персоны для отображения связей)
- **Этап 6** — Визуализация дерева (использует данные из репозиториев)

---

## Сценарии использования

### UC-1. Пользователь просматривает дерево на русском языке

**Актор:** Пользователь

**Предусловия:**

- В БД есть тестовый пользователь с персонами
- Персоны имеют имена и фамилии с русскими переводами

**Основной сценарий:**

1. Пользователь открывает браузер и переходит на `http://localhost/`
2. Видит главную страницу с заголовком "Семейное генеалогическое древо"
3. Кликает на кнопку "Русский"
4. Переходит на страницу `/persons?lang=ru`
5. Видит список родственников с русскими именами и правильными гендерными формами:
   - "Иван Петрович Сидоров, 1950-05-15"
   - "Мария Ивановна Петрова (дев. Смирнова), 1955-03-20 — 2010-12-01"
6. Кликает на "Иван Петрович Сидоров"
7. Переходит на `/persons/1?lang=ru`
8. Видит карточку персоны с детальной информацией:
   - Дата рождения: 1950-05-15
   - Возраст: 75 лет
   - Статус: Жив
   - Родители: Петр Иванович Сидоров, Анна Сергеевна Сидорова
   - Дети: Алексей Иванович Сидоров, Елена Ивановна Петрова
   - Супруга: Мария Ивановна Сидорова (дев. Смирнова)
9. Кликает на "Алексей Иванович Сидоров"
10. Видит карточку сына

**Постусловия:**

- Пользователь успешно просмотрел данные на русском языке
- Все гендерные формы корректны

---

### UC-2. Пользователь переключается на английский язык

**Актор:** Пользователь

**Предусловия:**

- Пользователь на странице `/persons?lang=ru`
- В БД есть английские переводы имен и фамилий

**Основной сценарий:**

1. На странице списка персон кликает на кнопку "English"
2. Переходит на `/persons?lang=en`
3. Видит тех же персон, но с английскими именами:
   - "John Petrovich Sidorov, 1950-05-15"
   - "Mary Ivanovna Petrova (nee Smirnova), 1955-03-20 — 2010-12-01"
4. Кликает на "John Petrovich Sidorov"
5. Видит карточку на английском языке:
   - Birth date: 1950-05-15
   - Age: 75 years
   - Status: Alive
   - Parents: Peter Ivanovich Sidorov, Anna Sergeevna Sidorova
6. Переходит обратно к списку
7. Язык остается английским (сохранен в сессии)

**Постусловия:**

- Интерфейс переведен на английский
- Имена и фамилии отображаются на английском
- Выбор языка сохранен в сессии

---

### UC-3. Стейкхолдер оценивает прогресс проекта

**Актор:** Стейкхолдер (заказчик/куратор)

**Предусловия:**

- Проект развернут и доступен
- В БД есть тестовые данные

**Основной сценарий:**

1. Стейкхолдер открывает сайт в браузере
2. Видит главную страницу с выбором языка
3. Выбирает русский язык
4. Видит список персон семейного древа
5. Проверяет корректность отображения:
   - Имена отображаются правильно
   - Фамилии имеют правильные гендерные формы
   - Даты отформатированы единообразно
6. Открывает карточку персоны
7. Проверяет отображение связей (родители, дети, супруги)
8. Переключает язык на английский
9. Проверяет корректность переводов
10. Подтверждает, что "первый полезный экран" работает
11. Одобряет прогресс разработки

**Постусловия:**

- Стейкхолдер получил демонстрируемый результат
- Подтверждена корректность миграции данных
- Подтверждена работа многоязычности

---

### UC-4. Пользователь без данных открывает сайт

**Актор:** Пользователь

**Предусловия:**

- В БД нет пользователей или у пользователя нет персон

**Основной сценарий:**

1. Пользователь открывает сайт
2. Выбирает язык
3. Переходит на страницу списка персон
4. Видит сообщение "Нет данных для отображения"

**Постусловия:**

- Система корректно обработала пустое состояние
- Нет ошибок

---

### UC-5. Система обрабатывает отсутствие переводов

**Актор:** Система

**Предусловия:**

- В БД есть персоны
- Некоторые имена/фамилии не имеют английских переводов

**Основной сценарий:**

1. Пользователь выбирает английский язык
2. Система пытается загрузить персоны с английскими переводами
3. Для персоны без английского перевода имени:
   - Вызывается `Name::getFallbackTranslation()`
   - Возвращается русский вариант
4. Система отображает персону с русским именем на английской странице
5. Пользователь видит смешанный контент (часть на английском, часть на русском)

**Постусловия:**

- Нет ошибок из-за отсутствия переводов
- Fallback работает корректно

---

## Риски

### Риск 1. Неполнота языковых данных в БД

**Описание:**
Если в БД не все имена/фамилии имеют переводы на английский, пользователь увидит смешанный контент.

**Вероятность:** Высокая (реальные данные могут не иметь переводов)

**Влияние:** Среднее (не критично для MVP)

**Меры снижения:**

- Реализовать fallback-логику (FR-7)
- Документировать требования к языковым данным
- На этапе тестирования проверить данные и добавить недостающие переводы

**План реагирования:**

- Если обнаружены пробелы — создать миграцию для добавления переводов
- Добавить команду для генерации автоматических переводов (будущее)

---

### Риск 2. Ошибки в определении пола персоны

**Описание:**
Если пол персоны не указан или указан неправильно, гендерная форма будет неверной.

**Вероятность:** Средняя (на этапе 2 используется Gender::UNKNOWN)

**Влияние:** Высокое (некорректное отображение данных)

**Меры снижения:**

- Использовать Gender::UNKNOWN с fallback на мужскую форму (FR-5)
- На этапе 4 добавить явное поле пола в БД
- На этапе 4 реализовать логику определения пола по окончанию фамилии

**План реагирования:**

- Если обнаружены ошибки — добавить тесты для проверки гендерных форм
- На этапе 4 исправить логику определения пола

---

### Риск 3. Производительность на больших объемах данных

**Описание:**
Если у пользователя тысячи персон, страница списка может загружаться долго.

**Вероятность:** Низкая (для учебного проекта)

**Влияние:** Высокое (плохой UX)

**Меры снижения:**

- Использовать eager loading (FR-3, NFR-1)
- Измерять производительность на тестовых данных
- Добавить пагинацию на будущих этапах (если потребуется)

**План реагирования:**

- Если обнаружена N+1 проблема — оптимизировать запросы
- Если страница грузится медленно — добавить пагинацию или кеширование

---

### Риск 4. Несовместимость с будущими этапами

**Описание:**
Код этапа 3 может потребовать значительных изменений при добавлении авторизации (этап 7) или редактирования (этап 4).

**Вероятность:** Средняя

**Влияние:** Среднее (потребуется рефакторинг)

**Меры снижения:**

- Следовать принципам Clean Architecture (NFR-6)
- Централизовать логику выбора тестового пользователя (FR-6)
- Использовать репозитории (не работать с БД напрямую)
- Структурировать Blade-шаблоны для переиспользования

**План реагирования:**

- На этапе 7 заменить логику выбора тестового пользователя на реальную авторизацию
- На этапе 4 добавить формы редактирования в те же шаблоны

---

### Риск 5. Проблемы с сессиями в Docker-окружении

**Описание:**
Сессии могут не работать корректно в Docker-контейнерах (например, не сохраняться между запросами).

**Вероятность:** Низкая (Laravel хорошо работает в Docker)

**Влияние:** Критическое (выбор языка не сохраняется)

**Меры снижения:**

- Использовать стандартный session driver Laravel (file или database)
- Проверить конфигурацию сессий в `.env`
- Протестировать сохранение сессии после выбора языка

**План реагирования:**

- Если сессии не работают — переключиться на database session driver
- Проверить настройки cookie (domain, secure, httponly)

---

## Критерии приемки

### Критерии приемки этапа

Этап считается завершенным, если выполнены **все** следующие критерии:

#### Критерии по функциональности

- ✅ Доступна главная страница `GET /` с выбором языка
- ✅ Доступна страница списка персон `GET /persons`
- ✅ Доступна карточка персоны `GET /persons/{id}`
- ✅ Можно переключить язык через параметр `?lang=ru` или `?lang=en`
- ✅ Выбор языка сохраняется в сессии
- ✅ Отображаются только персоны тестового пользователя
- ✅ Полные имена отображаются на выбранном языке
- ✅ Гендерные формы фамилий и отчеств корректны
- ✅ Девичья фамилия отображается только для женщин в правильном формате
- ✅ Даты рождения и смерти отображаются в едином формате
- ✅ Возраст вычисляется корректно
- ✅ Связи отображаются на карточке персоны, сгруппированные по типам
- ✅ Для каждой связанной персоны отображается полное имя и годы жизни
- ✅ Все ссылки работают и сохраняют текущий язык
- ✅ Навигация работает (назад к списку, смена языка, главная)
- ✅ Fallback-логика работает при отсутствии переводов

#### Критерии по интерфейсу

- ✅ Интерфейс понятен нетехническому пользователю
- ✅ Заголовки и кнопки переведены на оба языка
- ✅ Пустые состояния имеют понятные сообщения
- ✅ Умершие персоны визуально отличаются
- ✅ Список персон отсортирован по фамилии и имени

#### Критерии по производительности

- ✅ Список из 100 персон загружается менее чем за 1 секунду
- ✅ Карточка персоны загружается менее чем за 0.5 секунды
- ✅ Используется eager loading (нет N+1 проблемы)
- ✅ Количество SQL-запросов для списка: не более 5
- ✅ Количество SQL-запросов для карточки: не более 10

#### Критерии по безопасности

- ✅ Пользователь не может видеть персон других пользователей
- ✅ Попытка открыть персону другого пользователя возвращает 404
- ✅ Нет SQL-инъекций (параметризованные запросы)
- ✅ Нет XSS-уязвимостей (экранирование в Blade)

#### Критерии по тестам

- ✅ Написаны E2E тесты для просмотра списка персон на разных языках
- ✅ Тесты проверяют корректность гендерных форм
- ✅ Тесты проверяют отображение связей на карточке персоны
- ✅ Тесты проверяют навигацию и смену языка
- ✅ Тесты проверяют fallback-логику
- ✅ Тесты проверяют производительность (отсутствие N+1)

#### Критерии по коду

- ✅ Код соответствует стилю проекта (.ai/rules/CodeStyle.md)
- ✅ Код проходит статический анализ PHPStan без ошибок
- ✅ Код проходит проверку PHP_CodeSniffer без ошибок
- ✅ Контроллеры используют репозитории (не работают с БД напрямую)
- ✅ Blade-шаблоны структурированы и переиспользуемы
- ✅ Логика выбора тестового пользователя централизована

---

## Не входит в реализацию

Следующие функции **НЕ входят** в реализацию текущего этапа:

### Не входит в Stage 3

- ❌ **Авторизация и аутентификация** — будет реализована на Stage 7
- ❌ **Редактирование персон** — будет реализовано на Stage 4
- ❌ **Создание новых персон** — будет реализовано на Stage 4
- ❌ **Удаление персон** — будет реализовано на Stage 4
- ❌ **Управление связями (создание/удаление)** — будет реализовано на Stage 5
- ❌ **Визуализация дерева (графическая)** — будет реализована на Stage 6
- ❌ **Пагинация списка персон** — будет добавлена при необходимости на Stage 6
- ❌ **Поиск персон** — будет реализован на Stage 6
- ❌ **Фильтрация персон** — будет реализована на Stage 6
- ❌ **Сортировка персон (кроме дефолтной по фамилии)** — будет добавлена на Stage 6
- ❌ **Экспорт данных** — не входит в эпик TZ1
- ❌ **Импорт данных** — не входит в эпик TZ1
- ❌ **Загрузка фотографий персон** — не входит в эпик TZ1
- ❌ **Комментарии к персонам** — не входит в эпик TZ1

### Допущения текущего этапа

На текущем этапе допускаются следующие упрощения:

- ✅ **Один тестовый пользователь** — авторизация будет на Stage 7
- ✅ **Минимальный дизайн** — улучшение UX будет на Stage 6
- ✅ **Только просмотр** — редактирование будет на Stage 4
- ✅ **Без пагинации** — добавится при необходимости на Stage 6
- ✅ **Без поиска и фильтров** — добавятся на Stage 6
- ✅ **Gender::UNKNOWN для персон** — определение пола будет улучшено на Stage 4

---

## Дополнительные замечания

### Важные особенности реализации

1. **Первый полезный экран критичен:** Этап 3 — это первая возможность увидеть работающий продукт с реальными данными. Важно, чтобы все отображалось корректно.

2. **Многоязычность — ключевая особенность:** Проект должен демонстрировать работу сложной многоязычной модели с гендерными формами.

3. **Производительность важна:** Без eager loading система будет работать очень медленно на реальных объемах данных.

4. **Готовность к расширению:** Код должен быть готов к добавлению авторизации (Stage 7) и редактирования (Stage 4).

5. **Простота интерфейса:** На этапе 3 дизайн не критичен, но интерфейс должен быть понятным и функциональным.

### Рекомендации по реализации

1. **Начать с главной страницы и middleware:** Сначала реализовать выбор языка, затем списки и карточки.

2. **Тестировать на реальных данных:** Использовать существующие данные из БД для проверки корректности отображения.

3. **Использовать компоненты Blade:** Создать переиспользуемые компоненты для отображения персон, связей, навигации.

4. **Логировать SQL-запросы:** При разработке проверять количество запросов через Debugbar.

5. **Проверять edge-кейсы:** Персоны без имен, без связей, без переводов и т.д.

---

## Глоссарий

- **Главная страница** — стартовая страница сайта с выбором языка
- **Список персон** — страница со всеми персонами пользователя
- **Карточка персоны** — детальная страница одной персоны со связями
- **Гендерная форма** — разная форма слова для мужчин и женщин (Петров/Петрова)
- **Девичья фамилия** — фамилия женщины до замужества
- **Fallback** — резервный вариант (дефолтный язык при отсутствии перевода)
- **Eager loading** — предварительная загрузка связанных данных
- **N+1 проблема** — ситуация, когда загрузка N объектов выполняет N+1 SQL-запросов
- **Тестовый пользователь** — первый пользователь из БД, используемый до реализации авторизации
- **Middleware** — промежуточное ПО для обработки HTTP-запросов
- **Blade** — шаблонизатор Laravel для генерации HTML
- **Сессия** — механизм хранения данных между HTTP-запросами

---

**Конец спецификации TZ1_03**
