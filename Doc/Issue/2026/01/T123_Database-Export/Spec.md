# Спецификация: T123 Database-Export - Этап 1 MVP экспорта данных

## Описание проблемы/потребности

Пользователи сайта генеалогического древа не имеют возможности самостоятельно получить выгрузку своих данных из системы. Это создает проблемы с резервным копированием, переносом данных в другие системы, анализом и повышает риск потери данных. В рамках этапа 1 требуется реализовать базовую функциональность экспорта данных в формате JSON, позволяющую авторизованному пользователю инициировать экспорт и скачать файл с данными, доступными ему в системе.

## Функциональные требования

1. Пользователь может инициировать экспорт из интерфейса приложения (например, в личном кабинете или на странице профиля).
2. После запуска экспорта пользователь получает файл экспорта для скачивания в рамках одного действия.
3. Экспорт содержит только данные, доступные текущему авторизованному пользователю.
4. Экспорт формируется в формате JSON.
5. Состав данных для экспорта включает:
   - Данные учетной записи пользователя (минимально необходимые поля, без секретов: идентификатор, email, имя и другие профильные данные).
   - Данные домена "генеалогическое древо", принадлежащие пользователю (профили членов семьи, связи/отношения, заметки/описания).
   - Медиа: только метаданные (имя, тип, дата загрузки), без бинарных файлов.
6. Если экспорт невозможно сформировать, пользователю показывается понятное сообщение об ошибке.

## Нефункциональные требования

- **Безопасность**: Экспорт возможен только для авторизованного пользователя; файл не должен содержать секреты (пароли, токены, технические ключи).
- **Понятность**: Пользователь понимает, где запустить экспорт и что он получит.
- **Надежность**: При типовых ошибках (например, временная недоступность хранилища) пользователь получает корректную ошибку.
- **Производительность**: Формирование экспорта не должно существенно ухудшать работу системы для остальных пользователей.
- **Usability**: Процесс экспорта должен быть понятен нетехническому пользователю.

## Модель предметной области

Основные сущности (Entity) и объекты значения (ValueObject), участвующие в экспорте данных:

- **Entity:**
  - **User**: Представляет пользователя системы, содержит идентификатор, email, имя и другие профильные данные.
  - **FamilyMember**: Представляет члена семьи в генеалогическом древе, включает профильные данные, даты жизни, связи.
  - **Relation**: Представляет отношения между членами семьи (родитель-ребенок, супруги и т.д.).

- **ValueObject:**
  - **ExportFormat**: Определяет формат экспорта (JSON для MVP).
  - **MediaMetadata**: Метаданные медиа-файлов (имя, тип, дата загрузки), без бинарных данных.

## Зависимости

- Наличие механизма аутентификации и авторизации пользователя (минимум — базовая авторизация для доступа к экспорту).
- Возможность формировать файл и отдавать его пользователю безопасным способом (через HTTP response с правильными headers).
- Доступ к базе данных для извлечения данных пользователя.

## Сценарии использования

1. **Пользователь скачивает экспорт**
   - Пользователь открывает страницу профиля/кабинета.
   - Нажимает "Экспортировать данные".
   - Система формирует JSON-файл и предлагает скачать.

2. **Экспорт недоступен из-за ошибки**
   - Пользователь нажимает "Экспортировать данные".
   - Возникает ошибка формирования (например, проблемы с базой данных).
   - Система показывает сообщение "Экспорт не удалось сформировать. Попробуйте позже".

3. **Экспорт пустых данных**
   - Пользователь без данных в системе инициирует экспорт.
   - Система формирует минимальный JSON-файл с соответствующим сообщением или пустой структурой.

## Риски

- **Риск утечки данных**: При ошибках в разграничении доступа может произойти выгрузка чужих данных.
- **Объем данных**: Для пользователей с большим количеством данных экспорт может занять значительное время или нагрузить систему.
- **Согласование состава данных**: Необходимость точного определения, какие данные включать, чтобы избежать включения чувствительной информации.
- **Изменения схемы БД**: Со временем изменения в структуре базы данных могут повлиять на совместимость экспорта.
- **Ошибки реализации**: Неправильная логика экспорта может привести к некорректным данным или сбоям системы.

## Критерии приемки

1. Авторизованный пользователь видит действие "Экспортировать данные" в интерфейсе.
2. Нажатие на действие приводит к скачиванию файла в формате JSON.
3. В файле отсутствуют чужие данные и отсутствуют секреты (пароли/токены).
4. Минимальный состав данных соответствует требованиям (данные пользователя, члены семьи, отношения, метаданные медиа).
5. При искусственно вызванной ошибке пользователь получает понятное сообщение, без технических деталей.
6. Экспорт работает для пользователей с различным объемом данных (пустые, малые, средние объемы).
7. Файл экспорта имеет корректное имя и расширение (.json).

## Не входит в реализацию

В рамках этапа 1 не будет реализовано:
- Асинхронная генерация экспорта (все происходит синхронно).
- Статус экспорта и история экспортов.
- Хранение файлов экспорта с ограниченным сроком жизни.
- Экспорт в форматах, отличных от JSON.
- Экспорт бинарных медиа-файлов.
- Интеграция с внешними сервисами.
- Автоматическое планирование экспортов.
- Импорт данных обратно в систему.