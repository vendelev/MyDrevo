# Мультиагентная разработка

***

## Общая концепция

Система состоит из команды специализированных агентов, координируемых оркестратором. 
Каждый агент выполняет определённую роль в процессе разработки. 

Оркестратор управляет последовательностью работы, передаёт результаты между агентами и останавливает процесс 
 при возникновении блокирующих вопросов.

***

## Роли агентов

### Оркестратор

**Функция:** 

- Координация всего процесса разработки
- Ставит задачи другим агентам
- Принимает и анализирует результаты
- Определяет следующие шаги
- Останавливает процесс при блокирующих вопросах
- Управляет циклами review-доработка

### Product Owner

**Функция:** [Описание бизнес потребностей и планирование этапов эпика](/Doc/Mode/Stage0CreateEpic.md) 

### Бизнес аналитик

**Функция:** [Создание спецификации с описанием бизнес-требований](/Doc/Mode/Stage1CreateSpec.md)

### Системный аналитик + IT архитектор

**Функция:** [Формирование сводного технического плана](/Doc/Mode/Stage2CreatePlanSummary.md)

### Системный аналитик + PHP разработчик

**Функция:** [Формирование технического плана по разработке кода](/Doc/Mode/Stage2CreatePlanDev.md)

### Системный аналитик + Разработчик тестов

**Функция:** [Формирование технического плана по написанию тестов](/Doc/Mode/Stage2CreatePlanTest.md)

### PHP разработчик

**Функция:** [Разработка программного кода](/Doc/Mode/Stage3Implementation.md)

### Разработчик тестов

**Функция:** [Разработка тестов](/Doc/Mode/Stage4Testing.md)

### Технический писатель

**Функция:** [Создание технической документации](/Doc/Mode/Stage5TechDoc.md)

### IT архитектор

**Функция:** [Создание архитектурной документации](/Doc/Mode/Stage6ArchDoc.md)

***

## Схема работы

На каждом этапе мультиагентной разработки шаги работы с агентами будут одинаковы:

1. Создаем новый контекст в режиме "**orchestrator**" и пишем ему команду (см описание каждого этапа).
2. Проводим ревью, вносим правки самостоятельно или даем команду на исправление агенту.
3. Делаем коммит самостоятельно или даем команду: `сделай коммит`.
   Команду агенту надо давать в задаче "**orchestrator**", чтобы агент, имея общий контекст, смог правильно 
   составить комментарий к коммиту.

### Workflow

- Первым выполняется Шаг 0, где создается эпик и этапы.
- Шаг 1 повторяется столько раз, сколько было создано этапов.
- Шаг 2 повторяется для каждого этапа непосредственно перед реализацией.
- Тк технический план тоже разбит на подэтапы, Шаги 3-6 повторяются для каждого подэтапа.
- На Шаге 7 создается человекочитаемая документация.
- На Шаге 8 создается архитектурная документация описывающая взаимодействие и зависимости всей системы.

## Рекомендации

Если задача не большая, то создавать эпик не обязательно. Можно сразу создать спецификацию с описанием 
 бизнес-требований.

После создания эпика создавайте по каждому этапу **только спецификации**.
А технические планы создавайте непосредственно перед началом реализации.

Создание технических планов "на будущее" приводит к тому, что после выполнения текущего этапа приходится 
 пересматривать план реализации следующего этапа.

Для уменьшения контекста и упрощения code-review технический план так же разбивается на несколько подэтапов реализации  
 + по отдельности разработка кода и написание тестов.

## Последовательность работ

### Шаг 0. Описание бизнес потребностей и планирование этапов эпика.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "create-epic" для описания бизнес-потребностей.
   Номер эпика: {номер эпика из трекера}.
   Описание потребностей: {.......}
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "create-epic".
   Дать ему команду: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям".
   Запущенный агент должен вернуть список файлов и список замечаний для каждого файла.
3. Если найдены замечания, то запусти нового агента в режиме "create-epic", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```

### Шаг 1. Создание спецификации с описанием бизнес-требований.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "create-spec" для описания бизнес-требований.
   Номер задачи: {номер задачи из трекера}.
   {Если выполнялся Этап {Х}, то пишем: Описание этика находится в файле @/Doc/Backlog/{YYYY}/{EPIC_FOLDER}/Summary.md. 
    Нужно создать описание бизнес-требований для этапа {Х} согласно инструкциям.} 
   {Если доработка небольшая и формирование эпика не требуется, то пишем: Описание бизнес-потребностей: .....}
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "create-spec".
   Дать ему команду: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям".
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "create-spec", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```

### Шаг 2. Формирование сводного технического плана.

**Рекомендация**:
```
Создавайте технический план непосредственно перед разработкой.
Создание плана "на будущее" приводит к тому, что после реализации текущего этапа приходится пересматривать план разработки следующего этапа.
```

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "create-plan-sum" и на основе бизнес требований из файла 
   @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Spec.md создай сводный план по разработке кода и тестов согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "create-plan-sum".
   Дать ему команду: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям".
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "create-plan-sum", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```

### Шаг 3. Формирование технического плана по разработке кода.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "create-plan-dev" и на основе бизнес требований и сводного плана по этапу {X}
   для задачи @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай новый план по разработке кода согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "create-plan-dev".
   Дать ему команду: "Перепроверь созданный файл на соответствие своим инструкциям".
   Для уменьшения контекста каждому агента надо давать задание по проверке только одного файла.
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "create-plan-dev", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```

### Шаг 4. Формирование технического плана по написанию тестов.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "create-plan-test" и на основе бизнес требований и сводного плана по этапу {X}
   для задачи @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай новый план по написанию тестов согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "create-plan-test".
   Дать ему команду: "Перепроверь созданный файл на соответствие своим инструкциям".
   Для уменьшения контекста каждому агента надо давать задание по проверке только одного файла.
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "create-plan-test", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```

### Шаг 5. Разработка программного кода

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "implementation" для разработки кода по этапу реализации {X} из файла 
   @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Task.md согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "implementation".
   Дать ему команду: "Перепроверь созданный файл на соответствие своим инструкциям".
   Для уменьшения контекста каждому агента надо давать задание по проверке только одного файла.
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "implementation", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
4. Запустите нового агента с режимом "code-auto-fix" для автоматического исправления кода и стиля
5. Запустите нового агента с режимом "phpstan" для исправления ошибок с типами
   Если агент вернул сообщение, что были найдены ошибки, то требуется перезапуск подзадачи.
   Повторяй перезапуск не более 2-х раз.
6. Запустите нового агента с режимом "rector" для исправления ошибок с типами
7. Запустите нового агента с режимом "phpcs" для исправления ошибок с типами
   Если агент вернул сообщение, что были найдены ошибки, то требуется перезапуск подзадачи.
   Повторяй перезапуск не более 2-х раз.
```

Проводим ревью, вносим правки самостоятельно или даем команду на исправление агенту.
Делаем коммит самостоятельно или даем команду: `сделай коммит`.

### Шаг 6. Написание тестов

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "testing" и напиши тесты для этапа реализации {X} из файла 
   @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Task.md согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "testing".
   Дать ему команду: "Перепроверь созданный файл на соответствие своим инструкциям".
   Для уменьшения контекста каждому агента надо давать задание по проверке только одного файла.
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "testing", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
4. Запустите нового агента с режимом "code-auto-fix" для автоматического исправления кода и стиля
5. Запустите нового агента с режимом "phpstan" для исправления ошибок с типами
   Если агент вернул сообщение, что были найдены ошибки, то требуется перезапуск подзадачи.
   Повторяй перезапуск не более 2-х раз.
6. Запустите нового агента с режимом "rector" для исправления ошибок с типами
7. Запустите нового агента с режимом "phpcs" для исправления ошибок с типами
   Если агент вернул сообщение, что были найдены ошибки, то требуется перезапуск подзадачи.
   Повторяй перезапуск не более 2-х раз.
8. Запустите нового агента с режимом "testing" дяя повторного запуска PHPUnit
9. В файле Task.md сделать пометку у соответствующего этапа реализации, что он выполнен (✅ Этап завершён).
```

Проводим ревью, вносим правки самостоятельно или даем команду на исправление агенту.
Делаем коммит самостоятельно или даем команду: `сделай коммит`.

### Шаг 7. Создание технической документации.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "tech-doc" и на основе бизнес требований и плана по разработке коди и тестов 
   в папке @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай техническую документацию согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "tech-doc".
   Дать ему команду: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям".
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "tech-doc", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```

### Шаг 8. Создание архитектурной документации.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Создай агента в режиме "arch-doc" и на основе бизнес требований и плана по разработке коди и тестов 
   в папке @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай техническую документацию согласно инструкциям.
   Запущенный агент должен вернуть список созданных или измененных файлов для последующей проверки.
2. По окончанию работы запущенного агента надо запустить нового агента в режиме "arch-doc".
   Дать ему команду: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям".
   Если найдены замечания, запущенный агент должен вернуть список замечаний для каждого файла, который нужно исправить.
3. Если найдены замечания, то запусти нового агента в режиме "arch-doc", чтобы он внес правки. 
   Для уменьшения контекста каждому агента надо давать задание по изменению только одного файла.
```
