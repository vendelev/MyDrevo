# Спецификация бизнес-требований TZ1_04_2

## Метаинформация

- **Номер задачи:** TZ1_04_2
- **Название:** Редактирование персоны с многоязычными данными и гендерными формами
- **Родительская задача:** TZ1_04 — Управление персонами (CRUD)
- **Эпик:** TZ1 — Веб-сайт семейного генеалогического древа
- **Этап:** Stage 4 — Управление персонами
- **Дата создания:** 2026-01-23
- **Статус:** Черновик

## Описание проблемы/потребности

### Контекст

После реализации задачи TZ1_04_1 (Создание персоны) пользователь может:

- Создавать новые персоны с многоязычными данными (русский/английский)
- Указывать имена, фамилии, отчества с поддержкой гендерных форм
- Выбирать пол персоны и автоматически получать корректные гендерные формы
- Указывать девичью фамилию для женщин
- Добавлять даты рождения/смерти и дополнительную информацию на разных языках

Текущее состояние:

- Пользователь может просматривать существующие персоны в своем генеалогическом древе
- Создавать новые персоны через форму `/persons/create`
- Все данные сохраняются в многоязычную схему БД с поддержкой гендерных форм
- Доменная модель и репозитории поддерживают операции обновления (методы save())

### Проблема

**КРИТИЧНО:** Пользователь НЕ может исправлять данные существующих персон, потому что:

1. **Невозможность исправления ошибок:** Нельзя отредактировать существующую персону при обнаружении ошибок (неверная дата, опечатка в имени/фамилии)
2. **Невозможность дополнения информации:** Нельзя добавить недостающие данные (например, дату смерти, дополнительную информацию на английском языке)
3. **Невозможность изменения многоязычных данных:** Нельзя отредактировать переводы имен/фамилий на разных языках
4. **Невозможность корректировки пола:** Нельзя исправить ошибочно указанный пол (что важно для корректных гендерных форм)
5. **Невозможность управления девичьей фамилией:** Нельзя добавить или изменить девичью фамилию для женщин
6. **Риск накопления ошибок:** Каждая неисправленная ошибка снижает качество данных генеалогического древа

### Примеры реальных ситуаций

**Ситуация 1: Исправление опечатки**
Пользователь создал персону "Иван Петрович Сидров", но правильная фамилия "Сидоров". Сейчас единственный способ исправить — удалить персону и создать заново, потеряв все связи.

**Ситуация 2: Дополнение информации**
Пользователь узнал точную дату смерти родственника и хочет добавить её в карточку. Нет интерфейса для редактирования.

**Ситуация 3: Исправление пола**
Пользователь ошибочно указал пол "Мужской" для персоны "Мария", теперь отображается некорректная фамилия "Петров" вместо "Петрова".

**Ситуация 4: Добавление переводов**
Пользователь создал персону только с русскими именем/фамилией, теперь хочет добавить английские переводы.

### Бизнес-ценность решения

Реализация редактирования персон обеспечит:

- **Высокое качество данных:** Возможность исправить любую ошибку, избежать накопления некорректных данных
- **Полнота информации:** Возможность дополнять данные по мере их получения
- **Гибкость управления:** Изменение любых полей персоны без потери связей с другими персонами
- **Корректность гендерных форм:** Возможность исправить пол и получить правильные формы фамилий/отчеств
- **Поддержка многоязычности:** Возможность добавлять и редактировать переводы на разных языках
- **Удобство использования:** Нет необходимости удалять и пересоздавать персону при обнаружении ошибок
- **Аудит изменений:** Отслеживание истории всех изменений персоны для контроля качества данных

## Функциональные требования

### FR-1. Маршрут и контроллер редактирования персоны

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять доступ к форме редактирования существующей персоны.

**Детализация:**

Создать маршрут `GET /persons/{person}/edit` с контроллером `PersonController@edit`, который:

1. Получает текущий язык из `App::getLocale()`
2. Получает ID тестового пользователя (первый пользователь из БД)
3. Загружает персону через `PersonRepository::findById($id, $language)`
4. Если персона не найдена — возвращает **404 Not Found**
5. Проверяет, что персона принадлежит текущему пользователю (безопасность)
6. Загружает все языковые варианты данных персоны:
   - Имя (ru, en) из `gen_name_lang`
   - Отчество (ru, en) из `gen_name_lang` (мужская и женская формы)
   - Фамилия (ru, en) из `gen_surname_lang` (мужская и женская формы)
   - Девичья фамилия (ru, en) если указана
   - Дополнительная информация (ru, en) из `gen_person_info_lang`
7. Загружает справочные данные для autocomplete:
   - Список существующих имен пользователя (для autocomplete)
   - Список существующих фамилий пользователя (для autocomplete)
   - Список родителей-мужчин (для автогенерации отчеств)
8. Передает все данные в Blade-шаблон формы редактирования

**Критерии приемки FR-1:**

- ✅ Форма редактирования доступна по адресу `GET /persons/{id}/edit?lang={lang}`
- ✅ Если персона не существует — возвращается 404 Not Found
- ✅ Если персона принадлежит другому пользователю — возвращается 404 Not Found
- ✅ Все многоязычные данные персоны загружаются корректно
- ✅ Справочные данные для autocomplete загружаются
- ✅ Используется eager loading для оптимизации запросов

---

### FR-2. Форма редактирования персоны

**Приоритет:** Высокий

**Описание:**
Система должна предоставлять форму редактирования с предзаполненными существующими данными персоны.

**Детализация:**

Создать Blade-шаблон `persons/edit.blade.php` со следующими элементами:

**Заголовок формы:**

- Заголовок: "Редактирование персоны: {Полное имя на текущем языке}"
- Подзаголовок: "(Дата рождения — дата смерти)" или "(Дата рождения — н.в.)" или "(Годы жизни неизвестны)"

**Раздел "Основная информация":**

- **Пол:** Обязательное поле, radio buttons (Мужской/Женский/Неизвестный), предзаполнено текущим значением
- **Дата рождения:** Необязательное поле, тип date (формат YYYY-MM-DD), предзаполнено
- **Дата смерти:** Необязательное поле, тип date (формат YYYY-MM-DD), предзаполнено

**Раздел "Имя (русский язык)":**

- **Имя (ru):** Обязательное текстовое поле с autocomplete, предзаполнено существующим значением
- **Отчество (ru):** Текстовое поле с двумя режимами ввода:
  - Автоматическая генерация: выбор из списка родителей-мужчин (имя отца → отчество)
  - Ручной ввод: текстовое поле для обеих гендерных форм (Иванович/Ивановна)
  - Предзаполнено существующим значением

**Раздел "Имя (английский язык)":**

- **Имя (en):** Обязательное текстовое поле с autocomplete, предзаполнено
- **Отчество (en):** Текстовое поле, предзаполнено (если указано)

**Раздел "Фамилия (русский язык)":**

- **Фамилия (ru) - мужская форма:** Обязательное текстовое поле с autocomplete, предзаполнено
- **Фамилия (ru) - женская форма:** Динамическое поведение в зависимости от пола:
  - Если пол = Мужской: поле неактивно, значение копируется из мужской формы
  - Если пол = Женский: поле активно, автозаполнение с заменой окончания
  - Предзаполнено существующим значением
  - Пользователь может изменить автозаполненное значение вручную

**Раздел "Фамилия (английский язык)":**

- **Фамилия (en) - мужская форма:** Обязательное текстовое поле с autocomplete, предзаполнено
- **Фамилия (en) - женская форма:** Аналогично русской фамилии, предзаполнено

**Раздел "Девичья фамилия" (только для женщин):**

- **Девичья фамилия (ru) - женская форма:** Необязательное поле, отображается только если пол = Женский, предзаполнено
- **Девичья фамилия (ru) - мужская форма:** Необязательное поле, автозаполнение, предзаполнено
- **Девичья фамилия (en) - женская форма:** Необязательное поле, предзаполнено
- **Девичья фамилия (en) - мужская форма:** Необязательное поле, предзаполнено

**Раздел "Дополнительная информация":**

- **Информация (ru):** Необязательное многострочное текстовое поле (textarea), предзаполнено
- **Информация (en):** Необязательное многострочное текстовое поле, предзаполнено

**Кнопки:**

- **Сохранить изменения** — отправка формы на `PUT /persons/{id}`
- **Отмена** — возврат к карточке персоны `/persons/{id}?lang={lang}`

**Требования:**

- Все обязательные поля должны быть визуально помечены (например, звездочкой)
- Все поля должны быть предзаполнены существующими данными персоны
- Autocomplete должен предлагать варианты из существующих имен/фамилий пользователя
- Автозаполнение гендерных форм должно происходить динамически (JavaScript)
- Раздел "Девичья фамилия" должен скрываться/показываться в зависимости от выбранного пола
- Изменение пола должно динамически пересчитывать видимость гендерных форм

**Критерии приемки FR-2:**

- ✅ Форма содержит все поля для ввода многоязычных данных (ru, en)
- ✅ Все поля предзаполнены существующими данными персоны
- ✅ Заголовок формы отображает полное имя редактируемой персоны
- ✅ Autocomplete работает для имен и фамилий
- ✅ Автозаполнение гендерных форм фамилий работает при изменении пола
- ✅ Раздел "Девичья фамилия" отображается только для женщин
- ✅ Форма визуально понятна нетехническому пользователю

---

### FR-3. Обработка формы редактирования персоны

**Приоритет:** Высокий

**Описание:**
Система должна корректно обрабатывать обновление данных персоны с сохранением многоязычности.

**Детализация:**

Создать маршрут `PUT /persons/{person}` с контроллером `PersonController@update`, который:

1. Валидирует входные данные (FR-5)
2. Загружает существующую персону через `PersonRepository::findById()`
3. Если персона не найдена — возвращает 404 Not Found
4. Проверяет, что персона принадлежит текущему пользователю
5. Для каждого измененного поля:
   - **Если изменено имя/отчество:** ищет существующее через `NameRepository::findByName()` или создает новое
   - **Если изменена фамилия/девичья фамилия:** ищет существующую через `SurnameRepository::findBySurname()` или создает новую
   - **Если изменена дата рождения/смерти:** обновляет соответствующее поле персоны
   - **Если изменена дополнительная информация:** обновляет записи в `gen_person_info_lang` для каждого языка
   - **Если изменен пол:** обрабатывает изменение гендерных форм (FR-4)
6. Обновляет объект Person с новыми данными
7. Сохраняет персону через `PersonRepository::save()` в транзакции БД
8. Логирует операцию в таблицу `audit_logs` (действие: UPDATE_PERSON, сохраняет старые и новые значения)
9. Перенаправляет на карточку персоны `/persons/{id}?lang={lang}` с flash-сообщением успеха

**Требования:**

- Использовать Laravel validation для проверки данных
- Вся операция должна выполняться в транзакции БД
- При ошибке валидации — вернуть форму с сохраненными данными и сообщениями об ошибках
- При ошибке сохранения — откатить транзакцию и показать понятное сообщение пользователю
- Система должна переиспользовать существующие имена/фамилии (не создавать дубликаты)
- Если какого-то языкового варианта не было — создать новый перевод
- Если языковой вариант изменен — обновить существующий перевод

**Критерии приемки FR-3:**

- ✅ Форма отправляется на `PUT /persons/{id}` и обновляет персону
- ✅ Все многоязычные данные обновляются корректно
- ✅ Система переиспользует существующие имена/фамилии вместо создания дубликатов
- ✅ Изменения сохраняются транзакционно (все или ничего)
- ✅ После успешного сохранения — редирект на карточку персоны с flash-сообщением
- ✅ Операция логируется в audit_logs с сохранением старых и новых значений
- ✅ При попытке редактировать персону другого пользователя возвращается 404

---

### FR-4. Обработка смены пола при редактировании

**Приоритет:** Высокий

**Описание:**
Система должна корректно обрабатывать смену пола персоны с соответствующими изменениями гендерных форм.

**Детализация:**

Система должна обрабатывать следующие сценарии смены пола:

**Смена с "Мужской" на "Женский":**

1. Показать раздел "Девичья фамилия" в форме
2. Позволить указать девичью фамилию (необязательно)
3. Если пользователь указал девичью фамилию — сохранить её в `Person::birthSurname`
4. Обновить отображение фамилии на женскую форму

**Смена с "Женский" на "Мужской":**

1. Скрыть раздел "Девичья фамилия" в форме
2. Если девичья фамилия была указана — удалить её (установить `Person::birthSurname = null`)
3. Показать предупреждение пользователю: "При смене пола на 'Мужской' девичья фамилия будет удалена"
4. Обновить отображение фамилии на мужскую форму

**Смена с "Мужской"/"Женский" на "Неизвестный":**

1. Скрыть раздел "Девичья фамилия" в форме (как для мужчин)
2. Если девичья фамилия была указана — сохранить её (не удалять)
3. Отображать обе гендерные формы фамилии

**Смена с "Неизвестный" на "Мужской"/"Женский":**

1. Показать соответствующие гендерные формы
2. Для "Женский" — показать раздел "Девичья фамилия"
3. Корректно обработать существующие данные

**Требования:**

- Изменение пола должно происходить с подтверждением (JavaScript), если есть девичья фамилия
- Предупреждение о потере данных должно быть визуально заметным
- При смене пола все гендерные формы должны быть пересчитаны автоматически
- Пользователь может изменить автозаполненные значения вручную

**Критерии приемки FR-4:**

- ✅ Смена пола с "Мужской" на "Женский" показывает раздел "Девичья фамилия"
- ✅ Смена пола с "Женский" на "Мужской" удаляет девичью фамилию с предупреждением
- ✅ Смена пола корректно обрабатывается для всех комбинаций (Мужской ↔ Женский ↔ Неизвестный)
- ✅ Гендерные формы фамилий пересчитываются при смене пола
- ✅ Пользователь видит предупреждение о потере данных девичьей фамилии
- ✅ Операция смены пола логируется в audit_logs

---

### FR-5. Валидация данных при редактировании

**Приоритет:** Высокий

**Описание:**
Система должна валидировать данные при редактировании, используя те же правила, что и при создании персоны.

**Детализация:**

Система должна валидировать следующие правила:

**Обязательные поля:**

- Пол (gender): должен быть один из Gender::MALE, Gender::FEMALE, Gender::UNKNOWN
- Имя (ru): не пустое, строка 1-100 символов
- Имя (en): не пустое, строка 1-100 символов
- Фамилия (ru) - мужская форма: не пустая, строка 1-100 символов
- Фамилия (ru) - женская форма: не пустая, строка 1-100 символов
- Фамилия (en) - мужская форма: не пустая, строка 1-100 символов
- Фамилия (en) - женская форма: не пустая, строка 1-100 символов

**Необязательные поля:**

- Отчество (ru/en): если указано — строка 1-100 символов
- Дата рождения: если указана — корректная дата в формате YYYY-MM-DD, не в будущем
- Дата смерти: если указана — корректная дата, не раньше даты рождения
- Девичья фамилия: если указана — строка 1-100 символов
- Информация (ru/en): если указана — строка до 5000 символов

**Бизнес-правила:**

- Девичья фамилия может быть указана ТОЛЬКО для женщин (Gender::FEMALE)
- Если указана дата смерти, дата рождения обязательна
- Дата смерти не может быть раньше даты рождения
- Дата рождения не может быть в будущем

**Обработка ошибок валидации:**

- При обнаружении ошибок валидации — вернуть форму с введенными данными
- Показать понятные сообщения об ошибках рядом с соответствующими полями:
  - "Укажите имя на русском языке"
  - "Укажите имя на английском языке"
  - "Дата рождения не может быть в будущем"
  - "Дата смерти не может быть раньше даты рождения"
  - "Девичья фамилия доступна только для женщин"
- Сообщения об ошибках должны быть на русском языке
- Ошибки должны быть визуально заметными (красный цвет)

**Критерии приемки FR-5:**

- ✅ Валидация работает корректно для всех обязательных полей
- ✅ Валидация работает корректно для всех необязательных полей
- ✅ Валидация проверяет бизнес-правила (даты, девичья фамилия)
- ✅ Сообщения об ошибках понятны нетехническому пользователю
- ✅ При ошибке форма возвращается с сохраненными данными
- ✅ Ошибки визуально заметны (красный цвет, рядом с полями)

---

### FR-6. Навигация к форме редактирования

**Приоритет:** Средний

**Описание:**
Система должна предоставлять удобный доступ к форме редактирования персоны.

**Детализация:**

На карточке персоны `GET /persons/{id}` добавить:

- Кнопку "Редактировать" → переход на `/persons/{id}/edit?lang={lang}`
- Кнопка должна быть в разделе навигации (рядом с "Назад к списку")
- Кнопка должна быть визуально заметной
- Кнопка должна сохранять текущий язык интерфейса

**Flash-сообщения после редактирования:**

После успешного сохранения показывать flash-сообщение:

- Текст: "Персона успешно обновлена: {Полное имя}"
- Цвет: зеленый (успех)
- Автоматическое исчезновение через 5 секунд
- Сообщение должно содержать имя персоны для контекста

**Критерии приемки FR-6:**

- ✅ На карточке персоны есть кнопка "Редактировать"
- ✅ Кнопка ведет на `/persons/{id}/edit?lang={lang}` с сохранением языка
- ✅ После успешного сохранения отображается flash-сообщение
- ✅ Сообщение понятно и информативно
- ✅ Сообщение автоматически исчезает через 5 секунд

---

### FR-7. Аудит изменений персоны

**Приоритет:** Высокий

**Описание:**
Система должна логировать все изменения персоны для отслеживания истории и возможности восстановления.

**Детализация:**

Система должна логировать операцию редактирования в таблицу `audit_logs` со следующими данными:

- `user_id` — ID текущего пользователя (тестовый пользователь)
- `action` — UPDATE_PERSON
- `entity_type` — Person
- `entity_id` — ID редактируемой персоны
- `old_value` — JSON с данными ДО изменения (только измененные поля)
- `new_value` — JSON с данными ПОСЛЕ изменения (только измененные поля)
- `created_at` — текущая дата/время

**Требования к логированию:**

- Логирование должно происходить ПОСЛЕ успешного сохранения (в той же транзакции)
- В `old_value` и `new_value` сохранять только реально измененные поля (не весь объект)
- Логировать изменения многоязычных данных (указывать язык)
- Пример структуры JSON:

```json
{
  "old_value": {
    "birthDate": "1980-05-15",
    "info_ru": "Программист"
  },
  "new_value": {
    "birthDate": "1980-06-20",
    "info_ru": "Работает программистом в компании X"
  }
}
```

**Критерии приемки FR-7:**

- ✅ Каждая операция редактирования создает запись в audit_logs
- ✅ Запись содержит все обязательные поля
- ✅ В old_value и new_value сохраняются только измененные поля
- ✅ Логирование происходит в той же транзакции, что и сохранение
- ✅ При ошибке сохранения логирование также откатывается

---

## Нефункциональные требования

### NFR-1. Авторизация (ограниченная на этапе 4)

**Описание:**
На этапе 4 авторизация не реализована, используется тестовый пользователь.

**Критерии:**

- Все операции редактирования выполняются от имени тестового пользователя (первый в БД)
- Логика выбора пользователя централизована для легкой замены на этапе 7
- Пользователь не может редактировать персон других пользователей (фильтрация по userId)

**Проверка:**

- Попытка редактировать персону с несуществующим ID возвращает 404
- Попытка редактировать персону другого пользователя возвращает 404

---

### NFR-2. Транзакционность изменений

**Описание:**
Операция редактирования должна быть транзакционной для обеспечения целостности данных.

**Критерии:**

- Редактирование персоны выполняется в одной транзакции БД
- При ошибке на любом этапе — откат всех изменений
- Нет частично сохраненных данных (например, имя обновлено, а фамилия нет)
- Логирование в audit_logs происходит в той же транзакции

**Проверка:**

- Симулировать ошибку в середине транзакции (например, ошибка валидации на уровне БД)
- Убедиться, что БД не изменилась
- Убедиться, что запись в audit_logs не создалась

---

### NFR-3. Понятность формы для нетехнического пользователя

**Описание:**
Форма редактирования должна быть интуитивно понятна пользователю без технического бэкграунда.

**Критерии:**

- Все поля имеют понятные названия на русском/английском языках
- Обязательные поля визуально помечены
- Подсказки и плейсхолдеры объясняют, что вводить
- Сообщения об ошибках понятны ("Укажите дату рождения", а не "birth_date is required")
- Автозаполнение упрощает ввод
- Предупреждения о потере данных (например, при смене пола) понятны и заметны

**Проверка:**

- Ревью формы нетехническим пользователем
- Usability-тестирование

---

### NFR-4. Аудит всех операций

**Описание:**
Все операции редактирования персон должны логироваться в таблицу `audit_logs`.

**Критерии:**

- Каждая операция редактирования создает запись в audit_logs
- Логируются: user_id, action, entity_type, entity_id, old_value, new_value, created_at
- Логи не удаляются при удалении персоны
- Логи содержат достаточно информации для восстановления данных

**Проверка:**

- После каждой операции проверить наличие записи в audit_logs
- Проверить корректность сохраненных данных

---

### NFR-5. Производительность

**Описание:**
Форма редактирования должна работать быстро даже на больших объемах данных.

**Критерии:**

- Форма редактирования загружается менее чем за 1 секунду
- Autocomplete возвращает результаты менее чем за 0.5 секунды
- Сохранение персоны занимает менее 2 секунд
- Используется eager loading для загрузки всех многоязычных данных

**Проверка:**

- Измерить время загрузки формы на тестовых данных (1000+ персон)
- Измерить время сохранения персоны

---

### NFR-6. Предотвращение конкурентного редактирования (ограниченно на этапе 4)

**Описание:**
Система должна обрабатывать ситуацию, когда два пользователя одновременно редактируют одну персону.

**Критерии на текущем этапе:**

- На текущем этапе используется один тестовый пользователь — риск конкурентного редактирования минимален
- Система НЕ блокирует возможность одновременного редактирования (упрощение)
- Последнее сохранение перезаписывает предыдущие изменения (Last Write Wins)

**Допущения:**

- На этапе 7 (при добавлении авторизации) можно добавить оптимистичные блокировки (optimistic locking)
- На этапе 7 можно добавить поле `updated_at` и проверять версию при сохранении

**Проверка:**

- Документировать текущее поведение в тестах
- Добавить TODO-комментарий в коде для будущей реализации

---

## Модель предметной области

Этап 4 использует доменную модель, созданную на этапе 2. Редактирование персон не требует изменений в доменной модели.

### Основные Entity

#### Person (Персона)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец дерева
- `firstName: Name` — имя (многоязычное)
- `middleName: ?Name` — отчество (опционально)
- `surname: ?Surname` — текущая фамилия (опционально)
- `birthSurname: ?Surname` — девичья фамилия (опционально)
- `birthDate: ?DateTime` — дата рождения
- `deathDate: ?DateTime` — дата смерти
- `info: array<string, string>` — описание по языкам
- `gender: Gender` — пол персоны

**Бизнес-правила (актуальные для редактирования):**

- Девичья фамилия может быть указана ТОЛЬКО для женщин (Gender::FEMALE)
- Если указана дата смерти, дата рождения обязательна
- Дата смерти не может быть раньше даты рождения
- При смене пола с "Женский" на "Мужской" девичья фамилия удаляется

#### Name (Имя/Отчество)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец имени
- `translations: array<NameTranslation>` — переводы на языки

**Использование при редактировании:**

- Система переиспользует существующие имена при совпадении текста
- При изменении имени/отчества — ищет существующее или создает новое

#### Surname (Фамилия)

**Атрибуты:**

- `id: int` — уникальный идентификатор
- `userId: int` — владелец фамилии
- `translations: array<SurnameTranslation>` — переводы на языки

**Использование при редактировании:**

- Система переиспользует существующие фамилии при совпадении текста
- При изменении фамилии/девичьей фамилии — ищет существующую или создает новую

---

## Зависимости

### Внешние зависимости

- **Laravel 12** — фреймворк для web routes, контроллеров, Blade, validation
- **PHP 8.5** — язык программирования
- **SQLite** — СУБД с данными

### Внутренние зависимости

Задача TZ1_04_2 **зависит** от:

- **TZ1_01** — требует готовую схему БД с таблицами
- **TZ1_02** — требует доменную модель и репозитории (методы save)
- **TZ1_03** — требует интерфейс просмотра персон (карточки персон)
- **TZ1_04_1** — требует реализованную форму создания персоны (используется аналогичный подход)

Задача TZ1_04_2 **блокирует:**

- **TZ1_04_3** — Удаление персоны (требует возможность редактирования для корректировки перед удалением)
- **Этап 5** — Управление связями (требует возможность редактировать персон для управления их связями)

---

## Сценарии использования

### UC-1. Пользователь исправляет опечатку в фамилии

**Актор:** Пользователь

**Предусловия:**

- Пользователь авторизован (тестовый пользователь)
- В БД есть персона с ID=5: "Иван Петрович Сидров" (ошибочная фамилия)
- Правильная фамилия: "Сидоров"

**Основной сценарий:**

1. Пользователь открывает карточку персоны `/persons/5?lang=ru`
2. Видит отображение: "Иван Петрович Сидров"
3. Замечает опечатку в фамилии
4. Кликает на кнопку "Редактировать"
5. Переходит на форму редактирования `/persons/5/edit?lang=ru`
6. Видит форму, предзаполненную существующими данными:
   - Пол: Мужской
   - Имя (ru): "Иван"
   - Отчество (ru): "Петрович"
   - Фамилия (ru) - мужская форма: "Сидров" ← **опечатка**
7. Изменяет фамилию (ru) на "Сидоров"
8. Система автоматически обновляет женскую форму на "Сидорова"
9. Кликает "Сохранить изменения"
10. Система валидирует данные
11. Система ищет фамилию "Сидоров" через `SurnameRepository::findBySurname()`
12. Если найдена — переиспользует существующую запись, если нет — создает новую
13. Система обновляет персону в БД
14. Система логирует операцию в `audit_logs`:
    - old_value: {"surname_ru_male": "Сидров"}
    - new_value: {"surname_ru_male": "Сидоров"}
15. Пользователь перенаправляется на карточку персоны
16. Видит flash-сообщение: "Персона успешно обновлена: Иван Петрович Сидоров"
17. Проверяет, что фамилия отображается корректно

**Постусловия:**

- Фамилия персоны обновлена на корректную
- Операция залогирована в audit_logs
- Пользователь видит правильные данные

---

### UC-2. Пользователь добавляет недостающую информацию

**Актор:** Пользователь

**Предусловия:**

- В БД есть персона с ID=10: "Мария Ивановна Петрова"
- У персоны не указана дата смерти
- У персоны не указана дополнительная информация на английском языке

**Основной сценарий:**

1. Пользователь узнал точную дату смерти родственницы: 15 мая 2020 года
2. Открывает карточку персоны `/persons/10?lang=ru`
3. Кликает на кнопку "Редактировать"
4. Переходит на форму редактирования `/persons/10/edit?lang=ru`
5. Видит форму с существующими данными:
   - Дата рождения: 1950-03-10
   - Дата смерти: (не указана)
   - Информация (en): (не указана)
6. Добавляет дату смерти: 2020-05-15
7. Добавляет информацию (en): "Retired teacher"
8. Кликает "Сохранить изменения"
9. Система валидирует данные (дата смерти не раньше даты рождения — OK)
10. Система обновляет персону в БД
11. Система создает новую запись в `gen_person_info_lang` для английского языка
12. Система логирует операцию в `audit_logs`
13. Пользователь перенаправляется на карточку персоны
14. Видит flash-сообщение: "Персона успешно обновлена: Мария Ивановна Петрова"
15. Проверяет, что дата смерти отображается: "(1950-03-10 — 2020-05-15)"
16. Переключает язык на английский
17. Видит дополнительную информацию: "Retired teacher"

**Постусловия:**

- Дата смерти добавлена
- Дополнительная информация на английском языке добавлена
- Операция залогирована

---

### UC-3. Пользователь исправляет ошибочно указанный пол

**Актор:** Пользователь

**Предусловия:**

- В БД есть персона с ID=15: "Алексей Иванович Петров", пол = Мужской
- На самом деле это женщина "Алексея Ивановна Петрова"
- Пользователь ошибся при создании персоны

**Основной сценарий:**

1. Пользователь открывает карточку персоны `/persons/15?lang=ru`
2. Видит отображение: "Алексей Иванович Петров"
3. Понимает, что указан неправильный пол
4. Кликает на кнопку "Редактировать"
5. Переходит на форму редактирования `/persons/15/edit?lang=ru`
6. Видит текущие данные:
   - Пол: Мужской ← **ошибка**
   - Имя (ru): "Алексей"
   - Фамилия (ru) - мужская форма: "Петров"
   - Раздел "Девичья фамилия" скрыт
7. Изменяет пол на Женский
8. Система автоматически:
   - Показывает раздел "Девичья фамилия"
   - Обновляет отображение фамилии на женскую форму: "Петрова"
9. Изменяет имя на "Алексея" (женская форма имени)
10. Заполняет девичью фамилию: "Смирнова" / "Смирнов"
11. Кликает "Сохранить изменения"
12. Система валидирует данные
13. Система обновляет пол персоны на Gender::FEMALE
14. Система добавляет девичью фамилию
15. Система логирует операцию в `audit_logs`
16. Пользователь перенаправляется на карточку персоны
17. Видит обновленную карточку: "Алексея Ивановна Петрова (дев. Смирнова)"
18. Проверяет, что все гендерные формы отображаются корректно

**Постусловия:**

- Пол персоны изменен на Женский
- Имя изменено на женскую форму
- Добавлена девичья фамилия
- Гендерные формы корректны

---

### UC-4. Система предотвращает некорректные данные через валидацию

**Актор:** Пользователь

**Предусловия:**

- Пользователь на форме редактирования персоны `/persons/20/edit?lang=ru`

**Основной сценарий:**

1. Пользователь редактирует данные персоны:
   - Очищает поле "Имя (ru)" (делает его пустым) ← **ошибка**
   - Изменяет дату рождения на 2030-01-01 (в будущем) ← **ошибка**
   - Изменяет дату смерти на 1950-01-01
   - Текущая дата рождения: 1980-05-15
2. Кликает "Сохранить изменения"
3. Система выполняет валидацию и находит ошибки:
   - Имя (ru) обязательно
   - Дата рождения не может быть в будущем
   - Дата смерти не может быть раньше даты рождения (1950 раньше 1980)
4. Система возвращает форму с введенными данными
5. Показывает сообщения об ошибках рядом с полями:
   - Рядом с "Имя (ru)": "Укажите имя на русском языке"
   - Рядом с "Дата рождения": "Дата рождения не может быть в будущем"
   - Рядом с "Дата смерти": "Дата смерти не может быть раньше даты рождения"
6. Пользователь исправляет ошибки:
   - Имя (ru): "Иван"
   - Дата рождения: 1980-05-15 (возвращает исходное значение)
   - Дата смерти: 2020-01-01
7. Кликает "Сохранить изменения" снова
8. Система успешно валидирует данные
9. Система обновляет персону
10. Пользователь видит обновленную карточку с flash-сообщением успеха

**Постусловия:**

- Валидация предотвратила сохранение некорректных данных
- Пользователь увидел понятные сообщения об ошибках
- Персона обновлена с корректными данными

---

### UC-5. Пользователь добавляет переводы на английский язык

**Актор:** Пользователь

**Предусловия:**

- В БД есть персона с ID=25: "Анна Сергеевна Иванова"
- Персона создана только с русскими именем/фамилией
- Английские переводы не указаны

**Основной сценарий:**

1. Пользователь открывает карточку персоны `/persons/25?lang=ru`
2. Переключает язык на английский
3. Видит, что имя/фамилия не отображаются корректно (пустые или транслитерированные)
4. Возвращается на русский язык и кликает "Редактировать"
5. Переходит на форму редактирования `/persons/25/edit?lang=ru`
6. Видит, что поля на английском языке пустые:
   - Имя (en): (не указано)
   - Фамилия (en): (не указана)
7. Заполняет английские переводы:
   - Имя (en): "Anna"
   - Фамилия (en) - мужская форма: "Ivanov"
   - Фамилия (en) - женская форма: "Ivanova"
8. Кликает "Сохранить изменения"
9. Система валидирует данные
10. Система создает новые переводы в `gen_name_lang` и `gen_surname_lang` для английского языка
11. Система обновляет персону
12. Пользователь перенаправляется на карточку персоны
13. Переключает язык на английский
14. Видит корректное отображение: "Anna Sergeevna Ivanova"

**Постусловия:**

- Добавлены переводы на английский язык
- Персона корректно отображается на обоих языках

---

## Риски

### Риск 1. Сложность формы с многоязычными полями

**Описание:**
Форма редактирования с полями для двух языков может быть перегружена и сложна для понимания, особенно если пользователь редактирует только одно поле.

**Вероятность:** Средняя

**Влияние:** Среднее (плохой UX, ошибки при вводе)

**Меры снижения:**

- Использовать визуальное группирование полей (секции, аккордеоны)
- Подсказки и плейсхолдеры для объяснения полей
- Провести usability-тестирование с нетехническими пользователями
- Добавить кнопку "Помощь" с объяснением многоязычности

**План реагирования:**

- Если пользователи испытывают трудности — упростить форму (скрыть английские поля в аккордеон "Переводы")
- Рассмотреть вариант раздельных форм для разных языков

---

### Риск 2. Дубликаты имен и фамилий при редактировании

**Описание:**
При редактировании может создаваться новая запись имени/фамилии вместо переиспользования существующей из-за ошибки в логике поиска.

**Вероятность:** Средняя

**Влияние:** Низкое (данные остаются корректными, просто неоптимальны)

**Меры снижения:**

- Использовать тот же механизм переиспользования, что и при создании
- Точный поиск существующих имен через `NameRepository::findByName()` с учетом userId
- Покрыть тестами сценарий редактирования с переиспользованием имен
- Добавить логирование создания новых имен/фамилий

**План реагирования:**

- Если появляются дубликаты — улучшить логику поиска
- Создать команду для слияния дублирующих имен

---

### Риск 3. Потеря данных девичьей фамилии при смене пола

**Описание:**
При смене пола с "Женский" на "Мужской" девичья фамилия удаляется. Пользователь может не заметить предупреждение и потерять данные.

**Вероятность:** Низкая

**Влияние:** Среднее (потеря данных)

**Меры снижения:**

- Показывать визуально заметное предупреждение (красный/оранжевый цвет)
- Требовать подтверждения через JavaScript при смене пола
- Логировать удаление девичьей фамилии в audit_logs
- Возможность восстановления из audit_logs

**План реагирования:**

- Если данные удалены по ошибке — восстановить из audit_logs
- На этапе 7 добавить возможность отмены изменений (undo)

---

### Риск 4. Конкурентное редактирование (конфликты версий)

**Описание:**
Два пользователя могут одновременно редактировать одну персону, перезаписывая изменения друг друга.

**Вероятность:** Очень низкая (на текущем этапе один тестовый пользователь)

**Влияние:** Среднее (потеря изменений)

**Меры снижения (на текущем этапе):**

- Документировать текущее поведение (Last Write Wins)
- Логировать все изменения в audit_logs для отслеживания конфликтов
- На этапе 7 (при добавлении авторизации) реализовать оптимистичные блокировки

**План реагирования:**

- На этапе 7 добавить поле `updated_at` и проверять версию при сохранении
- При обнаружении конфликта — показать пользователю обе версии для выбора

---

### Риск 5. Производительность загрузки формы с многоязычными данными

**Описание:**
Загрузка всех языковых вариантов персоны может быть медленной из-за множественных запросов к БД.

**Вероятность:** Средняя

**Влияние:** Среднее (плохой UX)

**Меры снижения:**

- Использовать eager loading для загрузки всех связанных данных одним запросом
- Оптимизировать запросы в репозиториях
- Измерить производительность на тестовых данных (1000+ персон)
- Добавить индексы на поля FNAME, SNAME, USER_ID

**План реагирования:**

- Если форма загружается дольше 1 секунды — оптимизировать запросы
- Рассмотреть кеширование справочных данных (списки имен/фамилий)

---

## Критерии приемки

### Критерии приемки задачи

Задача считается завершенной, если выполнены **все** следующие критерии:

#### Критерии по функциональности редактирования

- ✅ Доступна форма редактирования персоны по адресу `GET /persons/{id}/edit?lang={lang}`
- ✅ Если персона не существует — возвращается 404 Not Found
- ✅ Если персона принадлежит другому пользователю — возвращается 404 Not Found
- ✅ Форма предзаполнена всеми существующими данными персоны на всех языках
- ✅ Можно изменить любое поле, включая многоязычные имена/фамилии
- ✅ Форма отправляется на `PUT /persons/{id}` и обновляет персону
- ✅ После успешного сохранения — редирект на карточку персоны с flash-сообщением
- ✅ Flash-сообщение информативно: "Персона успешно обновлена: {Полное имя}"

#### Критерии по смене пола

- ✅ Смена пола с "Мужской" на "Женский" показывает раздел "Девичья фамилия"
- ✅ Смена пола с "Женский" на "Мужской" удаляет девичью фамилию с визуальным предупреждением
- ✅ Смена пола корректно обрабатывается для всех комбинаций (Мужской ↔ Женский ↔ Неизвестный)
- ✅ Гендерные формы фамилий пересчитываются динамически при смене пола
- ✅ Пользователь видит понятное предупреждение о потере данных девичьей фамилии

#### Критерии по валидации

- ✅ Валидация работает корректно для всех обязательных полей
- ✅ Валидация работает корректно для всех необязательных полей
- ✅ Валидация проверяет бизнес-правила (даты, девичья фамилия для женщин)
- ✅ Сообщения об ошибках понятны нетехническому пользователю
- ✅ При ошибке валидации форма возвращается с сохраненными данными
- ✅ Ошибки визуально заметны (красный цвет, рядом с полями)

#### Критерии по многоязычности

- ✅ Система корректно обновляет существующие переводы имен/фамилий
- ✅ Система создает новые переводы, если их не было
- ✅ Система переиспользует существующие имена/фамилии вместо создания дубликатов
- ✅ Autocomplete предлагает варианты из существующих имен/фамилий пользователя
- ✅ Autocomplete работает быстро (менее 0.5 сек на 1000 имен)

#### Критерии по навигации

- ✅ На карточке персоны есть кнопка "Редактировать"
- ✅ Кнопка ведет на `/persons/{id}/edit?lang={lang}` с сохранением текущего языка
- ✅ После редактирования пользователь возвращается на карточку персоны
- ✅ Flash-сообщение отображается после успешного сохранения

#### Критерии по безопасности

- ✅ Пользователь не может редактировать персон других пользователей (404)
- ✅ Все операции выполняются в транзакциях БД
- ✅ Нет SQL-инъекций (параметризованные запросы)
- ✅ Нет XSS-уязвимостей (экранирование в Blade)

#### Критерии по аудиту

- ✅ Все операции редактирования логируются в audit_logs
- ✅ Логи содержат user_id, action, entity_type, entity_id, old_value, new_value, created_at
- ✅ В old_value и new_value сохраняются только измененные поля
- ✅ Логирование происходит в той же транзакции, что и сохранение

#### Критерии по тестам

- ✅ Написаны E2E тесты для редактирования персоны с изменением разных полей
- ✅ Тесты проверяют валидацию (обязательные поля, даты, девичья фамилия)
- ✅ Тесты проверяют смену пола при редактировании
- ✅ Тесты проверяют обработку ошибки 404 (несуществующая персона)
- ✅ Тесты проверяют переиспользование существующих имен/фамилий
- ✅ Тесты проверяют логирование в audit_logs

#### Критерии по коду

- ✅ Код соответствует стилю проекта (.ai/rules/CodeStyle.md)
- ✅ Код проходит статический анализ PHPStan без ошибок
- ✅ Код проходит проверку PHP_CodeSniffer без ошибок
- ✅ Контроллеры используют репозитории (не работают с БД напрямую)
- ✅ Все операции записи выполняются в транзакциях

#### Критерии по производительности

- ✅ Форма редактирования загружается менее чем за 1 секунду
- ✅ Сохранение персоны занимает менее 2 секунд
- ✅ Используется eager loading для загрузки многоязычных данных

---

## Не входит в реализацию

Следующие функции **НЕ входят** в реализацию текущей задачи:

### Не входит в TZ1_04_2

- ❌ **Удаление персоны** — будет реализовано в задаче TZ1_04_3
- ❌ **Создание персоны** — уже реализовано в задаче TZ1_04_1
- ❌ **Управление связями персоны** — будет реализовано на Stage 5
- ❌ **Визуализация дерева** — будет реализована на Stage 6
- ❌ **Авторизация и аутентификация** — будет реализована на Stage 7
- ❌ **Оптимистичные блокировки (versioning)** — может быть добавлено на Stage 7
- ❌ **История изменений персоны (детальный просмотр)** — не входит в эпик TZ1
- ❌ **Отмена изменений (undo)** — может быть добавлено на Stage 7
- ❌ **Массовое редактирование персон** — не входит в эпик TZ1
- ❌ **Импорт персон из файлов** — не входит в эпик TZ1
- ❌ **Экспорт персон в файлы** — не входит в эпик TZ1
- ❌ **Загрузка фотографий персон** — не входит в эпик TZ1

### Допущения текущей задачи

На текущем этапе допускаются следующие упрощения:

- ✅ **Один тестовый пользователь** — авторизация будет на Stage 7
- ✅ **Last Write Wins при конкурентном редактировании** — оптимистичные блокировки будут на Stage 7
- ✅ **Минимальный дизайн формы** — улучшение UX будет на Stage 6
- ✅ **Дубликаты имен/фамилий** — дедупликация может быть добавлена позже
- ✅ **Нет отмены изменений** — может быть добавлена на Stage 7

---

## Дополнительные замечания

### Важные особенности реализации

1. **Предзаполнение всех данных критично:** Форма должна загружать ВСЕ существующие данные персоны на всех языках, чтобы пользователь мог видеть текущее состояние.

2. **Переиспользование имен/фамилий обязательно:** Важно использовать тот же механизм, что и при создании, чтобы избежать дубликатов.

3. **Смена пола требует особого внимания:** Корректная обработка гендерных форм и девичьей фамилии при смене пола критична для качества данных.

4. **Транзакционность обязательна:** Без транзакций возможны частично обновленные данные (например, имя обновлено, а фамилия нет).

5. **Аудит для восстановления:** Логирование в audit_logs с сохранением старых и новых значений позволит восстановить случайно испорченные данные.

6. **Производительность загрузки формы:** Использование eager loading критично для быстрой загрузки всех многоязычных данных.

### Рекомендации по реализации

1. **Использовать форму создания как шаблон:** Форма редактирования очень похожа на форму создания, можно переиспользовать Blade-компоненты.

2. **Тестировать смену пола тщательно:** Это самый сложный сценарий с множеством edge-кейсов.

3. **Добавить визуальные подсказки:** Пользователь должен понимать, какие поля обязательны, а какие необязательны.

4. **Логировать детально:** В audit_logs сохранять достаточно информации для понимания, что именно изменилось.

5. **Использовать JavaScript для UX:** Динамическое поведение формы (показ/скрытие девичьей фамилии, автозаполнение) улучшает пользовательский опыт.

---

## Глоссарий

- **Редактирование персоны** — изменение существующих данных персоны в системе
- **Предзаполнение формы** — автоматическое заполнение полей формы существующими данными
- **Смена пола** — изменение пола персоны с одного значения на другое
- **Гендерная форма** — разная форма слова для мужчин и женщин (Петров/Петрова)
- **Девичья фамилия** — фамилия женщины до замужества
- **Переиспользование** — использование существующей записи БД вместо создания новой
- **Autocomplete** — автодополнение, подсказки при вводе текста
- **Flash-сообщение** — временное уведомление пользователю о результате операции
- **Аудит (audit log)** — журнал всех действий пользователя для отслеживания истории
- **Транзакция БД** — группа операций, которые выполняются вместе (все или ничего)
- **Валидация** — проверка корректности введенных данных
- **Eager loading** — загрузка связанных данных одним запросом для оптимизации производительности
- **404 Not Found** — HTTP-статус, означающий, что запрашиваемый ресурс не найден
- **Last Write Wins** — стратегия разрешения конфликтов, при которой последнее сохранение перезаписывает предыдущие
- **Оптимистичные блокировки** — техника предотвращения конфликтов при одновременном редактировании

---

**Конец спецификации TZ1_04_2**
