# Модуль Example

Модуль "Example" служит эталонным примером реализации модуля в проекте
согласно принципам Clean Architecture и CQRS. Он демонстрирует основные
паттерны и структуру для создания новых модулей.

## 1. Описание архитектуры и структуры модуля

Модуль "Example" реализован в соответствии с Clean Architecture и CQRS
паттернами. Он состоит из четырех слоев: Domain, Application,
Infrastructure и Presentation.

### Диаграмма слоев

```text
┌─────────────────────────────────────┐
│          Presentation               │
│  - Controller, Middleware, Views    │
├─────────────────────────────────────┤
│          Application                │
│  - UseCase, Command, Query, Service │
├─────────────────────────────────────┤
│           Domain                    │
│  - Entity, DTO, Interfaces, Events  │
├─────────────────────────────────────┤
│         Infrastructure              │
│  - Repository, Adapter              │
└─────────────────────────────────────┘
```

### Ключевые компоненты

- **Domain**: Определяет бизнес-правила и интерфейсы
- **Application**: Реализует бизнес-логику через UseCase, Command и Query
- **Infrastructure**: Обеспечивает доступ к данным и внешним системам
- **Presentation**: Обрабатывает HTTP запросы и представления

Модуль демонстрирует два сценария использования:

1. CRUD операции над примерами (сущностями)
2. Математические вычисления с генерацией отчетов

## 2. Описание предметной области

### Сущности и объекты значений

- **Example Entity**: Представляет пример с полями id, name, comment, status, user_id, created_at
- **Status Enum**: Перечисление со значениями 'active' и 'inactive'
- **CreatedIdVO**: Объект значения для идентификатора созданного ресурса
- **SubtractNumbersVO**: Объект значения для пары чисел для вычитания

### Интерфейсы

- **ExternalLoggerInterface**: Контракт для внешнего логгирования
- **ExampleRepositoryInterface**: Контракт для доступа к данным примеров

### Запросы и ответы

- **CreateExampleRequest**: Входные данные для создания примера
- **ExampleResponse**: Выходные данные с идентификатором созданного примера

### События

- **ExampleCreated**: Событие, генерируемое при создании примера

## 3. Описание реализации бизнес-логики

### UseCase

#### ExampleUseCase

Основной сценарий использования для работы с примерами:

- `createExample(CreateExampleRequest)`: Создает и сохраняет в репозиторий, вставляет в outbox и генерирует событие
- `getExampleViewData(int $id)`: Получает данные примера для отображения

#### SubtractExampleUseCase

Сценарий вычисления разности чисел:

- `subtractAndMakeReport(SubtractNumbersVO, string $format)`: Вычисляет
  разность и генерирует отчет в указанном формате

### Command и Query

#### ExampleOutboxCommand

Команда для вставки данных в таблицу outbox:

- `insert(ExampleDto $data)`: Сохраняет данные в формате JSON в
  таблицу example_outbox

#### GetExampleQuery

Запрос для получения данных примера:

- `getById(int $id)`: Возвращает ExampleDto по идентификатору или null

### Service

#### ExampleCalcService

Сервис для математических вычислений:

- `subtract(float $num1, float $num2)`: Выполняет вычитание двух чисел

### Responder

#### ExampleMarkdownReportResponder

Генератор отчетов в формате Markdown:

- `render(array $data)`: Формирует таблицу с результатами вычислений на основе шаблона

## 4. Документация API интерфейсов

Модуль предоставляет REST API для работы с примерами.

### Контроллеры

#### ExampleController

**Middleware**: Применяется ExampleMiddleware

**Эндпоинты:**

##### POST /api/example/create

Создание нового примера.

**Входные данные (JSON):**
```json
{
  "name": "string",
  "comment": "string|null",
  "status": "active|inactive"
}
```

**Ответ (JSON):**
```json
{
  "data": {
    "id": 123
  }
}
```

##### GET /example/{id}

Отображение данных примера в виде HTML страницы.

**Параметры:**
- `id` (int): Идентификатор примера

**Ответ:** HTML представление с данными примера

## 5. Интеграция с внешними системами

### Repository

#### EloquentExampleRepository

Реализует ExampleRepositoryInterface для работы с базой данных через Eloquent:

- `store(CreateExampleDto $example)`: Сохраняет пример в таблицу examples и возвращает ID

### Adapter

#### ClickhouseLogger

Реализует ExternalLoggerInterface для логгирования во внешнюю систему:

- `log(string $message, array $context)`: Логирует сообщение с добавлением API ключа в контекст

## 6. Зависимости

### Переменные окружения

Не требует специфических переменных окружения. Использует стандартные настройки базы данных Laravel.

### Зависимости от других модулей

- **Core**: Использует общие интерфейсы и исключения из ядра проекта
- **Auth**: Зависит от аутентификации пользователя для получения user_id

### Внешние зависимости

- **Laravel Framework**: Использует Eloquent, Events, Validation
- **PSR-3 Logger**: Для реализации внешнего логгирования

## 7. Тестирование модуля

Тесты расположены в `backend/tests/Suite/Example/`.

### Unit тесты

- `Domain/`: Тесты сущностей, объектов значений, исключений
- `Application/`: Тесты UseCase, Command, Query, Service

### Integration тесты

- Тесты взаимодействия между слоями
- Тесты репозиториев с базой данных

### E2E тесты

- Тесты HTTP контроллеров
- Тесты полных сценариев использования

### Functional тесты

- Тесты бизнес-логики через публичное API

## 8. Сценарии использования

### Сценарий 1: Создание примера

1. Пользователь отправляет POST запрос на /api/example/create с данными примера
2. Данные валидируются в Factory
3. UseCase создает DTO и сохраняет через Repository
4. Данные вставляются в outbox для асинхронной обработки
5. Генерируется событие ExampleCreated
6. Возвращается идентификатор созданного примера

### Сценарий 2: Получение данных примера

1. Пользователь запрашивает GET /example/{id}
2. UseCase получает данные через Query
3. Если пример не найден, выбрасывается исключение
4. Возвращается HTML представление с данными

### Сценарий 3: Генерация отчета вычислений

1. Приложение вызывает SubtractExampleUseCase с числами
2. Service выполняет вычитание
3. Responder формирует Markdown таблицу с результатами
4. Возвращается отчет в указанном формате
