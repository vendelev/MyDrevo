# Мультиагентная разработка

***

## Общая концепция

Система состоит из команды специализированных агентов, координируемых оркестратором. 
Каждый агент выполняет определённую роль в процессе разработки. 

Оркестратор управляет последовательностью работы, передаёт результаты между агентами и останавливает процесс 
 при возникновении блокирующих вопросов.

***

## Роли агентов

### Оркестратор

**Функция:** 

- Координация всего процесса разработки
- Ставит задачи другим агентам
- Принимает и анализирует результаты
- Определяет следующие шаги
- Останавливает процесс при блокирующих вопросах
- Управляет циклами review-доработка

### Product Owner

**Функция:** [Описание бизнес потребностей и планирование этапов эпика](/.ai/Mode/Stage0CreateEpic.md) 

### Бизнес аналитик

**Функция:** [Создание спецификации с описанием бизнес-требований](/.ai/Mode/Stage1CreateSpec.md)

### Системный аналитик + IT архитектор

**Функция:** [Формирование сводного технического плана](/.ai/Mode/Stage2CreatePlanSummary.md)

### Системный аналитик + PHP разработчик

**Функция:** [Формирование технического плана по разработке кода](/.ai/Mode/Stage2CreatePlanDev.md)

### Системный аналитик + Разработчик тестов

**Функция:** [Формирование технического плана по написанию тестов](/.ai/Mode/Stage2CreatePlanTest.md)

### PHP разработчик

**Функция:** [Разработка программного кода](/.ai/Mode/Stage3Implementation.md)

### Разработчик тестов

**Функция:** [Разработка тестов](/.ai/Mode/Stage4Testing.md)

### Технический писатель

**Функция:** [Создание технической документации](/.ai/Mode/Stage5TechDoc.md)

### IT архитектор

**Функция:** [Создание архитектурной документации](/.ai/Mode/Stage6ArchDoc.md)

***

## Схема работы

На каждом этапе мультиагентной разработки шаги работы с агентами будут одинаковы:

1. Создаем новый контекст в режиме "**orchestrator**" и пишем ему команду (см описание каждого этапа).
2. Проводим ревью, вносим правки самостоятельно или даем команду на исправление агенту.
3. Делаем коммит самостоятельно или даем команду: `сделай коммит`.
   Команду агенту надо давать в задаче "**orchestrator**", чтобы агент, имея общий контекст, смог правильно 
   составить комментарий к коммиту.

### Workflow

- Первым выполняется Шаг 0, где создается эпик и этапы.
- Шаг 1 повторяется столько раз, сколько было создано этапов.
- Шаг 2 повторяется для каждого этапа непосредственно перед реализацией.
- Тк технический план тоже разбит на подэтапы, Шаги 3-6 повторяются для каждого подэтапа.
- На Шаге 7 создается человекочитаемая документация.
- На Шаге 8 создается архитектурная документация описывающая взаимодействие и зависимости всей системы.

## Рекомендации

Если задача не большая, то создавать эпик не обязательно. Можно сразу создать спецификацию с описанием 
 бизнес-требований.

После создания эпика создавайте по каждому этапу **только спецификации**.
А технические планы создавайте непосредственно перед началом реализации.

Создание технических планов "на будущее" приводит к тому, что после выполнения текущего этапа приходится 
 пересматривать план реализации следующего этапа.

Для уменьшения контекста и упрощения code-review технический план так же разбивается на несколько подэтапов реализации  
 + по отдельности разработка кода и написание тестов.

## Последовательность работ

### Шаг 0. Описание бизнес требований и планирование этапов эпика.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для описания бизнес требований:
   - `subagent_type`: `create-epic`
   - `prompt`: "Номер эпика: {номер эпика из трекера}. Описание потребностей бизнеса: {.......}.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `create-epic`
   - `prompt`: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям.
     Верни список файлов и список замечаний для каждого файла"
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `create-epic`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Для каждого созданного или измененного файла вызови инструмент Task (switch_mode) с параметрами:
   - `subagent_type`: `markdownlint`
   - `prompt`: "Проверь и исправь форматирование файла: {путь_к_файлу}"

   Вызывай отдельного агента `markdownlint` для каждого файла.
```

### Шаг 1. Создание спецификации с описанием функциональных требований.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для описания функциональных требований:
   - `subagent_type`: `create-spec`
   - `prompt`: "Номер задачи: {номер задачи из трекера}.
     Описание эпика находится в файле @/Doc/Backlog/{YYYY}/{EPIC_FOLDER}/Summary.md.
     Создай описание функциональных требований для этапа {Х} согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `create-spec`
   - `prompt`: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям.
     Верни список замечаний для каждого файла"
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `create-spec`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Для каждого созданного или измененного файла вызови инструмент Task (switch_mode) с параметрами:
  - `subagent_type`: `markdownlint`
  - `prompt`: "Проверь и исправь форматирование файла: {путь_к_файлу}"

   Вызывай отдельного агента `markdownlint` для каждого файла.
```

### Шаг 2. Формирование сводного технического плана.

**Рекомендация**:
```
Создавайте технический план непосредственно перед разработкой.
Создание плана "на будущее" приводит к тому, что после реализации текущего этапа приходится пересматривать 
 план разработки следующего этапа.
```

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для создания сводного плана:
   - `subagent_type`: `create-plan-sum`
   - `prompt`: "На основе бизнес-требований из файла @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Spec.md
     создай сводный план по разработке кода и тестов согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `create-plan-sum`
   - `prompt`: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям.
     Верни список замечаний для каждого файла"
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `create-plan-sum`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
```

### Шаг 3. Формирование технического плана по разработке кода.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для создания плана разработки кода:
   - `subagent_type`: `create-plan-dev`
   - `prompt`: "На основе бизнес-требований и сводного плана по этапу {X}
     для задачи @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай план по разработке кода согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `create-plan-dev`
   - `prompt`: "Перепроверь созданный файл {путь к файлу} на соответствие своим инструкциям.
     Верни список замечаний"
   Для уменьшения контекста каждому агенту давай задание по проверке только одного файла.
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `create-plan-dev`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Для каждого созданного или измененного файла вызови инструмент Task (switch_mode) с параметрами:
   - `subagent_type`: `markdownlint`
   - `prompt`: "Проверь и исправь форматирование файла: {путь_к_файлу}"

   Вызывай отдельного агента `markdownlint` для каждого файла.
```

### Шаг 4. Формирование технического плана по написанию тестов.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для создания плана тестов:
   - `subagent_type`: `create-plan-test`
   - `prompt`: "На основе бизнес-требований и сводного плана по этапу {X}
     для задачи @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай план по написанию тестов согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки."
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `create-plan-test`
   - `prompt`: "Перепроверь созданный файл {путь к файлу} на соответствие своим инструкциям.
     Верни список замечаний"
   Для уменьшения контекста каждому агенту давай задание по проверке только одного файла.
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `create-plan-test`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Для каждого созданного или измененного файла вызови инструмент Task (switch_mode) с параметрами:
   - `subagent_type`: `markdownlint`
   - `prompt`: "Проверь и исправь форматирование файла: {путь_к_файлу}"

   Вызывай отдельного агента `markdownlint` для каждого файла.
```

### Шаг 5. Разработка программного кода

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для разработки кода:
   - `subagent_type`: `implementation`
   - `prompt`: "Разработай код по этапу реализации {X} из файла
     @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Task.md согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `implementation`
   - `prompt`: "Перепроверь этап {X} из @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Task.md.
     Верни список замечаний для каждого файла"
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `implementation`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Вызови Task tool (switch_mode) для автоматического исправления кода и стиля:
   - `subagent_type`: `code-auto-fix`
   - `prompt`: "Исправь код и стиль"
5. Вызови Task tool (switch_mode) для исправления ошибок типов:
   - `subagent_type`: `phpstan`
   - `prompt`: "Проверь и исправь ошибки типов"
   Если агент вернул сообщение об ошибках, перезапусти подзадачу (не более 2-х раз).
6. Вызови Task tool (switch_mode) для рефакторинга:
   - `subagent_type`: `rector`
   - `prompt`: "Проверь и исправь код"
7. Вызови Task tool (switch_mode) для проверки стиля кода:
   - `subagent_type`: `phpcs`
   - `prompt`: "Проверь и исправь стиль кода"
   Если агент вернул сообщение об ошибках, перезапусти подзадачу (не более 2-х раз).
```

Проводим ревью, вносим правки самостоятельно или даем команду на исправление агенту.
Делаем коммит самостоятельно или даем команду: `сделай коммит`.

### Шаг 6. Написание тестов

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для написания тестов:
   - `subagent_type`: `testing`
   - `prompt`: "Напиши тесты для этапа реализации {X} из файла
     @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER}/Task.md согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `testing`
   - `prompt`: "Перепроверь созданный файл {путь к файлу} на соответствие своим инструкциям.
     Верни список замечаний"
   Для уменьшения контекста каждому агенту давай задание по проверке только одного файла.
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `testing`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Вызови Task tool (switch_mode) для автоматического исправления кода и стиля:
   - `subagent_type`: `code-auto-fix`
   - `prompt`: "Исправь код и стиль"
5. Вызови Task tool (switch_mode) для исправления ошибок типов:
   - `subagent_type`: `phpstan`
   - `prompt`: "Проверь и исправь ошибки типов"
   Если агент вернул сообщение об ошибках, перезапусти подзадачу (не более 2-х раз).
6. Вызови Task tool (switch_mode) для рефакторинга:
   - `subagent_type`: `rector`
   - `prompt`: "Проверь и исправь код"
7. Вызови Task tool (switch_mode) для проверки стиля кода:
   - `subagent_type`: `phpcs`
   - `prompt`: "Проверь и исправь стиль кода"
   Если агент вернул сообщение об ошибках, перезапусти подзадачу (не более 2-х раз).
8. Вызови Task tool (switch_mode) для повторного запуска PHPUnit:
   - `subagent_type`: `testing`
   - `prompt`: "Запусти PHPUnit тесты и проверь результаты"
9. В файле Task.md сделай пометку у соответствующего этапа реализации, что он выполнен (✅ Этап завершён).
```

Проводим ревью, вносим правки самостоятельно или даем команду на исправление агенту.
Делаем коммит самостоятельно или даем команду: `сделай коммит`.

### Шаг 7. Создание технической документации.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для создания технической документации:
   - `subagent_type`: `tech-doc`
   - `prompt`: "На основе бизнес-требований и плана по разработке кода и тестов
     в папке @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай техническую документацию согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `tech-doc`
   - `prompt`: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям.
     Верни список замечаний для каждого файла"
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `tech-doc`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Для каждого созданного или измененного файла вызови инструмент Task (switch_mode) с параметрами:
   - `subagent_type`: `markdownlint`
   - `prompt`: "Проверь и исправь форматирование файла: {путь_к_файлу}"

   Вызывай отдельного агента `markdownlint` для каждого файла.
```

### Шаг 8. Создание архитектурной документации.

Создаем новый контекст в режиме "orchestrator" и пишем следующую команду:

```markdown
1. Вызови Task tool (switch_mode) для создания архитектурной документации:
   - `subagent_type`: `arch-doc`
   - `prompt`: "На основе бизнес-требований и плана по разработке кода и тестов
     в папке @/Doc/Issue/{YYYY}/{MM}/{ISSUE_FOLDER} создай архитектурную документацию согласно инструкциям.
     Верни список созданных или измененных файлов для последующей проверки"
2. По окончанию работы агента вызови Task tool (switch_mode) для перепроверки:
   - `subagent_type`: `arch-doc`
   - `prompt`: "Перепроверь созданные файлы {список файлов} на соответствие своим инструкциям.
     Верни список замечаний для каждого файла"
3. Если найдены замечания, для каждого файла вызови Task tool (switch_mode):
   - `subagent_type`: `arch-doc`
   - `prompt`: "Внеси правки в файл {путь к файлу} согласно замечаниям: {список замечаний}"
   Для уменьшения контекста каждому агенту давай задание по изменению только одного файла.
4. Для каждого созданного или измененного md-файла вызови инструмент Task (switch_mode) с параметрами:
   - `subagent_type`: `markdownlint`
   - `prompt`: "Проверь и исправь форматирование файла: {путь_к_файлу}"

   Вызывай отдельного агента `markdownlint` для каждого файла.
```
