# Спецификация: Базовая конвертация валют (TZ1-101)

## Описание проблемы/потребности

Пользователи не могут конвертировать валюты в системе, что снижает удобство работы с товарами из разных стран и 
негативно влияет на конверсию продаж.

**Что меняется**: Добавляется новый функционал конвертации валют с получением актуальных курсов из внешнего API.

## Функциональные требования

### FR-1: Конвертация суммы

Система должна конвертировать денежную сумму из одной валюты в другую на основе актуального курса.

**Входные данные**:

- Исходная сумма (decimal, > 0)
- Код исходной валюты (ISO 4217, например USD)
- Код целевой валюты (ISO 4217, например EUR)

**Выходные данные**:

- Конвертированная сумма (decimal, округленная до 2 знаков)
- Курс конвертации
- Дата и время получения курса

### FR-2: Получение курсов валют

Система должна получать актуальные курсы валют из внешнего API (exchangerate-api.com).

**Поддерживаемые валюты** (MVP):

- USD (Доллар США)
- EUR (Евро)
- RUB (Российский рубль)
- CNY (Китайский юань)
- GBP (Британский фунт)
- JPY (Японская йена)

### FR-3: Валидация данных

Система должна валидировать входные данные:

- Сумма больше 0
- Коды валют существуют в списке поддерживаемых
- Исходная и целевая валюты различны

**Сообщения об ошибках**:

- "Сумма должна быть положительным числом"
- "Валюта {CODE} не поддерживается"
- "Исходная и целевая валюты должны различаться"

### FR-4: Обработка ошибок внешнего API

Система должна корректно обрабатывать ошибки внешнего API:

- Таймаут соединения (> 5 секунд)
- Недоступность сервиса (HTTP 500, 503)
- Недействительный API ключ (HTTP 401)
- Превышение лимита запросов (HTTP 429)

## Нефункциональные требования

### NFR-1: Производительность

- Время ответа на запрос конвертации: < 200 мс (при доступности внешнего API)
- Поддержка до 100 одновременных запросов (MVP)

### NFR-2: Безопасность

- API ключ провайдера курсов хранится в переменных окружения
- Все входные данные валидируются на уровне Application
- Rate limiting: максимум 60 запросов в минуту на пользователя

### NFR-3: Надежность

- При недоступности внешнего API возвращается понятная ошибка
- Все операции логируются (уровень INFO для успешных, ERROR для ошибок)
- Retry механизм: 3 попытки с экспоненциальным backoff (1s, 2s, 4s)

### NFR-4: Usability

- Коды валют принимаются в любом регистре (USD, usd, UsD)
- Результат конвертации округляется до 2 знаков после запятой
- В ответе указывается дата и время актуальности курса

## Модель предметной области

### Entity

**CurrencyConversion** (Агрегат)

- `id`: UUID - уникальный идентификатор операции
- `sourceAmount`: Money - исходная сумма
- `targetAmount`: Money - результат конвертации
- `exchangeRate`: ExchangeRate - использованный курс
- `convertedAt`: DateTime - время конвертации

### ValueObject

**Money**

- `amount`: Decimal - сумма
- `currency`: CurrencyCode - код валюты

**CurrencyCode**

- `code`: String - ISO 4217 код (USD, EUR, ...)
- Валидация: код должен быть в списке поддерживаемых

**ExchangeRate**

- `fromCurrency`: CurrencyCode - исходная валюта
- `toCurrency`: CurrencyCode - целевая валюта
- `rate`: Decimal - курс конвертации
- `fetchedAt`: DateTime - время получения курса

### Repository интерфейсы

**ExchangeRateProviderInterface** (Domain)

- `getRate(CurrencyCode $from, CurrencyCode $to): ExchangeRate`

### Исключения (Domain)

- `UnsupportedCurrencyException` - валюта не поддерживается
- `SameCurrencyException` - исходная и целевая валюты совпадают
- `InvalidAmountException` - некорректная сумма
- `ExchangeRateUnavailableException` - курс недоступен

## Зависимости

### Внутренние модули

- **Core**: Использование базовых исключений и логирования

### Внешние системы

- **exchangerate-api.com**: Провайдер курсов валют
  - Endpoint: `https://v6.exchangerate-api.com/v6/{API_KEY}/pair/{FROM}/{TO}`
  - Документация: <https://www.exchangerate-api.com/docs>

### Инфраструктура

- HTTP клиент для запросов к внешнему API
- Логирование (Monolog)
- Переменные окружения для хранения API ключа

## Сценарии использования

### UC-1: Успешная конвертация

**Действующее лицо**: Пользователь

**Предусловия**: Система работает, внешний API доступен

**Основной поток**:

1. Пользователь отправляет запрос на конвертацию:
   - Сумма: 100
   - Исходная валюта: USD
   - Целевая валюта: EUR
2. Система валидирует входные данные
3. Система запрашивает курс USD/EUR из внешнего API
4. Система получает курс: 1 USD = 0.92 EUR
5. Система выполняет конвертацию: 100 * 0.92 = 92.00 EUR
6. Система возвращает результат:

   ```json
   {
     "sourceAmount": {"amount": 100.00, "currency": "USD"},
     "targetAmount": {"amount": 92.00, "currency": "EUR"},
     "exchangeRate": {"rate": 0.92, "fetchedAt": "2026-02-04T10:30:00Z"}
   }
   ```

**Ожидаемый результат**: Пользователь получает конвертированную сумму

### UC-2: Ошибка валидации

**Действующее лицо**: Пользователь

**Предусловия**: Система работает

**Основной поток**:

1. Пользователь отправляет запрос с некорректными данными:
   - Сумма: -50
   - Исходная валюта: USD
   - Целевая валюта: EUR
2. Система валидирует входные данные
3. Система обнаруживает ошибку: сумма отрицательная
4. Система возвращает ошибку HTTP 400:

   ```json
   {
     "error": "InvalidAmount",
     "message": "Сумма должна быть положительным числом"
   }
   ```

**Ожидаемый результат**: Пользователь получает понятное сообщение об ошибке

### UC-3: Недоступность внешнего API

**Действующее лицо**: Пользователь

**Предусловия**: Внешний API недоступен

**Основной поток**:

1. Пользователь отправляет корректный запрос на конвертацию
2. Система валидирует входные данные
3. Система запрашивает курс из внешнего API
4. Внешний API не отвечает (таймаут) или возвращает ошибку
5. Система делает 3 повторные попытки с задержками 1s, 2s, 4s
6. Все попытки неуспешны
7. Система логирует ошибку
8. Система возвращает ошибку HTTP 503:

   ```json
   {
     "error": "ExchangeRateUnavailable",
     "message": "Курсы валют временно недоступны. Попробуйте позже."
   }
   ```

**Ожидаемый результат**: Пользователь получает понятное сообщение и может повторить попытку позже

## Риски

1. **Лимиты внешнего API**: Бесплатный план exchangerate-api.com - 1500 запросов/месяц
   - Митигация: На этапе 2 добавим кеширование
2. **Задержки при запросах**: Внешний API может отвечать медленно
   - Митигация: Установлен таймаут 5 секунд
3. **Изменение формата ответа API**: Провайдер может изменить структуру ответа
   - Митигация: Версионирование API провайдера, мониторинг ошибок

## Критерии приемки

- [ ] Система конвертирует валюты корректно для всех поддерживаемых пар
- [ ] Валидация входных данных работает согласно требованиям
- [ ] Обработка ошибок внешнего API реализована (retry, таймауты)
- [ ] Время ответа < 200 мс при доступности API
- [ ] Все операции логируются
- [ ] Unit тесты покрывают Domain и Application слои (>80%)
- [ ] Integration тесты проверяют работу с внешним API (mock)
- [ ] Документация API создана (OpenAPI спецификация)

## Не входит в реализацию

На данном этапе НЕ реализуется:

- Кеширование курсов валют (будет в Этапе 2)
- История конвертаций пользователя (будет в Этапе 3)
- Поддержка криптовалют
- Конвертация по историческим курсам
- Bulk конвертация (массовая обработка)
- WebSocket для real-time обновления курсов
